import{A as g,B as te,C as j,D as ts,E as Zo,F as Kt,G as Q,H as De,I as qn,J as ns,K as ea,L as wt,M as zt,N as ta,O as na,P as ia,Q as Ve,R as N,a as f,b as vt,c as $n,d as jo,e as Bo,f as $,g as Zi,h as Vo,i as $o,j as Ho,k as es,l as Go,m as Se,n as qo,o as Ko,p as Hn,q as O,r as zo,s as Yo,t as fe,u as Be,v as Gn,w as qt,x as Qo,y as Xo,z as Jo}from"./chunk-F77D7DUD.js";import{c as Ji,d as No,f as jn,i as Bn,j as xo,k as Ie,l as Vn,t as Do,u as Oo,v as Mo,w as Fo,x as Lo,y as Wo,z as Uo}from"./chunk-OIFSN6AI.js";import"./chunk-NKUATUXO.js";import{$ as Co,A as F,Ba as _t,E as We,G as mo,Gc as Ao,Hc as Ro,I as yo,Ia as q,Ic as Po,Lb as x,Lc as Xi,Ma as je,Mb as D,N as Ki,O as dt,P as zi,Pa as gt,Qa as de,R as vo,T as L,U as Yi,Ua as Ce,Ub as Gt,Wa as re,Z as wo,_ as Eo,b as Le,bb as Te,ca as V,cb as W,da as ue,db as Y,e as po,ea as se,eb as Io,fa as C,ga as he,h as On,ha as Ht,i as _o,ia as ft,ib as mt,ic as Ln,ja as pt,l as Vt,lb as xe,m as Mn,ma as To,mb as be,n as B,nc as Wn,o as z,pc as Un,q as M,qc as So,ra as Qi,sa as bo,sc as ko,wa as Ue,x as $t,xb as U,y as go,yb as Fn,zb as yt}from"./chunk-ZL7LBTKX.js";import{a as Gi,b as qi,h as Ee}from"./chunk-2HP4JIPC.js";var eu="firebase",tu="11.10.0";Ve(eu,tu,"app");function Oe(n){n===void 0&&(n=he(To));let e=n.get(Qi);return t=>new Le(i=>{let s=e.add(),r=!1;function o(){r||(s(),r=!0)}let a=t.subscribe({next:l=>{i.next(l),o()},complete:()=>{i.complete(),o()},error:l=>{i.error(l),o()}});return a.add(()=>{i.unsubscribe(),o()}),a})}var $e=new Eo("ANGULARFIRE2_VERSION");var sa=(n,e)=>{let t=e?[e]:ia(),i=[];return t.forEach(s=>{s.container.getProvider(n).instances.forEach(o=>{i.includes(o)||i.push(o)})}),i},is=(function(n){return n[n.SILENT=0]="SILENT",n[n.WARN=1]="WARN",n[n.VERBOSE=2]="VERBOSE",n})(is||{}),mp=Gt()&&typeof Zone<"u"?is.WARN:is.SILENT;var Kn=class{zone;delegate;constructor(e,t=_o){this.zone=e,this.delegate=t}now(){return this.delegate.now()}schedule(e,t,i){let s=this.zone,r=function(o){s?s.runGuarded(()=>{e.apply(this,[o])}):e.apply(this,[o])};return this.delegate.schedule(r,t,i)}},Yt=(()=>{class n{outsideAngular;insideAngular;constructor(){let t=he(re);this.outsideAngular=t.runOutsideAngular(()=>new Kn(typeof Zone>"u"?void 0:Zone.current)),this.insideAngular=t.run(()=>new Kn(typeof Zone>"u"?void 0:Zone.current,On))}static \u0275fac=function(i){return new(i||n)};static \u0275prov=V({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var nu="firebase",iu="11.10.0";N.registerVersion(nu,iu,"app-compat");var su=["ngOnDestroy"],aa=(n,e,t,i={})=>new Proxy(n,{get:(s,r)=>t.runOutsideAngular(()=>{if(n[r])return i?.spy?.get&&i.spy.get(r,n[r]),n[r];if(su.indexOf(r)>-1)return()=>{};let o=e.toPromise().then(a=>{let l=a?.[r];return typeof l=="function"?l.bind(a):l?.then?l.then(c=>t.run(()=>c)):t.run(()=>l)});return new Proxy(()=>{},{get:(a,l)=>o[l],apply:(a,l,c)=>o.then(u=>{let h=u?.(...c);return i?.spy?.apply&&i.spy.apply(r,c,h),h})})})});var zn=class{constructor(e){return e}},Et=new se("angularfire2.app.options"),Ct=new se("angularfire2.app.name");function Qt(n,e,t){let i=typeof t=="string"&&t||"[DEFAULT]",s=typeof t=="object"&&t||{};s.name=s.name||i;let o=N.apps.filter(a=>a&&a.name===s.name)[0]||e.runOutsideAngular(()=>N.initializeApp(n,s));try{if(JSON.stringify(n)!==JSON.stringify(o.options)){let a=!!module.hot;ru("error",`${o.name} Firebase App already initialized with different options${a?", you may need to reload as Firebase is not HMR aware.":"."}`)}}catch{}return new zn(o)}var ru=(n,...e)=>{Gt()&&typeof console<"u"&&console[n](...e)},ou={provide:zn,useFactory:Qt,deps:[Et,re,[new bo,Ct]]},la=(()=>{class n{static initializeApp(t,i){return{ngModule:n,providers:[{provide:Et,useValue:t},{provide:Ct,useValue:i}]}}constructor(t){N.registerVersion("angularfire",$e.full,"core"),N.registerVersion("angularfire",$e.full,"app-compat"),N.registerVersion("angular",Co.full,t.toString())}static \u0275fac=function(i){return new(i||n)(C(_t))};static \u0275mod=de({type:n});static \u0275inj=ue({providers:[ou]})}return n})();function Yn(n,e,t,i,s){let[,r,o]=globalThis.\u0275AngularfireInstanceCache.find(a=>a[0]===n)||[];if(r)return au(s,o)||(oa("error",`${e} was already initialized on the ${t} Firebase App with different settings.${lu?" You may need to reload as Firebase is not HMR aware.":""}`),oa("warn",{is:s,was:o})),r;{let a=i();return globalThis.\u0275AngularfireInstanceCache.push([n,a,s]),a}}function au(n,e){try{return n.toString()===e.toString()}catch{return n===e}}var lu=typeof module<"u"&&!!module.hot,oa=(n,...e)=>{Gt()&&typeof console<"u"&&console[n](...e)};globalThis.\u0275AngularfireInstanceCache||=[];var hu=new Map,du={activated:!1,tokenObservers:[]},fu={initialized:!1,enabled:!1};function ye(n){return hu.get(n)||Object.assign({},du)}function da(){return fu}var pu="https://content-firebaseappcheck.googleapis.com/v1";var _u="exchangeDebugToken",ca={OFFSET_DURATION:300*1e3,RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:960*1e3},Op=1440*60*1e3;var os=class{constructor(e,t,i,s,r){if(this.operation=e,this.retryPolicy=t,this.getWaitDuration=i,this.lowerBound=s,this.upperBound=r,this.pending=null,this.nextErrorWaitInterval=s,s>r)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}process(e){return Ee(this,null,function*(){this.stop();try{this.pending=new $,this.pending.promise.catch(t=>{}),yield gu(this.getNextRun(e)),this.pending.resolve(),yield this.pending.promise,this.pending=new $,this.pending.promise.catch(t=>{}),yield this.operation(),this.pending.resolve(),yield this.pending.promise,this.process(!0).catch(()=>{})}catch(t){this.retryPolicy(t)?this.process(!1).catch(()=>{}):this.stop()}})}getNextRun(e){if(e)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{let t=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),t}}};function gu(n){return new Promise(e=>{setTimeout(e,n)})}var mu={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.","initial-throttle":"{$httpStatus} error. Attempts allowed again after {$time}",throttled:"Requests throttled due to previous {$httpStatus} error. Attempts allowed again after {$time}"},He=new Ko("appCheck","AppCheck",mu);function fa(n){if(!ye(n).activated)throw He.create("use-before-activation",{appName:n.name})}function pa(i,s){return Ee(this,arguments,function*({url:n,body:e},t){let r={"Content-Type":"application/json"},o=t.getImmediate({optional:!0});if(o){let p=yield o.getHeartbeatsHeader();p&&(r["X-Firebase-Client"]=p)}let a={method:"POST",body:JSON.stringify(e),headers:r},l;try{l=yield fetch(n,a)}catch(p){throw He.create("fetch-network-error",{originalErrorMessage:p?.message})}if(l.status!==200)throw He.create("fetch-status-error",{httpStatus:l.status});let c;try{c=yield l.json()}catch(p){throw He.create("fetch-parse-error",{originalErrorMessage:p?.message})}let u=c.ttl.match(/^([\d.]+)(s)$/);if(!u||!u[2]||isNaN(Number(u[1])))throw He.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${c.ttl}`});let h=Number(u[1])*1e3,d=Date.now();return{token:c.token,expireTimeMillis:d+h,issuedAtTimeMillis:d}})}function _a(n,e){let{projectId:t,appId:i,apiKey:s}=n.options;return{url:`${pu}/projects/${t}/apps/${i}:${_u}?key=${s}`,body:{debug_token:e}}}var yu="firebase-app-check-database",vu=1,as="firebase-app-check-store";var Qn=null;function wu(){return Qn||(Qn=new Promise((n,e)=>{try{let t=indexedDB.open(yu,vu);t.onsuccess=i=>{n(i.target.result)},t.onerror=i=>{var s;e(He.create("storage-open",{originalErrorMessage:(s=i.target.error)===null||s===void 0?void 0:s.message}))},t.onupgradeneeded=i=>{let s=i.target.result;switch(i.oldVersion){case 0:s.createObjectStore(as,{keyPath:"compositeKey"})}}}catch(t){e(He.create("storage-open",{originalErrorMessage:t?.message}))}}),Qn)}function Eu(n,e){return Cu(Tu(n),e)}function Cu(n,e){return Ee(this,null,function*(){let i=(yield wu()).transaction(as,"readwrite"),r=i.objectStore(as).put({compositeKey:n,value:e});return new Promise((o,a)=>{r.onsuccess=l=>{o()},i.onerror=l=>{var c;a(He.create("storage-set",{originalErrorMessage:(c=l.target.error)===null||c===void 0?void 0:c.message}))}})})}function Tu(n){return`${n.options.appId}-${n.name}`}var Xt=new wt("@firebase/app-check");function ss(n,e){return qo()?Eu(n,e).catch(t=>{Xt.warn(`Failed to write token to IndexedDB. Error: ${t}`)}):Promise.resolve()}function ga(){return da().enabled}function ma(){return Ee(this,null,function*(){let n=da();if(n.enabled&&n.token)return n.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)})}var bu={error:"UNKNOWN_ERROR"};function Iu(n){return $n.encodeString(JSON.stringify(n),!1)}function ls(n,e=!1,t=!1){return Ee(this,null,function*(){let i=n.app;fa(i);let s=ye(i),r=s.token,o;if(r&&!Jt(r)&&(s.token=void 0,r=void 0),!r){let c=yield s.cachedTokenPromise;c&&(Jt(c)?r=c:yield ss(i,void 0))}if(!e&&r&&Jt(r))return{token:r.token};let a=!1;if(ga())try{s.exchangeTokenPromise||(s.exchangeTokenPromise=pa(_a(i,yield ma()),n.heartbeatServiceProvider).finally(()=>{s.exchangeTokenPromise=void 0}),a=!0);let c=yield s.exchangeTokenPromise;return yield ss(i,c),s.token=c,{token:c.token}}catch(c){return c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?Xt.warn(c.message):t&&Xt.error(c),rs(c)}try{s.exchangeTokenPromise||(s.exchangeTokenPromise=s.provider.getToken().finally(()=>{s.exchangeTokenPromise=void 0}),a=!0),r=yield ye(i).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?Xt.warn(c.message):t&&Xt.error(c),o=c}let l;return r?o?Jt(r)?l={token:r.token,internalError:o}:l=rs(o):(l={token:r.token},s.token=r,yield ss(i,r)):l=rs(o),a&&Ru(i,l),l})}function Su(n){return Ee(this,null,function*(){let e=n.app;fa(e);let{provider:t}=ye(e);if(ga()){let i=yield ma(),{token:s}=yield pa(_a(e,i),n.heartbeatServiceProvider);return{token:s}}else{let{token:i}=yield t.getToken();return{token:i}}})}function ku(n,e,t,i){let{app:s}=n,r=ye(s),o={next:t,error:i,type:e};if(r.tokenObservers=[...r.tokenObservers,o],r.token&&Jt(r.token)){let a=r.token;Promise.resolve().then(()=>{t({token:a.token}),ua(n)}).catch(()=>{})}r.cachedTokenPromise.then(()=>ua(n))}function ya(n,e){let t=ye(n),i=t.tokenObservers.filter(s=>s.next!==e);i.length===0&&t.tokenRefresher&&t.tokenRefresher.isRunning()&&t.tokenRefresher.stop(),t.tokenObservers=i}function ua(n){let{app:e}=n,t=ye(e),i=t.tokenRefresher;i||(i=Au(n),t.tokenRefresher=i),!i.isRunning()&&t.isTokenAutoRefreshEnabled&&i.start()}function Au(n){let{app:e}=n;return new os(()=>Ee(null,null,function*(){let t=ye(e),i;if(t.token?i=yield ls(n,!0):i=yield ls(n),i.error)throw i.error;if(i.internalError)throw i.internalError}),()=>!0,()=>{let t=ye(e);if(t.token){let i=t.token.issuedAtTimeMillis+(t.token.expireTimeMillis-t.token.issuedAtTimeMillis)*.5+3e5,s=t.token.expireTimeMillis-300*1e3;return i=Math.min(i,s),Math.max(0,i-Date.now())}else return 0},ca.RETRIAL_MIN_WAIT,ca.RETRIAL_MAX_WAIT)}function Ru(n,e){let t=ye(n).tokenObservers;for(let i of t)try{i.type==="EXTERNAL"&&e.error!=null?i.error(e.error):i.next(e)}catch{}}function Jt(n){return n.expireTimeMillis-Date.now()>0}function rs(n){return{token:Iu(bu),error:n}}var cs=class{constructor(e,t){this.app=e,this.heartbeatServiceProvider=t}_delete(){let{tokenObservers:e}=ye(this.app);for(let t of e)ya(this.app,t.next);return Promise.resolve()}};function Pu(n,e){return new cs(n,e)}function Nu(n){return{getToken:e=>ls(n,e),getLimitedUseToken:()=>Su(n),addTokenListener:e=>ku(n,"INTERNAL",e),removeTokenListener:e=>ya(n.app,e)}}var xu="@firebase/app-check",Du="0.10.1";var Ou="app-check",ha="app-check-internal";function Mu(){zt(new De(Ou,n=>{let e=n.getProvider("app").getImmediate(),t=n.getProvider("heartbeat");return Pu(e,t)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((n,e,t)=>{n.getProvider(ha).initialize()})),zt(new De(ha,n=>{let e=n.getProvider("app-check").getImmediate();return Nu(e)},"PUBLIC").setInstantiationMode("EXPLICIT")),Ve(xu,Du)}Mu();var Fu="app-check";var Tt=class{constructor(){return sa(Fu)}};var Lu=["localhost","0.0.0.0","127.0.0.1"],Yp=typeof window<"u"&&Lu.includes(window.location.hostname);var us=new se("angularfire2.auth.use-emulator"),hs=new se("angularfire2.auth.settings"),ds=new se("angularfire2.auth.tenant-id"),fs=new se("angularfire2.auth.langugage-code"),ps=new se("angularfire2.auth.use-device-language"),_s=new se("angularfire.auth.persistence"),gs=(n,e,t,i,s,r,o,a)=>Yn(`${n.name}.auth`,"AngularFireAuth",n.name,()=>{let l=e.runOutsideAngular(()=>n.auth());if(t&&l.useEmulator(...t),i&&(l.tenantId=i),l.languageCode=s,r&&l.useDeviceLanguage(),o)for(let[c,u]of Object.entries(o))l.settings[c]=u;return a&&l.setPersistence(a),l},[t,i,s,r,o,a]),Zt=(()=>{class n{injector=he(Ht);authState;idToken;user;idTokenResult;credential;constructor(t,i,s,r,o,a,l,c,u,h,d,p){let _=new po,E=z(void 0).pipe(Vt(o.outsideAngular),L(()=>r.runOutsideAngular(()=>import("./chunk-3H7L2WQ3.js"))),M(()=>Qt(t,r,i)),M(I=>gs(I,r,a,c,u,h,l,d)),zi({bufferSize:1,refCount:!1}));if(ko(s))this.authState=this.user=this.idToken=this.idTokenResult=this.credential=z(null);else{E.pipe(yo()).subscribe();let I=E.pipe(L(A=>A.getRedirectResult().then(me=>me,()=>null)),Oe(this.injector),zi({bufferSize:1,refCount:!1})),ne=E.pipe(L(A=>new Le(me=>({unsubscribe:r.runOutsideAngular(()=>A.onAuthStateChanged(nt=>me.next(nt),nt=>me.error(nt),()=>me.complete()))})))),ie=E.pipe(L(A=>new Le(me=>({unsubscribe:r.runOutsideAngular(()=>A.onIdTokenChanged(nt=>me.next(nt),nt=>me.error(nt),()=>me.complete()))}))));this.authState=I.pipe(Yi(ne),Mn(o.outsideAngular),Vt(o.insideAngular)),this.user=I.pipe(Yi(ie),Mn(o.outsideAngular),Vt(o.insideAngular)),this.idToken=this.user.pipe(L(A=>A?B(A.getIdToken()):z(null))),this.idTokenResult=this.user.pipe(L(A=>A?B(A.getIdTokenResult()):z(null))),this.credential=$t(I,_,this.authState.pipe(go(A=>!A))).pipe(M(A=>A?.user?A:null),Mn(o.outsideAngular),Vt(o.insideAngular))}return aa(this,E,r,{spy:{apply:(I,ne,ie)=>{(I.startsWith("signIn")||I.startsWith("createUser"))&&ie.then(A=>_.next(A))}}})}static \u0275fac=function(i){return new(i||n)(C(Et),C(Ct,8),C(_t),C(re),C(Yt),C(us,8),C(hs,8),C(ds,8),C(fs,8),C(ps,8),C(_s,8),C(Tt,8))};static \u0275prov=V({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),wa=(()=>{class n{constructor(){N.registerVersion("angularfire",$e.full,"auth-compat")}static \u0275fac=function(i){return new(i||n)};static \u0275mod=de({type:n});static \u0275inj=ue({providers:[Zt]})}return n})();var Ca="@firebase/database",Ta="1.0.20";var Ar="";function Rr(n){Ar=n}var bs=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),O(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:Hn(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var Is=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return fe(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var el=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new bs(e)}}catch{}return new Is},st=el("localStorage"),Ss=el("sessionStorage");var kt=new wt("@firebase/database"),tl=(function(){let n=1;return function(){return n++}})(),nl=function(n){let e=Zo(n),t=new Jo;t.update(e);let i=t.digest();return $n.encodeByteArray(i)},bn=function(...n){let e="";for(let t=0;t<n.length;t++){let i=n[t];Array.isArray(i)||i&&typeof i=="object"&&typeof i.length=="number"?e+=bn.apply(null,i):typeof i=="object"?e+=O(i):e+=i,e+=" "}return e},rt=null,ba=!0,il=function(n,e){f(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(kt.logLevel=ea.VERBOSE,rt=kt.log.bind(kt),e&&Ss.set("logging_enabled",!0)):typeof n=="function"?rt=n:(rt=null,Ss.remove("logging_enabled"))},H=function(...n){if(ba===!0&&(ba=!1,rt===null&&Ss.get("logging_enabled")===!0&&il(!0)),rt){let e=bn.apply(null,n);rt(e)}},In=function(n){return function(...e){H(n,...e)}},ks=function(...n){let e="FIREBASE INTERNAL ERROR: "+bn(...n);kt.error(e)},Re=function(...n){let e=`FIREBASE FATAL ERROR: ${bn(...n)}`;throw kt.error(e),new Error(e)},K=function(...n){let e="FIREBASE WARNING: "+bn(...n);kt.warn(e)},Wu=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&K("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},bi=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Uu=function(n){if(Se()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},ze="[MIN_NAME]",Me="[MAX_NAME]",at=function(n,e){if(n===e)return 0;if(n===ze||e===Me)return-1;if(e===ze||n===Me)return 1;{let t=Ia(n),i=Ia(e);return t!==null?i!==null?t-i===0?n.length-e.length:t-i:-1:i!==null?1:n<e?-1:1}},ju=function(n,e){return n===e?0:n<e?-1:1},en=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+O(e))},Pr=function(n){if(typeof n!="object"||n===null)return O(n);let e=[];for(let i in n)e.push(i);e.sort();let t="{";for(let i=0;i<e.length;i++)i!==0&&(t+=","),t+=O(e[i]),t+=":",t+=Pr(n[e[i]]);return t+="}",t},sl=function(n,e){let t=n.length;if(t<=e)return[n];let i=[];for(let s=0;s<t;s+=e)s+e>t?i.push(n.substring(s,t)):i.push(n.substring(s,s+e));return i};function G(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var rl=function(n){f(!bi(n),"Invalid JSON number");let e=11,t=52,i=(1<<e-1)-1,s,r,o,a,l;n===0?(r=0,o=0,s=1/n===-1/0?1:0):(s=n<0,n=Math.abs(n),n>=Math.pow(2,1-i)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),i),r=a+i,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-i-t))));let c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(s?1:0),c.reverse();let u=c.join(""),h="";for(l=0;l<64;l+=8){let d=parseInt(u.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),h=h+d}return h.toLowerCase()},Bu=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Vu=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function $u(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let i=new Error(n+" at "+e._path.toString()+": "+t);return i.code=n.toUpperCase(),i}var Hu=new RegExp("^-?(0*)\\d{1,10}$"),Gu=-2147483648,qu=2147483647,Ia=function(n){if(Hu.test(n)){let e=Number(n);if(e>=Gu&&e<=qu)return e}return null},Ft=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw K("Exception was thrown by user callback.",t),e},Math.floor(0))}},Ku=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},rn=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var As=class{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,ta(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(i=>this.appCheck=i)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,i)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(i=>i.addTokenListener(e))}notifyForInvalidToken(){K(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}};var Rs=class{constructor(e,t,i){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=i,this.auth_=null,this.auth_=i.getImmediate({optional:!0}),this.auth_||i.onInit(s=>this.auth_=s)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(H("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,i)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',K(e)}},on=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Jn="5",ol="v",al="s",ll="r",cl="f",ul=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,hl="ls",dl="p",Ps="ac",fl="websocket",pl="long_polling";var Zn=class{constructor(e,t,i,s,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=i,this.webSocketOnly=s,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=st.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&st.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function zu(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function _l(n,e,t){f(typeof e=="string","typeof type must == string"),f(typeof t=="object","typeof params must == object");let i;if(e===fl)i=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===pl)i=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);zu(n)&&(t.ns=n.namespace);let s=[];return G(t,(r,o)=>{s.push(r+"="+o)}),i+s.join("&")}var Ns=class{constructor(){this.counters_={}}incrementCounter(e,t=1){fe(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Bo(this.counters_)}};var ms={},ys={};function Nr(n){let e=n.toString();return ms[e]||(ms[e]=new Ns),ms[e]}function Yu(n,e){let t=n.toString();return ys[t]||(ys[t]=e()),ys[t]}var xs=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let i=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let s=0;s<i.length;++s)i[s]&&Ft(()=>{this.onMessage_(i[s])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var Sa="start",Qu="close",Xu="pLPCommand",Ju="pRTLPCB",gl="id",ml="pw",yl="ser",Zu="cb",eh="seg",th="ts",nh="d",ih="dframe",vl=1870,wl=30,sh=vl-wl,rh=25e3,oh=3e4,un=class n{constructor(e,t,i,s,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=i,this.appCheckToken=s,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=In(e),this.stats_=Nr(t),this.urlFn=l=>(this.appCheckToken&&(l[Ps]=this.appCheckToken),_l(t,pl,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new xs(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(oh)),Uu(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Ds((...r)=>{let[o,a,l,c,u]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Sa)this.id=a,this.password=l;else if(o===Qu)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{let[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let i={};i[Sa]="t",i[yl]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(i[Zu]=this.scriptTagHolder.uniqueCallbackIdentifier),i[ol]=Jn,this.transportSessionId&&(i[al]=this.transportSessionId),this.lastSessionId&&(i[hl]=this.lastSessionId),this.applicationId&&(i[dl]=this.applicationId),this.appCheckToken&&(i[Ps]=this.appCheckToken),typeof location<"u"&&location.hostname&&ul.test(location.hostname)&&(i[ll]=cl);let s=this.urlFn(i);this.log_("Connecting via long-poll to "+s),this.scriptTagHolder.addTag(s,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Se()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Bu()&&!Vu()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=O(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let i=jo(t),s=sl(i,sh);for(let r=0;r<s.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,s.length,s[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Se())return;this.myDisconnFrame=document.createElement("iframe");let i={};i[ih]="t",i[gl]=e,i[ml]=t,this.myDisconnFrame.src=this.urlFn(i),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=O(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},Ds=class n{constructor(e,t,i,s){if(this.onDisconnect=i,this.urlFn=s,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Se())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=tl(),window[Xu+this.uniqueCallbackIdentifier]=e,window[Ju+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){H("frame writing exception"),a.stack&&H(a.stack),H(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||H("No IE domain setting required")}catch{let i=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+i+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[gl]=this.myID,e[ml]=this.myPW,e[yl]=this.currentSerial;let t=this.urlFn(e),i="",s=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+wl+i.length<=vl;){let o=this.pendingSegs.shift();i=i+"&"+eh+s+"="+o.seg+"&"+th+s+"="+o.ts+"&"+nh+s+"="+o.d,s++}return t=t+i,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,i){this.pendingSegs.push({seg:e,ts:t,d:i}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let i=()=>{this.outstandingRequests.delete(t),this.newRequest_()},s=setTimeout(i,Math.floor(rh)),r=()=>{clearTimeout(s),i()};this.addTag(e,r)}addTag(e,t){Se()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let i=this.myIFrame.doc.createElement("script");i.type="text/javascript",i.async=!0,i.src=e,i.onload=i.onreadystatechange=function(){let s=i.readyState;(!s||s==="loaded"||s==="complete")&&(i.onload=i.onreadystatechange=null,i.parentNode&&i.parentNode.removeChild(i),t())},i.onerror=()=>{H("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(i)}catch{}},Math.floor(1))}};var ah=16384,lh=45e3,ei=null;typeof MozWebSocket<"u"?ei=MozWebSocket:typeof WebSocket<"u"&&(ei=WebSocket);var It=(()=>{class n{constructor(t,i,s,r,o,a,l){this.connId=t,this.applicationId=s,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=In(this.connId),this.stats_=Nr(i),this.connURL=n.connectionURL_(i,a,l,r,s),this.nodeAdmin=i.nodeAdmin}static connectionURL_(t,i,s,r,o){let a={};return a[ol]=Jn,!Se()&&typeof location<"u"&&location.hostname&&ul.test(location.hostname)&&(a[ll]=cl),i&&(a[al]=i),s&&(a[hl]=s),r&&(a[Ps]=r),o&&(a[dl]=o),_l(t,fl,a)}open(t,i){this.onDisconnect=i,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,st.set("previous_websocket_failure",!0);try{let s;if(Se()){let r=this.nodeAdmin?"AdminNode":"Node";s={headers:{"User-Agent":`Firebase/${Jn}/${Ar}/${process.platform}/${r}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(s.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(s.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(s.proxy={origin:a})}this.mySock=new ei(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");let r=s.message||s.data;r&&this.log_(r),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");let r=s.message||s.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let i=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(i);s&&s.length>1&&parseFloat(s[1])<4.4&&(t=!0)}return!t&&ei!==null&&!n.forceDisallow_}static previouslyFailed(){return st.isInMemoryStorage||st.get("previous_websocket_failure")===!0}markConnectionHealthy(){st.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let i=this.frames.join("");this.frames=null;let s=Hn(i);this.onMessage(s)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(f(this.frames===null,"We already have a frame buffer"),t.length<=6){let i=Number(t);if(!isNaN(i))return this.handleNewFrameCount_(i),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let i=t.data;if(this.bytesReceived+=i.length,this.stats_.incrementCounter("bytes_received",i.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(i);else{let s=this.extractFrameCount_(i);s!==null&&this.appendFrame_(s)}}send(t){this.resetKeepAlive();let i=O(t);this.bytesSent+=i.length,this.stats_.incrementCounter("bytes_sent",i.length);let s=sl(i,ah);s.length>1&&this.sendString_(String(s.length));for(let r=0;r<s.length;r++)this.sendString_(s[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(lh))}sendString_(t){try{this.mySock.send(t)}catch(i){this.log_("Exception thrown from WebSocket.send():",i.message||i.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),El=(()=>{class n{static get ALL_TRANSPORTS(){return[un,It]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(t){this.initTransports_(t)}initTransports_(t){let i=It&&It.isAvailable(),s=i&&!It.previouslyFailed();if(t.webSocketOnly&&(i||K("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[It];else{let r=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),ch=6e4,uh=5e3,hh=10*1024,dh=100*1024,vs="t",ka="d",fh="s",Aa="r",ph="e",Ra="o",Pa="a",Na="n",xa="p",_h="h",Os=class{constructor(e,t,i,s,r,o,a,l,c,u){this.id=e,this.repoInfo_=t,this.applicationId_=i,this.appCheckToken_=s,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=In("c:"+this.id+":"),this.transportManager_=new El(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),i=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,i)},Math.floor(0));let s=e.healthyTimeout||0;s>0&&(this.healthyTimeout_=rn(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>dh?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>hh?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(s)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(vs in e){let t=e[vs];t===Pa?this.upgradeIfSecondaryHealthy_():t===Aa?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Ra&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=en("t",e),i=en("d",e);if(t==="c")this.onSecondaryControl_(i);else if(t==="d")this.pendingDataMessages.push(i);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:xa,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Pa,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Na,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=en("t",e),i=en("d",e);t==="c"?this.onControl_(i):t==="d"&&this.onDataMessage_(i)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=en(vs,e);if(ka in e){let i=e[ka];if(t===_h){let s=Object.assign({},i);this.repoInfo_.isUsingEmulator&&(s.h=this.repoInfo_.host),this.onHandshake_(s)}else if(t===Na){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let s=0;s<this.pendingDataMessages.length;++s)this.onDataMessage_(this.pendingDataMessages[s]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===fh?this.onConnectionShutdown_(i):t===Aa?this.onReset_(i):t===ph?ks("Server Error: "+i):t===Ra?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):ks("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,i=e.v,s=e.h;this.sessionId=e.s,this.repoInfo_.host=s,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Jn!==i&&K("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),i=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,i),rn(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(ch))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):rn(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(uh))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:xa,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(st.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var ti=class{put(e,t,i,s){}merge(e,t,i,s){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,i){}onDisconnectMerge(e,t,i){}onDisconnectCancel(e,t){}reportStats(e){}};var ni=class{constructor(e){this.allowedEvents_=e,this.listeners_={},f(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let i=[...this.listeners_[e]];for(let s=0;s<i.length;s++)i[s].callback.apply(i[s].context,t)}}on(e,t,i){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:i});let s=this.getInitialEvent(e);s&&t.apply(i,s)}off(e,t,i){this.validateEventType_(e);let s=this.listeners_[e]||[];for(let r=0;r<s.length;r++)if(s[r].callback===t&&(!i||i===s[r].context)){s.splice(r,1);return}}validateEventType_(e){f(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var ii=class n extends ni{static getInstance(){return new n}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!es()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return f(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Da=32,Oa=768,b=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let i=0;for(let s=0;s<this.pieces_.length;s++)this.pieces_[s].length>0&&(this.pieces_[i]=this.pieces_[s],i++);this.pieces_.length=i,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function T(){return new b("")}function y(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Ye(n){return n.pieces_.length-n.pieceNum_}function S(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new b(n.pieces_,e)}function xr(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function gh(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function hn(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Cl(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new b(e,0)}function R(n,e){let t=[];for(let i=n.pieceNum_;i<n.pieces_.length;i++)t.push(n.pieces_[i]);if(e instanceof b)for(let i=e.pieceNum_;i<e.pieces_.length;i++)t.push(e.pieces_[i]);else{let i=e.split("/");for(let s=0;s<i.length;s++)i[s].length>0&&t.push(i[s])}return new b(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function J(n,e){let t=y(n),i=y(e);if(t===null)return e;if(t===i)return J(S(n),S(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function mh(n,e){let t=hn(n,0),i=hn(e,0);for(let s=0;s<t.length&&s<i.length;s++){let r=at(t[s],i[s]);if(r!==0)return r}return t.length===i.length?0:t.length<i.length?-1:1}function Dr(n,e){if(Ye(n)!==Ye(e))return!1;for(let t=n.pieceNum_,i=e.pieceNum_;t<=n.pieces_.length;t++,i++)if(n.pieces_[t]!==e.pieces_[i])return!1;return!0}function pe(n,e){let t=n.pieceNum_,i=e.pieceNum_;if(Ye(n)>Ye(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[i])return!1;++t,++i}return!0}var Ms=class{constructor(e,t){this.errorPrefix_=t,this.parts_=hn(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let i=0;i<this.parts_.length;i++)this.byteLength_+=Kt(this.parts_[i]);Tl(this)}};function yh(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Kt(e),Tl(n)}function vh(n){let e=n.parts_.pop();n.byteLength_-=Kt(e),n.parts_.length>0&&(n.byteLength_-=1)}function Tl(n){if(n.byteLength_>Oa)throw new Error(n.errorPrefix_+"has a key path longer than "+Oa+" bytes ("+n.byteLength_+").");if(n.parts_.length>Da)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Da+") or object contains a cycle "+it(n))}function it(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var Fs=class n extends ni{static getInstance(){return new n}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let i=!document[e];i!==this.visible_&&(this.visible_=i,this.trigger("visible",i))},!1)}getInitialEvent(e){return f(e==="visible","Unknown event type: "+e),[this.visible_]}};var tn=1e3,wh=300*1e3,Ma=30*1e3,Eh=1.3,Ch=3e4,Th="server_kill",Fa=3,Or=(()=>{class n extends ti{constructor(t,i,s,r,o,a,l,c){if(super(),this.repoInfo_=t,this.applicationId_=i,this.onDataUpdate_=s,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=l,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=In("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=tn,this.maxReconnectDelay_=wh,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Se())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Fs.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&ii.getInstance().on("online",this.onOnline_,this)}sendRequest(t,i,s){let r=++this.requestNumber_,o={r,a:t,b:i};this.log_(O(o)),f(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),s&&(this.requestCBHash_[r]=s)}get(t){this.initConnection_();let i=new $,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:a=>{let l=a.d;a.s==="ok"?i.resolve(l):i.reject(l)}};this.outstandingGets_.push(r),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),i.promise}listen(t,i,s,r){this.initConnection_();let o=t._queryIdentifier,a=t._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),f(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let l={onComplete:r,hashFn:i,query:t,tag:s};this.listens.get(a).set(o,l),this.connected_&&this.sendListen_(l)}sendGet_(t){let i=this.outstandingGets_[t];this.sendRequest("g",i.request,s=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),i.onComplete&&i.onComplete(s)})}sendListen_(t){let i=t.query,s=i._path.toString(),r=i._queryIdentifier;this.log_("Listen on "+s+" for "+r);let o={p:s},a="q";t.tag&&(o.q=i._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(a,o,l=>{let c=l.d,u=l.s;n.warnOnListenWarnings_(c,i),(this.listens.get(s)&&this.listens.get(s).get(r))===t&&(this.log_("listen response",l),u!=="ok"&&this.removeListen_(s,r),t.onComplete&&t.onComplete(u,c))})}static warnOnListenWarnings_(t,i){if(t&&typeof t=="object"&&fe(t,"w")){let s=Be(t,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){let r='".indexOn": "'+i._queryParams.getIndex().toString()+'"',o=i._path.toString();K(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||Yo(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Ma)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,i=zo(t)?"auth":"gauth",s={cred:t};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(i,s,r=>{let o=r.s,a=r.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let i=t.s,s=t.d||"error";i==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(i,s)})}unlisten(t,i){let s=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+s+" "+r),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,r)&&this.connected_&&this.sendUnlisten_(s,r,t._queryObject,i)}sendUnlisten_(t,i,s,r){this.log_("Unlisten on "+t+" for "+i);let o={p:t},a="n";r&&(o.q=s,o.t=r),this.sendRequest(a,o)}onDisconnectPut(t,i,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,i,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:i,onComplete:s})}onDisconnectMerge(t,i,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,i,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:i,onComplete:s})}onDisconnectCancel(t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:i})}sendOnDisconnect_(t,i,s,r){let o={p:i,d:s};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,a=>{r&&setTimeout(()=>{r(a.s,a.d)},Math.floor(0))})}put(t,i,s,r){this.putInternal("p",t,i,s,r)}merge(t,i,s,r){this.putInternal("m",t,i,s,r)}putInternal(t,i,s,r,o){this.initConnection_();let a={p:i,d:s};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:t,request:a,onComplete:r}),this.outstandingPutCount_++;let l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+i)}sendPut_(t){let i=this.outstandingPuts_[t].action,s=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(i,s,o=>{this.log_(i+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){let i={c:t};this.log_("reportStats",i),this.sendRequest("s",i,s=>{if(s.s!=="ok"){let o=s.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+O(t));let i=t.r,s=this.requestCBHash_[i];s&&(delete this.requestCBHash_[i],s(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,i){this.log_("handleServerMessage",t,i),t==="d"?this.onDataUpdate_(i.p,i.d,!1,i.t):t==="m"?this.onDataUpdate_(i.p,i.d,!0,i.t):t==="c"?this.onListenRevoked_(i.p,i.q):t==="ac"?this.onAuthRevoked_(i.s,i.d):t==="apc"?this.onAppCheckRevoked_(i.s,i.d):t==="sd"?this.onSecurityDebugPacket_(i):ks("Unrecognized action received from server: "+O(t)+`
Are you using the latest client?`)}onReady_(t,i){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=i,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){f(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=tn,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=tn,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>Ch&&(this.reconnectDelay_=tn),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),i=Math.max(0,this.reconnectDelay_-t);i=Math.random()*i,this.log_("Trying to reconnect in "+i+"ms"),this.scheduleConnect_(i),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Eh)}this.onConnectStatus_(!1)}establishConnection_(){return Ee(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),i=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,a=!1,l=null,c=function(){l?l.close():(a=!0,s())},u=function(d){f(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(d)};this.realtime_={close:c,sendRequest:u};let h=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[d,p]=yield Promise.all([this.authTokenProvider_.getToken(h),this.appCheckTokenProvider_.getToken(h)]);a?H("getToken() completed but was canceled"):(H("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=p&&p.token,l=new Os(r,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,i,s,_=>{K(_+" ("+this.repoInfo_.toString()+")"),this.interrupt(Th)},o))}catch(d){this.log_("Failed to get token: "+d),a||(this.repoInfo_.nodeAdmin&&K(d),c())}}})}interrupt(t){H("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){H("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Gn(this.interruptReasons_)&&(this.reconnectDelay_=tn,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let i=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:i})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let i=this.outstandingPuts_[t];i&&"h"in i.request&&i.queued&&(i.onComplete&&i.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,i){let s;i?s=i.map(o=>Pr(o)).join("$"):s="default";let r=this.removeListen_(t,s);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,i){let s=new b(t).toString(),r;if(this.listens.has(s)){let o=this.listens.get(s);r=o.get(i),o.delete(i),o.size===0&&this.listens.delete(s)}else r=void 0;return r}onAuthRevoked_(t,i){H("Auth token revoked: "+t+"/"+i),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Fa&&(this.reconnectDelay_=Ma,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,i){H("App check token revoked: "+t+"/"+i),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Fa&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let i of t.values())this.sendListen_(i);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},i="js";Se()&&(this.repoInfo_.nodeAdmin?i="admin_node":i="node"),t["sdk."+i+"."+Ar.replace(/\./g,"-")]=1,es()?t["framework.cordova"]=1:Go()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=ii.getInstance().currentlyOnline();return Gn(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),w=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var At=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let i=new w(ze,e),s=new w(ze,t);return this.compare(i,s)!==0}minPost(){return w.MIN}};var Xn,si=class extends At{static get __EMPTY_NODE(){return Xn}static set __EMPTY_NODE(e){Xn=e}compare(e,t){return at(e.name,t.name)}isDefinedOn(e){throw vt("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return w.MIN}maxPost(){return new w(Me,Xn)}makePost(e,t){return f(typeof e=="string","KeyIndex indexValue must always be a string."),new w(e,Xn)}toString(){return".key"}},Ae=new si;var St=class{constructor(e,t,i,s,r=null){this.isReverse_=s,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?i(e.key,t):1,s&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},ve=(()=>{class n{constructor(t,i,s,r,o){this.key=t,this.value=i,this.color=s??n.RED,this.left=r??_e.EMPTY_NODE,this.right=o??_e.EMPTY_NODE}copy(t,i,s,r,o){return new n(t??this.key,i??this.value,s??this.color,r??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,i,s){let r=this,o=s(t,r.key);return o<0?r=r.copy(null,null,null,r.left.insert(t,i,s),null):o===0?r=r.copy(null,i,null,null,null):r=r.copy(null,null,null,null,r.right.insert(t,i,s)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return _e.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,i){let s,r;if(s=this,i(t,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(t,i),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),i(t,s.key)===0){if(s.right.isEmpty())return _e.EMPTY_NODE;r=s.right.min_(),s=s.copy(r.key,r.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(t,i))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),i=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,i)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),Ls=class{copy(e,t,i,s,r){return this}insert(e,t,i){return new ve(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},_e=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,ve.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,ve.BLACK,null,null))}get(e){let t,i=this.root_;for(;!i.isEmpty();){if(t=this.comparator_(e,i.key),t===0)return i.value;t<0?i=i.left:t>0&&(i=i.right)}return null}getPredecessorKey(e){let t,i=this.root_,s=null;for(;!i.isEmpty();)if(t=this.comparator_(e,i.key),t===0){if(i.left.isEmpty())return s?s.key:null;for(i=i.left;!i.right.isEmpty();)i=i.right;return i.key}else t<0?i=i.left:t>0&&(s=i,i=i.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new St(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new St(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new St(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new St(this.root_,null,this.comparator_,!0,e)}};_e.EMPTY_NODE=new Ls;function bh(n,e){return at(n.name,e.name)}function Mr(n,e){return at(n,e)}var Ws;function Ih(n){Ws=n}var bl=function(n){return typeof n=="number"?"number:"+rl(n):"string:"+n},Il=function(n){if(n.isLeafNode()){let e=n.val();f(typeof e=="string"||typeof e=="number"||typeof e=="object"&&fe(e,".sv"),"Priority must be a string or number.")}else f(n===Ws||n.isEmpty(),"priority of unexpected type.");f(n===Ws||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var La,Rt=(()=>{class n{static set __childrenNodeConstructor(t){La=t}static get __childrenNodeConstructor(){return La}constructor(t,i=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=i,this.lazyHash_=null,f(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Il(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return v(t)?this:y(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,i){return null}updateImmediateChild(t,i){return t===".priority"?this.updatePriority(i):i.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,i).updatePriority(this.priorityNode_)}updateChild(t,i){let s=y(t);return s===null?i:i.isEmpty()&&s!==".priority"?this:(f(s!==".priority"||Ye(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(S(t),i)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,i){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+bl(this.priorityNode_.val())+":");let i=typeof this.value_;t+=i+":",i==="number"?t+=rl(this.value_):t+=this.value_,this.lazyHash_=nl(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(f(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let i=typeof t.value_,s=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(i),o=n.VALUE_TYPE_ORDER.indexOf(s);return f(r>=0,"Unknown leaf type: "+i),f(o>=0,"Unknown leaf type: "+s),r===o?s==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let i=t;return this.value_===i.value_&&this.priorityNode_.equals(i.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),Sl,kl;function Sh(n){Sl=n}function kh(n){kl=n}var Us=class extends At{compare(e,t){let i=e.node.getPriority(),s=t.node.getPriority(),r=i.compareTo(s);return r===0?at(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return w.MIN}maxPost(){return new w(Me,new Rt("[PRIORITY-POST]",kl))}makePost(e,t){let i=Sl(e);return new w(t,new Rt("[PRIORITY-POST]",i))}toString(){return".priority"}},k=new Us;var Ah=Math.log(2),js=class{constructor(e){let t=r=>parseInt(Math.log(r)/Ah,10),i=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let s=i(this.count);this.bits_=e+1&s}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},ri=function(n,e,t,i){n.sort(e);let s=function(l,c){let u=c-l,h,d;if(u===0)return null;if(u===1)return h=n[l],d=t?t(h):h,new ve(d,h.node,ve.BLACK,null,null);{let p=parseInt(u/2,10)+l,_=s(l,p),E=s(p+1,c);return h=n[p],d=t?t(h):h,new ve(d,h.node,ve.BLACK,_,E)}},r=function(l){let c=null,u=null,h=n.length,d=function(_,E){let I=h-_,ne=h;h-=_;let ie=s(I+1,ne),A=n[I],me=t?t(A):A;p(new ve(me,A.node,E,null,ie))},p=function(_){c?(c.left=_,c=_):(u=_,c=_)};for(let _=0;_<l.count;++_){let E=l.nextBitIsOne(),I=Math.pow(2,l.count-(_+1));E?d(I,ve.BLACK):(d(I,ve.BLACK),d(I,ve.RED))}return u},o=new js(n.length),a=r(o);return new _e(i||e,a)};var ws,bt={},Pt=class n{static get Default(){return f(bt&&k,"ChildrenNode.ts has not been loaded"),ws=ws||new n({".priority":bt},{".priority":k}),ws}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){let t=Be(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof _e?t:null}hasIndex(e){return fe(this.indexSet_,e.toString())}addIndex(e,t){f(e!==Ae,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let i=[],s=!1,r=t.getIterator(w.Wrap),o=r.getNext();for(;o;)s=s||e.isDefinedOn(o.node),i.push(o),o=r.getNext();let a;s?a=ri(i,e.getCompare()):a=bt;let l=e.toString(),c=Object.assign({},this.indexSet_);c[l]=e;let u=Object.assign({},this.indexes_);return u[l]=a,new n(u,c)}addToIndexes(e,t){let i=qt(this.indexes_,(s,r)=>{let o=Be(this.indexSet_,r);if(f(o,"Missing index implementation for "+r),s===bt)if(o.isDefinedOn(e.node)){let a=[],l=t.getIterator(w.Wrap),c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),ri(a,o.getCompare())}else return bt;else{let a=t.get(e.name),l=s;return a&&(l=l.remove(new w(e.name,a))),l.insert(e,e.node)}});return new n(i,this.indexSet_)}removeFromIndexes(e,t){let i=qt(this.indexes_,s=>{if(s===bt)return s;{let r=t.get(e.name);return r?s.remove(new w(e.name,r)):s}});return new n(i,this.indexSet_)}};var nn,m=(()=>{class n{static get EMPTY_NODE(){return nn||(nn=new n(new _e(Mr),null,Pt.Default))}constructor(t,i,s){this.children_=t,this.priorityNode_=i,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&Il(this.priorityNode_),this.children_.isEmpty()&&f(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||nn}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let i=this.children_.get(t);return i===null?nn:i}}getChild(t){let i=y(t);return i===null?this:this.getImmediateChild(i).getChild(S(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,i){if(f(i,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(i);{let s=new w(t,i),r,o;i.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(s,this.children_)):(r=this.children_.insert(t,i),o=this.indexMap_.addToIndexes(s,this.children_));let a=r.isEmpty()?nn:this.priorityNode_;return new n(r,a,o)}}updateChild(t,i){let s=y(t);if(s===null)return i;{f(y(t)!==".priority"||Ye(t)===1,".priority must be the last token in a path");let r=this.getImmediateChild(s).updateChild(S(t),i);return this.updateImmediateChild(s,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let i={},s=0,r=0,o=!0;if(this.forEachChild(k,(a,l)=>{i[a]=l.val(t),s++,o&&n.INTEGER_REGEXP_.test(a)?r=Math.max(r,Number(a)):o=!1}),!t&&o&&r<2*s){let a=[];for(let l in i)a[l]=i[l];return a}else return t&&!this.getPriority().isEmpty()&&(i[".priority"]=this.getPriority().val()),i}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+bl(this.getPriority().val())+":"),this.forEachChild(k,(i,s)=>{let r=s.hash();r!==""&&(t+=":"+i+":"+r)}),this.lazyHash_=t===""?"":nl(t)}return this.lazyHash_}getPredecessorChildName(t,i,s){let r=this.resolveIndex_(s);if(r){let o=r.getPredecessorKey(new w(t,i));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let i=this.resolveIndex_(t);if(i){let s=i.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(t){let i=this.getFirstChildName(t);return i?new w(i,this.children_.get(i)):null}getLastChildName(t){let i=this.resolveIndex_(t);if(i){let s=i.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(t){let i=this.getLastChildName(t);return i?new w(i,this.children_.get(i)):null}forEachChild(t,i){let s=this.resolveIndex_(t);return s?s.inorderTraversal(r=>i(r.name,r.node)):this.children_.inorderTraversal(i)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,i){let s=this.resolveIndex_(i);if(s)return s.getIteratorFrom(t,r=>r);{let r=this.children_.getIteratorFrom(t.name,w.Wrap),o=r.peek();for(;o!=null&&i.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,i){let s=this.resolveIndex_(i);if(s)return s.getReverseIteratorFrom(t,r=>r);{let r=this.children_.getReverseIteratorFrom(t.name,w.Wrap),o=r.peek();for(;o!=null&&i.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===Sn?-1:0}withIndex(t){if(t===Ae||this.indexMap_.hasIndex(t))return this;{let i=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,i)}}isIndexed(t){return t===Ae||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let i=t;if(this.getPriority().equals(i.getPriority()))if(this.children_.count()===i.children_.count()){let s=this.getIterator(k),r=i.getIterator(k),o=s.getNext(),a=r.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=s.getNext(),a=r.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(t){return t===Ae?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Bs=class extends m{constructor(){super(new _e(Mr),m.EMPTY_NODE,Pt.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return m.EMPTY_NODE}isEmpty(){return!1}},Sn=new Bs;Object.defineProperties(w,{MIN:{value:new w(ze,m.EMPTY_NODE)},MAX:{value:new w(Me,Sn)}});si.__EMPTY_NODE=m.EMPTY_NODE;Rt.__childrenNodeConstructor=m;Ih(Sn);kh(Sn);var Rh=!0;function P(n,e=null){if(n===null)return m.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),f(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new Rt(t,P(e))}if(!(n instanceof Array)&&Rh){let t=[],i=!1;if(G(n,(o,a)=>{if(o.substring(0,1)!=="."){let l=P(a);l.isEmpty()||(i=i||!l.getPriority().isEmpty(),t.push(new w(o,l)))}}),t.length===0)return m.EMPTY_NODE;let r=ri(t,bh,o=>o.name,Mr);if(i){let o=ri(t,k.getCompare());return new m(r,P(e),new Pt({".priority":o},{".priority":k}))}else return new m(r,P(e),Pt.Default)}else{let t=m.EMPTY_NODE;return G(n,(i,s)=>{if(fe(n,i)&&i.substring(0,1)!=="."){let r=P(s);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(i,r))}}),t.updatePriority(P(e))}}Sh(P);var dn=class extends At{constructor(e){super(),this.indexPath_=e,f(!v(e)&&y(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let i=this.extractChild(e.node),s=this.extractChild(t.node),r=i.compareTo(s);return r===0?at(e.name,t.name):r}makePost(e,t){let i=P(e),s=m.EMPTY_NODE.updateChild(this.indexPath_,i);return new w(t,s)}maxPost(){let e=m.EMPTY_NODE.updateChild(this.indexPath_,Sn);return new w(Me,e)}toString(){return hn(this.indexPath_,0).join("/")}};var Vs=class extends At{compare(e,t){let i=e.node.compareTo(t.node);return i===0?at(e.name,t.name):i}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return w.MIN}maxPost(){return w.MAX}makePost(e,t){let i=P(e);return new w(t,i)}toString(){return".value"}},Fr=new Vs;function Al(n){return{type:"value",snapshotNode:n}}function Nt(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function fn(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function pn(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function Ph(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var _n=class{constructor(e){this.index_=e}updateChild(e,t,i,s,r,o){f(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(t);return a.getChild(s).equals(i.getChild(s))&&a.isEmpty()===i.isEmpty()||(o!=null&&(i.isEmpty()?e.hasChild(t)?o.trackChildChange(fn(t,a)):f(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(Nt(t,i)):o.trackChildChange(pn(t,i,a))),e.isLeafNode()&&i.isEmpty())?e:e.updateImmediateChild(t,i).withIndex(this.index_)}updateFullNode(e,t,i){return i!=null&&(e.isLeafNode()||e.forEachChild(k,(s,r)=>{t.hasChild(s)||i.trackChildChange(fn(s,r))}),t.isLeafNode()||t.forEachChild(k,(s,r)=>{if(e.hasChild(s)){let o=e.getImmediateChild(s);o.equals(r)||i.trackChildChange(pn(s,r,o))}else i.trackChildChange(Nt(s,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?m.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var oi=class n{constructor(e){this.indexedFilter_=new _n(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,i=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&i}updateChild(e,t,i,s,r,o){return this.matches(new w(t,i))||(i=m.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,i,s,r,o)}updateFullNode(e,t,i){t.isLeafNode()&&(t=m.EMPTY_NODE);let s=t.withIndex(this.index_);s=s.updatePriority(m.EMPTY_NODE);let r=this;return t.forEachChild(k,(o,a)=>{r.matches(new w(o,a))||(s=s.updateImmediateChild(o,m.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var $s=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let i=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?i<=0:i<0},this.withinEndPost=t=>{let i=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?i<=0:i<0},this.rangedFilter_=new oi(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,i,s,r,o){return this.rangedFilter_.matches(new w(t,i))||(i=m.EMPTY_NODE),e.getImmediateChild(t).equals(i)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,i,s,r,o):this.fullLimitUpdateChild_(e,t,i,r,o)}updateFullNode(e,t,i){let s;if(t.isLeafNode()||t.isEmpty())s=m.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){s=m.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){let a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))s=s.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{s=t.withIndex(this.index_),s=s.updatePriority(m.EMPTY_NODE);let r;this.reverse_?r=s.getReverseIterator(this.index_):r=s.getIterator(this.index_);let o=0;for(;r.hasNext();){let a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:s=s.updateImmediateChild(a.name,m.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,i,s,r){let o;if(this.reverse_){let h=this.index_.getCompare();o=(d,p)=>h(p,d)}else o=this.index_.getCompare();let a=e;f(a.numChildren()===this.limit_,"");let l=new w(t,i),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(l);if(a.hasChild(t)){let h=a.getImmediateChild(t),d=s.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||a.hasChild(d.name));)d=s.getChildAfterChild(this.index_,d,this.reverse_);let p=d==null?1:o(d,l);if(u&&!i.isEmpty()&&p>=0)return r?.trackChildChange(pn(t,i,h)),a.updateImmediateChild(t,i);{r?.trackChildChange(fn(t,h));let E=a.updateImmediateChild(t,m.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(Nt(d.name,d.node)),E.updateImmediateChild(d.name,d.node)):E}}else return i.isEmpty()?e:u&&o(c,l)>=0?(r!=null&&(r.trackChildChange(fn(c.name,c.node)),r.trackChildChange(Nt(t,i))),a.updateImmediateChild(t,i).updateImmediateChild(c.name,m.EMPTY_NODE)):e}};var gn=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=k}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return f(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return f(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:ze}hasEnd(){return this.endSet_}getIndexEndValue(){return f(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return f(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Me}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return f(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===k}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function Nh(n){return n.loadsAllData()?new _n(n.getIndex()):n.hasLimit()?new $s(n):new oi(n)}function xh(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function Dh(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function Hs(n,e,t){let i=n.copy();return i.startSet_=!0,e===void 0&&(e=null),i.indexStartValue_=e,t!=null?(i.startNameSet_=!0,i.indexStartName_=t):(i.startNameSet_=!1,i.indexStartName_=""),i}function Oh(n,e,t){let i;return n.index_===Ae||t?i=Hs(n,e,t):i=Hs(n,e,Me),i.startAfterSet_=!0,i}function Gs(n,e,t){let i=n.copy();return i.endSet_=!0,e===void 0&&(e=null),i.indexEndValue_=e,t!==void 0?(i.endNameSet_=!0,i.indexEndName_=t):(i.endNameSet_=!1,i.indexEndName_=""),i}function Mh(n,e,t){let i;return n.index_===Ae||t?i=Gs(n,e,t):i=Gs(n,e,ze),i.endBeforeSet_=!0,i}function Ii(n,e){let t=n.copy();return t.index_=e,t}function Wa(n){let e={};if(n.isDefault())return e;let t;if(n.index_===k?t="$priority":n.index_===Fr?t="$value":n.index_===Ae?t="$key":(f(n.index_ instanceof dn,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=O(t),n.startSet_){let i=n.startAfterSet_?"startAfter":"startAt";e[i]=O(n.indexStartValue_),n.startNameSet_&&(e[i]+=","+O(n.indexStartName_))}if(n.endSet_){let i=n.endBeforeSet_?"endBefore":"endAt";e[i]=O(n.indexEndValue_),n.endNameSet_&&(e[i]+=","+O(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function Ua(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==k&&(e.i=n.index_.toString()),e}var qs=class n extends ti{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(f(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,i,s){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=i,this.appCheckTokenProvider_=s,this.log_=In("p:rest:"),this.listens_={}}listen(e,t,i,s){let r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);let o=n.getListenId_(e,i),a={};this.listens_[o]=a;let l=Wa(e._queryParams);this.restRequest_(r+".json",l,(c,u)=>{let h=u;if(c===404&&(h=null,c=null),c===null&&this.onDataUpdate_(r,h,!1,i),Be(this.listens_,o)===a){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",s(d,null)}})}unlisten(e,t){let i=n.getListenId_(e,t);delete this.listens_[i]}get(e){let t=Wa(e._queryParams),i=e._path.toString(),s=new $;return this.restRequest_(i+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(i,a,!1,null),s.resolve(a)):s.reject(new Error(a))}),s.promise}refreshAuthToken(e){}restRequest_(e,t={},i){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([s,r])=>{s&&s.accessToken&&(t.auth=s.accessToken),r&&r.token&&(t.ac=r.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Xo(t);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(i&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=Hn(a.responseText)}catch{K("Failed to parse JSON response for "+o+": "+a.responseText)}i(null,l)}else a.status!==401&&a.status!==404&&K("Got unsuccessful REST response for "+o+" Status: "+a.status),i(a.status);i=null}},a.open("GET",o,!0),a.send()})}};var Ks=class{constructor(){this.rootNode_=m.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function ai(){return{value:null,children:new Map}}function Lt(n,e,t){if(v(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let i=y(e);n.children.has(i)||n.children.set(i,ai());let s=n.children.get(i);e=S(e),Lt(s,e,t)}}function zs(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(k,(i,s)=>{Lt(n,new b(i),s)}),zs(n,e)}}else if(n.children.size>0){let t=y(e);return e=S(e),n.children.has(t)&&zs(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Ys(n,e,t){n.value!==null?t(e,n.value):Fh(n,(i,s)=>{let r=new b(e.toString()+"/"+i);Ys(s,r,t)})}function Fh(n,e){n.children.forEach((t,i)=>{e(i,t)})}var Qs=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&G(this.last_,(i,s)=>{t[i]=t[i]-s}),this.last_=e,t}};var ja=10*1e3,Lh=30*1e3,Wh=300*1e3,Xs=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Qs(e);let i=ja+(Lh-ja)*Math.random();rn(this.reportStats_.bind(this),Math.floor(i))}reportStats_(){let e=this.statsListener_.get(),t={},i=!1;G(e,(s,r)=>{r>0&&fe(this.statsToReport_,s)&&(t[s]=r,i=!0)}),i&&this.server_.reportStats(t),rn(this.reportStats_.bind(this),Math.floor(Math.random()*2*Wh))}};var ke=(function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n})(ke||{});function Lr(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Wr(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Ur(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var Js=class n{constructor(e,t,i){this.path=e,this.affectedTree=t,this.revert=i,this.type=ke.ACK_USER_WRITE,this.source=Lr()}operationForChild(e){if(v(this.path)){if(this.affectedTree.value!=null)return f(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new b(e));return new n(T(),t,this.revert)}}else return f(y(this.path)===e,"operationForChild called for unrelated child."),new n(S(this.path),this.affectedTree,this.revert)}};var li=class n{constructor(e,t){this.source=e,this.path=t,this.type=ke.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new n(this.source,T()):new n(this.source,S(this.path))}};var xt=class n{constructor(e,t,i){this.source=e,this.path=t,this.snap=i,this.type=ke.OVERWRITE}operationForChild(e){return v(this.path)?new n(this.source,T(),this.snap.getImmediateChild(e)):new n(this.source,S(this.path),this.snap)}};var mn=class n{constructor(e,t,i){this.source=e,this.path=t,this.children=i,this.type=ke.MERGE}operationForChild(e){if(v(this.path)){let t=this.children.subtree(new b(e));return t.isEmpty()?null:t.value?new xt(this.source,T(),t.value):new n(this.source,T(),t)}else return f(y(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,S(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var Pe=class{constructor(e,t,i){this.node_=e,this.fullyInitialized_=t,this.filtered_=i}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;let t=y(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var Zs=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Uh(n,e,t,i){let s=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(Ph(o.childName,o.snapshotNode))}),sn(n,s,"child_removed",e,i,t),sn(n,s,"child_added",e,i,t),sn(n,s,"child_moved",r,i,t),sn(n,s,"child_changed",e,i,t),sn(n,s,"value",e,i,t),s}function sn(n,e,t,i,s,r){let o=i.filter(a=>a.type===t);o.sort((a,l)=>Bh(n,a,l)),o.forEach(a=>{let l=jh(n,a,r);s.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function jh(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Bh(n,e,t){if(e.childName==null||t.childName==null)throw vt("Should only compare child_ events.");let i=new w(e.childName,e.snapshotNode),s=new w(t.childName,t.snapshotNode);return n.index_.compare(i,s)}function Si(n,e){return{eventCache:n,serverCache:e}}function an(n,e,t,i){return Si(new Pe(e,t,i),n.serverCache)}function Rl(n,e,t,i){return Si(n.eventCache,new Pe(e,t,i))}function ci(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function ot(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var Es,Vh=()=>(Es||(Es=new _e(ju)),Es),Z=class n{static fromObject(e){let t=new n(null);return G(e,(i,s)=>{t=t.set(new b(i),s)}),t}constructor(e,t=Vh()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:T(),value:this.value};if(v(e))return null;{let i=y(e),s=this.children.get(i);if(s!==null){let r=s.findRootMostMatchingPathAndValue(S(e),t);return r!=null?{path:R(new b(i),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{let t=y(e),i=this.children.get(t);return i!==null?i.subtree(S(e)):new n(null)}}set(e,t){if(v(e))return new n(t,this.children);{let i=y(e),r=(this.children.get(i)||new n(null)).set(S(e),t),o=this.children.insert(i,r);return new n(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=y(e),i=this.children.get(t);if(i){let s=i.remove(S(e)),r;return s.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,s),this.value===null&&r.isEmpty()?new n(null):new n(this.value,r)}else return this}}get(e){if(v(e))return this.value;{let t=y(e),i=this.children.get(t);return i?i.get(S(e)):null}}setTree(e,t){if(v(e))return t;{let i=y(e),r=(this.children.get(i)||new n(null)).setTree(S(e),t),o;return r.isEmpty()?o=this.children.remove(i):o=this.children.insert(i,r),new n(this.value,o)}}fold(e){return this.fold_(T(),e)}fold_(e,t){let i={};return this.children.inorderTraversal((s,r)=>{i[s]=r.fold_(R(e,s),t)}),t(e,this.value,i)}findOnPath(e,t){return this.findOnPath_(e,T(),t)}findOnPath_(e,t,i){let s=this.value?i(t,this.value):!1;if(s)return s;if(v(e))return null;{let r=y(e),o=this.children.get(r);return o?o.findOnPath_(S(e),R(t,r),i):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,T(),t)}foreachOnPath_(e,t,i){if(v(e))return this;{this.value&&i(t,this.value);let s=y(e),r=this.children.get(s);return r?r.foreachOnPath_(S(e),R(t,s),i):new n(null)}}foreach(e){this.foreach_(T(),e)}foreach_(e,t){this.children.inorderTraversal((i,s)=>{s.foreach_(R(e,i),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,i)=>{i.value&&e(t,i.value)})}};var we=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new Z(null))}};function ln(n,e,t){if(v(e))return new we(new Z(t));{let i=n.writeTree_.findRootMostValueAndPath(e);if(i!=null){let s=i.path,r=i.value,o=J(s,e);return r=r.updateChild(o,t),new we(n.writeTree_.set(s,r))}else{let s=new Z(t),r=n.writeTree_.setTree(e,s);return new we(r)}}}function er(n,e,t){let i=n;return G(t,(s,r)=>{i=ln(i,R(e,s),r)}),i}function Ba(n,e){if(v(e))return we.empty();{let t=n.writeTree_.setTree(e,new Z(null));return new we(t)}}function tr(n,e){return lt(n,e)!=null}function lt(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(J(t.path,e)):null}function Va(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(k,(i,s)=>{e.push(new w(i,s))}):n.writeTree_.children.inorderTraversal((i,s)=>{s.value!=null&&e.push(new w(i,s.value))}),e}function qe(n,e){if(v(e))return n;{let t=lt(n,e);return t!=null?new we(new Z(t)):new we(n.writeTree_.subtree(e))}}function nr(n){return n.writeTree_.isEmpty()}function Dt(n,e){return Pl(T(),n.writeTree_,e)}function Pl(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let i=null;return e.children.inorderTraversal((s,r)=>{s===".priority"?(f(r.value!==null,"Priority writes must always be leaf nodes"),i=r.value):t=Pl(R(n,s),r,t)}),!t.getChild(n).isEmpty()&&i!==null&&(t=t.updateChild(R(n,".priority"),i)),t}}function ki(n,e){return Ol(e,n)}function $h(n,e,t,i,s){f(i>n.lastWriteId,"Stacking an older write on top of newer ones"),s===void 0&&(s=!0),n.allWrites.push({path:e,snap:t,writeId:i,visible:s}),s&&(n.visibleWrites=ln(n.visibleWrites,e,t)),n.lastWriteId=i}function Hh(n,e,t,i){f(i>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:i,visible:!0}),n.visibleWrites=er(n.visibleWrites,e,t),n.lastWriteId=i}function Gh(n,e){for(let t=0;t<n.allWrites.length;t++){let i=n.allWrites[t];if(i.writeId===e)return i}return null}function qh(n,e){let t=n.allWrites.findIndex(a=>a.writeId===e);f(t>=0,"removeWrite called with nonexistent writeId.");let i=n.allWrites[t];n.allWrites.splice(t,1);let s=i.visible,r=!1,o=n.allWrites.length-1;for(;s&&o>=0;){let a=n.allWrites[o];a.visible&&(o>=t&&Kh(a,i.path)?s=!1:pe(i.path,a.path)&&(r=!0)),o--}if(s){if(r)return zh(n),!0;if(i.snap)n.visibleWrites=Ba(n.visibleWrites,i.path);else{let a=i.children;G(a,l=>{n.visibleWrites=Ba(n.visibleWrites,R(i.path,l))})}return!0}else return!1}function Kh(n,e){if(n.snap)return pe(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&pe(R(n.path,t),e))return!0;return!1}function zh(n){n.visibleWrites=Nl(n.allWrites,Yh,T()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function Yh(n){return n.visible}function Nl(n,e,t){let i=we.empty();for(let s=0;s<n.length;++s){let r=n[s];if(e(r)){let o=r.path,a;if(r.snap)pe(t,o)?(a=J(t,o),i=ln(i,a,r.snap)):pe(o,t)&&(a=J(o,t),i=ln(i,T(),r.snap.getChild(a)));else if(r.children){if(pe(t,o))a=J(t,o),i=er(i,a,r.children);else if(pe(o,t))if(a=J(o,t),v(a))i=er(i,T(),r.children);else{let l=Be(r.children,y(a));if(l){let c=l.getChild(S(a));i=ln(i,T(),c)}}}else throw vt("WriteRecord should have .snap or .children")}}return i}function xl(n,e,t,i,s){if(!i&&!s){let r=lt(n.visibleWrites,e);if(r!=null)return r;{let o=qe(n.visibleWrites,e);if(nr(o))return t;if(t==null&&!tr(o,T()))return null;{let a=t||m.EMPTY_NODE;return Dt(o,a)}}}else{let r=qe(n.visibleWrites,e);if(!s&&nr(r))return t;if(!s&&t==null&&!tr(r,T()))return null;{let o=function(c){return(c.visible||s)&&(!i||!~i.indexOf(c.writeId))&&(pe(c.path,e)||pe(e,c.path))},a=Nl(n.allWrites,o,e),l=t||m.EMPTY_NODE;return Dt(a,l)}}}function Qh(n,e,t){let i=m.EMPTY_NODE,s=lt(n.visibleWrites,e);if(s)return s.isLeafNode()||s.forEachChild(k,(r,o)=>{i=i.updateImmediateChild(r,o)}),i;if(t){let r=qe(n.visibleWrites,e);return t.forEachChild(k,(o,a)=>{let l=Dt(qe(r,new b(o)),a);i=i.updateImmediateChild(o,l)}),Va(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}else{let r=qe(n.visibleWrites,e);return Va(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}}function Xh(n,e,t,i,s){f(i||s,"Either existingEventSnap or existingServerSnap must exist");let r=R(e,t);if(tr(n.visibleWrites,r))return null;{let o=qe(n.visibleWrites,r);return nr(o)?s.getChild(t):Dt(o,s.getChild(t))}}function Jh(n,e,t,i){let s=R(e,t),r=lt(n.visibleWrites,s);if(r!=null)return r;if(i.isCompleteForChild(t)){let o=qe(n.visibleWrites,s);return Dt(o,i.getNode().getImmediateChild(t))}else return null}function Zh(n,e){return lt(n.visibleWrites,e)}function ed(n,e,t,i,s,r,o){let a,l=qe(n.visibleWrites,e),c=lt(l,T());if(c!=null)a=c;else if(t!=null)a=Dt(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let u=[],h=o.getCompare(),d=r?a.getReverseIteratorFrom(i,o):a.getIteratorFrom(i,o),p=d.getNext();for(;p&&u.length<s;)h(p,i)!==0&&u.push(p),p=d.getNext();return u}else return[]}function td(){return{visibleWrites:we.empty(),allWrites:[],lastWriteId:-1}}function ui(n,e,t,i){return xl(n.writeTree,n.treePath,e,t,i)}function jr(n,e){return Qh(n.writeTree,n.treePath,e)}function $a(n,e,t,i){return Xh(n.writeTree,n.treePath,e,t,i)}function hi(n,e){return Zh(n.writeTree,R(n.treePath,e))}function nd(n,e,t,i,s,r){return ed(n.writeTree,n.treePath,e,t,i,s,r)}function Br(n,e,t){return Jh(n.writeTree,n.treePath,e,t)}function Dl(n,e){return Ol(R(n.treePath,e),n.writeTree)}function Ol(n,e){return{treePath:n,writeTree:e}}var ir=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,i=e.childName;f(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),f(i!==".priority","Only non-priority child changes can be tracked.");let s=this.changeMap.get(i);if(s){let r=s.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(i,pn(i,e.snapshotNode,s.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(i);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(i,fn(i,s.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(i,Nt(i,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(i,pn(i,e.snapshotNode,s.oldSnap));else throw vt("Illegal combination of changes: "+e+" occurred after "+s)}else this.changeMap.set(i,e)}getChanges(){return Array.from(this.changeMap.values())}};var sr=class{getCompleteChild(e){return null}getChildAfterChild(e,t,i){return null}},Ml=new sr,yn=class{constructor(e,t,i=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=i}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let i=this.optCompleteServerCache_!=null?new Pe(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Br(this.writes_,e,i)}}getChildAfterChild(e,t,i){let s=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:ot(this.viewCache_),r=nd(this.writes_,s,t,1,i,e);return r.length===0?null:r[0]}};function id(n){return{filter:n}}function sd(n,e){f(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),f(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function rd(n,e,t,i,s){let r=new ir,o,a;if(t.type===ke.OVERWRITE){let c=t;c.source.fromUser?o=rr(n,e,c.path,c.snap,i,s,r):(f(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!v(c.path),o=di(n,e,c.path,c.snap,i,s,a,r))}else if(t.type===ke.MERGE){let c=t;c.source.fromUser?o=ad(n,e,c.path,c.children,i,s,r):(f(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=or(n,e,c.path,c.children,i,s,a,r))}else if(t.type===ke.ACK_USER_WRITE){let c=t;c.revert?o=ud(n,e,c.path,i,s,r):o=ld(n,e,c.path,c.affectedTree,i,s,r)}else if(t.type===ke.LISTEN_COMPLETE)o=cd(n,e,t.path,i,r);else throw vt("Unknown operation type: "+t.type);let l=r.getChanges();return od(e,o,l),{viewCache:o,changes:l}}function od(n,e,t){let i=e.eventCache;if(i.isFullyInitialized()){let s=i.getNode().isLeafNode()||i.getNode().isEmpty(),r=ci(n);(t.length>0||!n.eventCache.isFullyInitialized()||s&&!i.getNode().equals(r)||!i.getNode().getPriority().equals(r.getPriority()))&&t.push(Al(ci(e)))}}function Fl(n,e,t,i,s,r){let o=e.eventCache;if(hi(i,t)!=null)return e;{let a,l;if(v(t))if(f(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=ot(e),u=c instanceof m?c:m.EMPTY_NODE,h=jr(i,u);a=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{let c=ui(i,ot(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{let c=y(t);if(c===".priority"){f(Ye(t)===1,"Can't have a priority with additional path components");let u=o.getNode();l=e.serverCache.getNode();let h=$a(i,t,u,l);h!=null?a=n.filter.updatePriority(u,h):a=o.getNode()}else{let u=S(t),h;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();let d=$a(i,t,o.getNode(),l);d!=null?h=o.getNode().getImmediateChild(c).updateChild(u,d):h=o.getNode().getImmediateChild(c)}else h=Br(i,c,e.serverCache);h!=null?a=n.filter.updateChild(o.getNode(),c,h,u,s,r):a=o.getNode()}}return an(e,a,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function di(n,e,t,i,s,r,o,a){let l=e.serverCache,c,u=o?n.filter:n.filter.getIndexedFilter();if(v(t))c=u.updateFullNode(l.getNode(),i,null);else if(u.filtersNodes()&&!l.isFiltered()){let p=l.getNode().updateChild(t,i);c=u.updateFullNode(l.getNode(),p,null)}else{let p=y(t);if(!l.isCompleteForPath(t)&&Ye(t)>1)return e;let _=S(t),I=l.getNode().getImmediateChild(p).updateChild(_,i);p===".priority"?c=u.updatePriority(l.getNode(),I):c=u.updateChild(l.getNode(),p,I,_,Ml,null)}let h=Rl(e,c,l.isFullyInitialized()||v(t),u.filtersNodes()),d=new yn(s,h,r);return Fl(n,h,t,s,d,a)}function rr(n,e,t,i,s,r,o){let a=e.eventCache,l,c,u=new yn(s,e,r);if(v(t))c=n.filter.updateFullNode(e.eventCache.getNode(),i,o),l=an(e,c,!0,n.filter.filtersNodes());else{let h=y(t);if(h===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),i),l=an(e,c,a.isFullyInitialized(),a.isFiltered());else{let d=S(t),p=a.getNode().getImmediateChild(h),_;if(v(d))_=i;else{let E=u.getCompleteChild(h);E!=null?xr(d)===".priority"&&E.getChild(Cl(d)).isEmpty()?_=E:_=E.updateChild(d,i):_=m.EMPTY_NODE}if(p.equals(_))l=e;else{let E=n.filter.updateChild(a.getNode(),h,_,d,u,o);l=an(e,E,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function Ha(n,e){return n.eventCache.isCompleteForChild(e)}function ad(n,e,t,i,s,r,o){let a=e;return i.foreach((l,c)=>{let u=R(t,l);Ha(e,y(u))&&(a=rr(n,a,u,c,s,r,o))}),i.foreach((l,c)=>{let u=R(t,l);Ha(e,y(u))||(a=rr(n,a,u,c,s,r,o))}),a}function Ga(n,e,t){return t.foreach((i,s)=>{e=e.updateChild(i,s)}),e}function or(n,e,t,i,s,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;v(t)?c=i:c=new Z(null).setTree(t,i);let u=e.serverCache.getNode();return c.children.inorderTraversal((h,d)=>{if(u.hasChild(h)){let p=e.serverCache.getNode().getImmediateChild(h),_=Ga(n,p,d);l=di(n,l,new b(h),_,s,r,o,a)}}),c.children.inorderTraversal((h,d)=>{let p=!e.serverCache.isCompleteForChild(h)&&d.value===null;if(!u.hasChild(h)&&!p){let _=e.serverCache.getNode().getImmediateChild(h),E=Ga(n,_,d);l=di(n,l,new b(h),E,s,r,o,a)}}),l}function ld(n,e,t,i,s,r,o){if(hi(s,t)!=null)return e;let a=e.serverCache.isFiltered(),l=e.serverCache;if(i.value!=null){if(v(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return di(n,e,t,l.getNode().getChild(t),s,r,a,o);if(v(t)){let c=new Z(null);return l.getNode().forEachChild(Ae,(u,h)=>{c=c.set(new b(u),h)}),or(n,e,t,c,s,r,a,o)}else return e}else{let c=new Z(null);return i.foreach((u,h)=>{let d=R(t,u);l.isCompleteForPath(d)&&(c=c.set(u,l.getNode().getChild(d)))}),or(n,e,t,c,s,r,a,o)}}function cd(n,e,t,i,s){let r=e.serverCache,o=Rl(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered());return Fl(n,o,t,i,Ml,s)}function ud(n,e,t,i,s,r){let o;if(hi(i,t)!=null)return e;{let a=new yn(i,e,s),l=e.eventCache.getNode(),c;if(v(t)||y(t)===".priority"){let u;if(e.serverCache.isFullyInitialized())u=ui(i,ot(e));else{let h=e.serverCache.getNode();f(h instanceof m,"serverChildren would be complete if leaf node"),u=jr(i,h)}u=u,c=n.filter.updateFullNode(l,u,r)}else{let u=y(t),h=Br(i,u,e.serverCache);h==null&&e.serverCache.isCompleteForChild(u)&&(h=l.getImmediateChild(u)),h!=null?c=n.filter.updateChild(l,u,h,S(t),a,r):e.eventCache.getNode().hasChild(u)?c=n.filter.updateChild(l,u,m.EMPTY_NODE,S(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=ui(i,ot(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||hi(i,T())!=null,an(e,c,o,n.filter.filtersNodes())}}var ar=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let i=this.query_._queryParams,s=new _n(i.getIndex()),r=Nh(i);this.processor_=id(r);let o=t.serverCache,a=t.eventCache,l=s.updateFullNode(m.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(m.EMPTY_NODE,a.getNode(),null),u=new Pe(l,o.isFullyInitialized(),s.filtersNodes()),h=new Pe(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=Si(h,u),this.eventGenerator_=new Zs(this.query_)}get query(){return this.query_}};function hd(n){return n.viewCache_.serverCache.getNode()}function dd(n){return ci(n.viewCache_)}function fd(n,e){let t=ot(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(y(e)).isEmpty())?t.getChild(e):null}function qa(n){return n.eventRegistrations_.length===0}function pd(n,e){n.eventRegistrations_.push(e)}function Ka(n,e,t){let i=[];if(t){f(e==null,"A cancel should cancel all event registrations.");let s=n.query._path;n.eventRegistrations_.forEach(r=>{let o=r.createCancelEvent(t,s);o&&i.push(o)})}if(e){let s=[];for(let r=0;r<n.eventRegistrations_.length;++r){let o=n.eventRegistrations_[r];if(!o.matches(e))s.push(o);else if(e.hasAnyCallback()){s=s.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=s}else n.eventRegistrations_=[];return i}function za(n,e,t,i){e.type===ke.MERGE&&e.source.queryId!==null&&(f(ot(n.viewCache_),"We should always have a full cache before handling merges"),f(ci(n.viewCache_),"Missing event cache, even though we have a server cache"));let s=n.viewCache_,r=rd(n.processor_,s,e,t,i);return sd(n.processor_,r.viewCache),f(r.viewCache.serverCache.isFullyInitialized()||!s.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Ll(n,r.changes,r.viewCache.eventCache.getNode(),null)}function _d(n,e){let t=n.viewCache_.eventCache,i=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(k,(r,o)=>{i.push(Nt(r,o))}),t.isFullyInitialized()&&i.push(Al(t.getNode())),Ll(n,i,t.getNode(),e)}function Ll(n,e,t,i){let s=i?[i]:n.eventRegistrations_;return Uh(n.eventGenerator_,e,t,s)}var fi,pi=class{constructor(){this.views=new Map}};function gd(n){f(!fi,"__referenceConstructor has already been defined"),fi=n}function md(){return f(fi,"Reference.ts has not been loaded"),fi}function yd(n){return n.views.size===0}function Vr(n,e,t,i){let s=e.source.queryId;if(s!==null){let r=n.views.get(s);return f(r!=null,"SyncTree gave us an op for an invalid query."),za(r,e,t,i)}else{let r=[];for(let o of n.views.values())r=r.concat(za(o,e,t,i));return r}}function Wl(n,e,t,i,s){let r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=ui(t,s?i:null),l=!1;a?l=!0:i instanceof m?(a=jr(t,i),l=!1):(a=m.EMPTY_NODE,l=!1);let c=Si(new Pe(a,l,!1),new Pe(i,s,!1));return new ar(e,c)}return o}function vd(n,e,t,i,s,r){let o=Wl(n,e,i,s,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),pd(o,t),_d(o,t)}function wd(n,e,t,i){let s=e._queryIdentifier,r=[],o=[],a=Qe(n);if(s==="default")for(let[l,c]of n.views.entries())o=o.concat(Ka(c,t,i)),qa(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{let l=n.views.get(s);l&&(o=o.concat(Ka(l,t,i)),qa(l)&&(n.views.delete(s),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!Qe(n)&&r.push(new(md())(e._repo,e._path)),{removed:r,events:o}}function Ul(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Ke(n,e){let t=null;for(let i of n.views.values())t=t||fd(i,e);return t}function jl(n,e){if(e._queryParams.loadsAllData())return Ai(n);{let i=e._queryIdentifier;return n.views.get(i)}}function Bl(n,e){return jl(n,e)!=null}function Qe(n){return Ai(n)!=null}function Ai(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var _i;function Ed(n){f(!_i,"__referenceConstructor has already been defined"),_i=n}function Cd(){return f(_i,"Reference.ts has not been loaded"),_i}var Td=1,gi=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new Z(null),this.pendingWriteTree_=td(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function $r(n,e,t,i,s){return $h(n.pendingWriteTree_,e,t,i,s),s?Wt(n,new xt(Lr(),e,t)):[]}function bd(n,e,t,i){Hh(n.pendingWriteTree_,e,t,i);let s=Z.fromObject(t);return Wt(n,new mn(Lr(),e,s))}function Ge(n,e,t=!1){let i=Gh(n.pendingWriteTree_,e);if(qh(n.pendingWriteTree_,e)){let r=new Z(null);return i.snap!=null?r=r.set(T(),!0):G(i.children,o=>{r=r.set(new b(o),!0)}),Wt(n,new Js(i.path,r,t))}else return[]}function kn(n,e,t){return Wt(n,new xt(Wr(),e,t))}function Id(n,e,t){let i=Z.fromObject(t);return Wt(n,new mn(Wr(),e,i))}function Sd(n,e){return Wt(n,new li(Wr(),e))}function kd(n,e,t){let i=Hr(n,t);if(i){let s=Gr(i),r=s.path,o=s.queryId,a=J(r,e),l=new li(Ur(o),a);return qr(n,r,l)}else return[]}function mi(n,e,t,i,s=!1){let r=e._path,o=n.syncPointTree_.get(r),a=[];if(o&&(e._queryIdentifier==="default"||Bl(o,e))){let l=wd(o,e,t,i);yd(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));let c=l.removed;if(a=l.events,!s){let u=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,h=n.syncPointTree_.findOnPath(r,(d,p)=>Qe(p));if(u&&!h){let d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){let p=Pd(d);for(let _=0;_<p.length;++_){let E=p[_],I=E.query,ne=Gl(n,E);n.listenProvider_.startListening(cn(I),vn(n,I),ne.hashFn,ne.onComplete)}}}!h&&c.length>0&&!i&&(u?n.listenProvider_.stopListening(cn(e),null):c.forEach(d=>{let p=n.queryToTagMap.get(Pi(d));n.listenProvider_.stopListening(cn(d),p)}))}Nd(n,c)}return a}function Vl(n,e,t,i){let s=Hr(n,i);if(s!=null){let r=Gr(s),o=r.path,a=r.queryId,l=J(o,e),c=new xt(Ur(a),l,t);return qr(n,o,c)}else return[]}function Ad(n,e,t,i){let s=Hr(n,i);if(s){let r=Gr(s),o=r.path,a=r.queryId,l=J(o,e),c=Z.fromObject(t),u=new mn(Ur(a),l,c);return qr(n,o,u)}else return[]}function lr(n,e,t,i=!1){let s=e._path,r=null,o=!1;n.syncPointTree_.foreachOnPath(s,(d,p)=>{let _=J(d,s);r=r||Ke(p,_),o=o||Qe(p)});let a=n.syncPointTree_.get(s);a?(o=o||Qe(a),r=r||Ke(a,T())):(a=new pi,n.syncPointTree_=n.syncPointTree_.set(s,a));let l;r!=null?l=!0:(l=!1,r=m.EMPTY_NODE,n.syncPointTree_.subtree(s).foreachChild((p,_)=>{let E=Ke(_,T());E&&(r=r.updateImmediateChild(p,E))}));let c=Bl(a,e);if(!c&&!e._queryParams.loadsAllData()){let d=Pi(e);f(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");let p=xd();n.queryToTagMap.set(d,p),n.tagToQueryMap.set(p,d)}let u=ki(n.pendingWriteTree_,s),h=vd(a,e,t,u,r,l);if(!c&&!o&&!i){let d=jl(a,e);h=h.concat(Dd(n,e,d))}return h}function Ri(n,e,t){let s=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{let l=J(o,e),c=Ke(a,l);if(c)return c});return xl(s,e,r,t,!0)}function Rd(n,e){let t=e._path,i=null;n.syncPointTree_.foreachOnPath(t,(c,u)=>{let h=J(c,t);i=i||Ke(u,h)});let s=n.syncPointTree_.get(t);s?i=i||Ke(s,T()):(s=new pi,n.syncPointTree_=n.syncPointTree_.set(t,s));let r=i!=null,o=r?new Pe(i,!0,!1):null,a=ki(n.pendingWriteTree_,e._path),l=Wl(s,e,a,r?o.getNode():m.EMPTY_NODE,r);return dd(l)}function Wt(n,e){return $l(e,n.syncPointTree_,null,ki(n.pendingWriteTree_,T()))}function $l(n,e,t,i){if(v(n.path))return Hl(n,e,t,i);{let s=e.get(T());t==null&&s!=null&&(t=Ke(s,T()));let r=[],o=y(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){let c=t?t.getImmediateChild(o):null,u=Dl(i,o);r=r.concat($l(a,l,c,u))}return s&&(r=r.concat(Vr(s,n,i,t))),r}}function Hl(n,e,t,i){let s=e.get(T());t==null&&s!=null&&(t=Ke(s,T()));let r=[];return e.children.inorderTraversal((o,a)=>{let l=t?t.getImmediateChild(o):null,c=Dl(i,o),u=n.operationForChild(o);u&&(r=r.concat(Hl(u,a,l,c)))}),s&&(r=r.concat(Vr(s,n,i,t))),r}function Gl(n,e){let t=e.query,i=vn(n,t);return{hashFn:()=>(hd(e)||m.EMPTY_NODE).hash(),onComplete:s=>{if(s==="ok")return i?kd(n,t._path,i):Sd(n,t._path);{let r=$u(s,t);return mi(n,t,null,r)}}}}function vn(n,e){let t=Pi(e);return n.queryToTagMap.get(t)}function Pi(n){return n._path.toString()+"$"+n._queryIdentifier}function Hr(n,e){return n.tagToQueryMap.get(e)}function Gr(n){let e=n.indexOf("$");return f(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new b(n.substr(0,e))}}function qr(n,e,t){let i=n.syncPointTree_.get(e);f(i,"Missing sync point for query tag that we're tracking");let s=ki(n.pendingWriteTree_,e);return Vr(i,t,s,null)}function Pd(n){return n.fold((e,t,i)=>{if(t&&Qe(t))return[Ai(t)];{let s=[];return t&&(s=Ul(t)),G(i,(r,o)=>{s=s.concat(o)}),s}})}function cn(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(Cd())(n._repo,n._path):n}function Nd(n,e){for(let t=0;t<e.length;++t){let i=e[t];if(!i._queryParams.loadsAllData()){let s=Pi(i),r=n.queryToTagMap.get(s);n.queryToTagMap.delete(s),n.tagToQueryMap.delete(r)}}}function xd(){return Td++}function Dd(n,e,t){let i=e._path,s=vn(n,e),r=Gl(n,t),o=n.listenProvider_.startListening(cn(e),s,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(i);if(s)f(!Qe(a.value),"If we're adding a query, it shouldn't be shadowed");else{let l=a.fold((c,u,h)=>{if(!v(c)&&u&&Qe(u))return[Ai(u).query];{let d=[];return u&&(d=d.concat(Ul(u).map(p=>p.query))),G(h,(p,_)=>{d=d.concat(_)}),d}});for(let c=0;c<l.length;++c){let u=l[c];n.listenProvider_.stopListening(cn(u),vn(n,u))}}return o}var cr=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},ur=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=R(this.path_,e);return new n(this.syncTree_,t)}node(){return Ri(this.syncTree_,this.path_)}},Od=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Ya=function(n,e,t){if(!n||typeof n!="object")return n;if(f(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return Md(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Fd(n[".sv"],e);f(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},Md=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:f(!1,"Unexpected server value: "+n)}},Fd=function(n,e,t){n.hasOwnProperty("increment")||f(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let i=n.increment;typeof i!="number"&&f(!1,"Unexpected increment value: "+i);let s=e.node();if(f(s!==null&&typeof s<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!s.isLeafNode())return i;let o=s.getValue();return typeof o!="number"?i:o+i},ql=function(n,e,t,i){return zr(e,new ur(t,n),i)},Kr=function(n,e,t){return zr(n,new cr(e),t)};function zr(n,e,t){let i=n.getPriority().val(),s=Ya(i,e.getImmediateChild(".priority"),t),r;if(n.isLeafNode()){let o=n,a=Ya(o.getValue(),e,t);return a!==o.getValue()||s!==o.getPriority().val()?new Rt(a,P(s)):n}else{let o=n;return r=o,s!==o.getPriority().val()&&(r=r.updatePriority(new Rt(s))),o.forEachChild(k,(a,l)=>{let c=zr(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}var wn=class{constructor(e="",t=null,i={children:{},childCount:0}){this.name=e,this.parent=t,this.node=i}};function Ni(n,e){let t=e instanceof b?e:new b(e),i=n,s=y(t);for(;s!==null;){let r=Be(i.node.children,s)||{children:{},childCount:0};i=new wn(s,i,r),t=S(t),s=y(t)}return i}function ct(n){return n.node.value}function Yr(n,e){n.node.value=e,hr(n)}function Kl(n){return n.node.childCount>0}function Ld(n){return ct(n)===void 0&&!Kl(n)}function xi(n,e){G(n.node.children,(t,i)=>{e(new wn(t,n,i))})}function zl(n,e,t,i){t&&!i&&e(n),xi(n,s=>{zl(s,e,!0,i)}),t&&i&&e(n)}function Wd(n,e,t){let i=t?n:n.parent;for(;i!==null;){if(e(i))return!0;i=i.parent}return!1}function An(n){return new b(n.parent===null?n.name:An(n.parent)+"/"+n.name)}function hr(n){n.parent!==null&&Ud(n.parent,n.name,n)}function Ud(n,e,t){let i=Ld(t),s=fe(n.node.children,e);i&&s?(delete n.node.children[e],n.node.childCount--,hr(n)):!i&&!s&&(n.node.children[e]=t.node,n.node.childCount++,hr(n))}var jd=/[\[\].#$\/\u0000-\u001F\u007F]/,Bd=/[\[\].#$\u0000-\u001F\u007F]/,Cs=10*1024*1024,Di=function(n){return typeof n=="string"&&n.length!==0&&!jd.test(n)},Yl=function(n){return typeof n=="string"&&n.length!==0&&!Bd.test(n)},Vd=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Yl(n)},En=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!bi(n)||n&&typeof n=="object"&&fe(n,".sv")},Ne=function(n,e,t,i){i&&e===void 0||Rn(te(n,"value"),e,t)},Rn=function(n,e,t){let i=t instanceof b?new Ms(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+it(i));if(typeof e=="function")throw new Error(n+"contains a function "+it(i)+" with contents = "+e.toString());if(bi(e))throw new Error(n+"contains "+e.toString()+" "+it(i));if(typeof e=="string"&&e.length>Cs/3&&Kt(e)>Cs)throw new Error(n+"contains a string greater than "+Cs+" utf8 bytes "+it(i)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let s=!1,r=!1;if(G(e,(o,a)=>{if(o===".value")s=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Di(o)))throw new Error(n+" contains an invalid key ("+o+") "+it(i)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);yh(i,o),Rn(n,a,i),vh(i)}),s&&r)throw new Error(n+' contains ".value" child '+it(i)+" in addition to actual children.")}},$d=function(n,e){let t,i;for(t=0;t<e.length;t++){i=e[t];let r=hn(i);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Di(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+i.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(mh);let s=null;for(t=0;t<e.length;t++){if(i=e[t],s!==null&&pe(s,i))throw new Error(n+"contains a path "+s.toString()+" that is ancestor of another path "+i.toString());s=i}},Ql=function(n,e,t,i){if(i&&e===void 0)return;let s=te(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(s+" must be an object containing the children to replace.");let r=[];G(e,(o,a)=>{let l=new b(o);if(Rn(s,a,R(t,l)),xr(l)===".priority"&&!En(a))throw new Error(s+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),$d(s,r)},Qr=function(n,e,t){if(!(t&&e===void 0)){if(bi(e))throw new Error(te(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!En(e))throw new Error(te(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},Pn=function(n,e,t,i){if(!(i&&t===void 0)&&!Di(t))throw new Error(te(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},Ut=function(n,e,t,i){if(!(i&&t===void 0)&&!Yl(t))throw new Error(te(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Hd=function(n,e,t,i){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Ut(n,e,t,i)},oe=function(n,e){if(y(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Xl=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Di(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Vd(t))throw new Error(te(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var dr=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function Oi(n,e){let t=null;for(let i=0;i<e.length;i++){let s=e[i],r=s.getPath();t!==null&&!Dr(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(s)}t&&n.eventLists_.push(t)}function Jl(n,e,t){Oi(n,t),Zl(n,i=>Dr(i,e))}function ae(n,e,t){Oi(n,t),Zl(n,i=>pe(i,e)||pe(e,i))}function Zl(n,e){n.recursionDepth_++;let t=!0;for(let i=0;i<n.eventLists_.length;i++){let s=n.eventLists_[i];if(s){let r=s.path;e(r)?(Gd(n.eventLists_[i]),n.eventLists_[i]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function Gd(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let i=t.getEventRunner();rt&&H("event: "+t.toString()),Ft(i)}}}var ec="repo_interrupt",qd=25,fr=class{constructor(e,t,i,s){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=i,this.appCheckProvider_=s,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new dr,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=ai(),this.transactionQueueTree_=new wn,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function Kd(n,e,t){if(n.stats_=Nr(n.repoInfo_),n.forceRestClient_||Ku())n.server_=new qs(n.repoInfo_,(i,s,r,o)=>{Qa(n,i,s,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Xa(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{O(t)}catch(i){throw new Error("Invalid authOverride provided: "+i)}}n.persistentConnection_=new Or(n.repoInfo_,e,(i,s,r,o)=>{Qa(n,i,s,r,o)},i=>{Xa(n,i)},i=>{zd(n,i)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(i=>{n.server_.refreshAuthToken(i)}),n.appCheckProvider_.addTokenChangeListener(i=>{n.server_.refreshAppCheckToken(i.token)}),n.statsReporter_=Yu(n.repoInfo_,()=>new Xs(n.stats_,n.server_)),n.infoData_=new Ks,n.infoSyncTree_=new gi({startListening:(i,s,r,o)=>{let a=[],l=n.infoData_.getNode(i._path);return l.isEmpty()||(a=kn(n.infoSyncTree_,i._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Xr(n,"connected",!1),n.serverSyncTree_=new gi({startListening:(i,s,r,o)=>(n.server_.listen(i,r,s,(a,l)=>{let c=o(a,l);ae(n.eventQueue_,i._path,c)}),[]),stopListening:(i,s)=>{n.server_.unlisten(i,s)}})}function tc(n){let t=n.infoData_.getNode(new b(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Nn(n){return Od({timestamp:tc(n)})}function Qa(n,e,t,i,s){n.dataUpdateCount++;let r=new b(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(s)if(i){let l=qt(t,c=>P(c));o=Ad(n.serverSyncTree_,r,l,s)}else{let l=P(t);o=Vl(n.serverSyncTree_,r,l,s)}else if(i){let l=qt(t,c=>P(c));o=Id(n.serverSyncTree_,r,l)}else{let l=P(t);o=kn(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=Ot(n,r)),ae(n.eventQueue_,a,o)}function Xa(n,e){Xr(n,"connected",e),e===!1&&Xd(n)}function zd(n,e){G(e,(t,i)=>{Xr(n,t,i)})}function Xr(n,e,t){let i=new b("/.info/"+e),s=P(t);n.infoData_.updateSnapshot(i,s);let r=kn(n.infoSyncTree_,i,s);ae(n.eventQueue_,i,r)}function Mi(n){return n.nextWriteId_++}function Yd(n,e,t){let i=Rd(n.serverSyncTree_,e);return i!=null?Promise.resolve(i):n.server_.get(e).then(s=>{let r=P(s).withIndex(e._queryParams.getIndex());lr(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=kn(n.serverSyncTree_,e._path,r);else{let a=vn(n.serverSyncTree_,e);o=Vl(n.serverSyncTree_,e._path,r,a)}return ae(n.eventQueue_,e._path,o),mi(n.serverSyncTree_,e,t,null,!0),r},s=>(jt(n,"get for query "+O(e)+" failed: "+s),Promise.reject(new Error(s))))}function Jr(n,e,t,i,s){jt(n,"set",{path:e.toString(),value:t,priority:i});let r=Nn(n),o=P(t,i),a=Ri(n.serverSyncTree_,e),l=Kr(o,a,r),c=Mi(n),u=$r(n.serverSyncTree_,e,l,c,!0);Oi(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(d,p)=>{let _=d==="ok";_||K("set at "+e+" failed: "+d);let E=Ge(n.serverSyncTree_,c,!_);ae(n.eventQueue_,e,E),Xe(n,s,d,p)});let h=eo(n,e);Ot(n,h),ae(n.eventQueue_,h,[])}function Qd(n,e,t,i){jt(n,"update",{path:e.toString(),value:t});let s=!0,r=Nn(n),o={};if(G(t,(a,l)=>{s=!1,o[a]=ql(R(e,a),P(l),n.serverSyncTree_,r)}),s)H("update() called with empty data.  Don't do anything."),Xe(n,i,"ok",void 0);else{let a=Mi(n),l=bd(n.serverSyncTree_,e,o,a);Oi(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,u)=>{let h=c==="ok";h||K("update at "+e+" failed: "+c);let d=Ge(n.serverSyncTree_,a,!h),p=d.length>0?Ot(n,e):e;ae(n.eventQueue_,p,d),Xe(n,i,c,u)}),G(t,c=>{let u=eo(n,R(e,c));Ot(n,u)}),ae(n.eventQueue_,e,[])}}function Xd(n){jt(n,"onDisconnectEvents");let e=Nn(n),t=ai();Ys(n.onDisconnect_,T(),(s,r)=>{let o=ql(s,r,n.serverSyncTree_,e);Lt(t,s,o)});let i=[];Ys(t,T(),(s,r)=>{i=i.concat(kn(n.serverSyncTree_,s,r));let o=eo(n,s);Ot(n,o)}),n.onDisconnect_=ai(),ae(n.eventQueue_,T(),i)}function Jd(n,e,t){n.server_.onDisconnectCancel(e.toString(),(i,s)=>{i==="ok"&&zs(n.onDisconnect_,e),Xe(n,t,i,s)})}function Ja(n,e,t,i){let s=P(t);n.server_.onDisconnectPut(e.toString(),s.val(!0),(r,o)=>{r==="ok"&&Lt(n.onDisconnect_,e,s),Xe(n,i,r,o)})}function Zd(n,e,t,i,s){let r=P(t,i);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&Lt(n.onDisconnect_,e,r),Xe(n,s,o,a)})}function ef(n,e,t,i){if(Gn(t)){H("onDisconnect().update() called with empty data.  Don't do anything."),Xe(n,i,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(s,r)=>{s==="ok"&&G(t,(o,a)=>{let l=P(a);Lt(n.onDisconnect_,R(e,o),l)}),Xe(n,i,s,r)})}function tf(n,e,t){let i;y(e._path)===".info"?i=lr(n.infoSyncTree_,e,t):i=lr(n.serverSyncTree_,e,t),Jl(n.eventQueue_,e._path,i)}function pr(n,e,t){let i;y(e._path)===".info"?i=mi(n.infoSyncTree_,e,t):i=mi(n.serverSyncTree_,e,t),Jl(n.eventQueue_,e._path,i)}function nc(n){n.persistentConnection_&&n.persistentConnection_.interrupt(ec)}function nf(n){n.persistentConnection_&&n.persistentConnection_.resume(ec)}function jt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),H(t,...e)}function Xe(n,e,t,i){e&&Ft(()=>{if(t==="ok")e(null);else{let s=(t||"error").toUpperCase(),r=s;i&&(r+=": "+i);let o=new Error(r);o.code=s,e(o)}})}function sf(n,e,t,i,s,r){jt(n,"transaction on "+e);let o={path:e,update:t,onComplete:i,status:null,order:tl(),applyLocally:r,retryCount:0,unwatcher:s,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Zr(n,e,void 0);o.currentInputSnapshot=a;let l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{Rn("transaction failed: Data returned ",l,o.path),o.status=0;let c=Ni(n.transactionQueueTree_,e),u=ct(c)||[];u.push(o),Yr(c,u);let h;typeof l=="object"&&l!==null&&fe(l,".priority")?(h=Be(l,".priority"),f(En(h),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):h=(Ri(n.serverSyncTree_,e)||m.EMPTY_NODE).getPriority().val();let d=Nn(n),p=P(l,h),_=Kr(p,a,d);o.currentOutputSnapshotRaw=p,o.currentOutputSnapshotResolved=_,o.currentWriteId=Mi(n);let E=$r(n.serverSyncTree_,e,_,o.currentWriteId,o.applyLocally);ae(n.eventQueue_,e,E),Fi(n,n.transactionQueueTree_)}}function Zr(n,e,t){return Ri(n.serverSyncTree_,e,t)||m.EMPTY_NODE}function Fi(n,e=n.transactionQueueTree_){if(e||Li(n,e),ct(e)){let t=sc(n,e);f(t.length>0,"Sending zero length transaction queue"),t.every(s=>s.status===0)&&rf(n,An(e),t)}else Kl(e)&&xi(e,t=>{Fi(n,t)})}function rf(n,e,t){let i=t.map(c=>c.currentWriteId),s=Zr(n,e,i),r=s,o=s.hash();for(let c=0;c<t.length;c++){let u=t[c];f(u.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;let h=J(e,u.path);r=r.updateChild(h,u.currentOutputSnapshotRaw)}let a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{jt(n,"transaction put response",{path:l.toString(),status:c});let u=[];if(c==="ok"){let h=[];for(let d=0;d<t.length;d++)t[d].status=2,u=u.concat(Ge(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&h.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();Li(n,Ni(n.transactionQueueTree_,e)),Fi(n,n.transactionQueueTree_),ae(n.eventQueue_,e,u);for(let d=0;d<h.length;d++)Ft(h[d])}else{if(c==="datastale")for(let h=0;h<t.length;h++)t[h].status===3?t[h].status=4:t[h].status=0;else{K("transaction at "+l.toString()+" failed: "+c);for(let h=0;h<t.length;h++)t[h].status=4,t[h].abortReason=c}Ot(n,e)}},o)}function Ot(n,e){let t=ic(n,e),i=An(t),s=sc(n,t);return of(n,s,i),i}function of(n,e,t){if(e.length===0)return;let i=[],s=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let l=e[a],c=J(t,l.path),u=!1,h;if(f(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)u=!0,h=l.abortReason,s=s.concat(Ge(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=qd)u=!0,h="maxretry",s=s.concat(Ge(n.serverSyncTree_,l.currentWriteId,!0));else{let d=Zr(n,l.path,o);l.currentInputSnapshot=d;let p=e[a].update(d.val());if(p!==void 0){Rn("transaction failed: Data returned ",p,l.path);let _=P(p);typeof p=="object"&&p!=null&&fe(p,".priority")||(_=_.updatePriority(d.getPriority()));let I=l.currentWriteId,ne=Nn(n),ie=Kr(_,d,ne);l.currentOutputSnapshotRaw=_,l.currentOutputSnapshotResolved=ie,l.currentWriteId=Mi(n),o.splice(o.indexOf(I),1),s=s.concat($r(n.serverSyncTree_,l.path,ie,l.currentWriteId,l.applyLocally)),s=s.concat(Ge(n.serverSyncTree_,I,!0))}else u=!0,h="nodata",s=s.concat(Ge(n.serverSyncTree_,l.currentWriteId,!0))}ae(n.eventQueue_,t,s),s=[],u&&(e[a].status=2,(function(d){setTimeout(d,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(h==="nodata"?i.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):i.push(()=>e[a].onComplete(new Error(h),!1,null))))}Li(n,n.transactionQueueTree_);for(let a=0;a<i.length;a++)Ft(i[a]);Fi(n,n.transactionQueueTree_)}function ic(n,e){let t,i=n.transactionQueueTree_;for(t=y(e);t!==null&&ct(i)===void 0;)i=Ni(i,t),e=S(e),t=y(e);return i}function sc(n,e){let t=[];return rc(n,e,t),t.sort((i,s)=>i.order-s.order),t}function rc(n,e,t){let i=ct(e);if(i)for(let s=0;s<i.length;s++)t.push(i[s]);xi(e,s=>{rc(n,s,t)})}function Li(n,e){let t=ct(e);if(t){let i=0;for(let s=0;s<t.length;s++)t[s].status!==2&&(t[i]=t[s],i++);t.length=i,Yr(e,t.length>0?t:void 0)}xi(e,i=>{Li(n,i)})}function eo(n,e){let t=An(ic(n,e)),i=Ni(n.transactionQueueTree_,e);return Wd(i,s=>{Ts(n,s)}),Ts(n,i),zl(i,s=>{Ts(n,s)}),t}function Ts(n,e){let t=ct(e);if(t){let i=[],s=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(f(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(f(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),s=s.concat(Ge(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&i.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Yr(e,void 0):t.length=r+1,ae(n.eventQueue_,An(e),s);for(let o=0;o<i.length;o++)Ft(i[o])}}function af(n){let e="",t=n.split("/");for(let i=0;i<t.length;i++)if(t[i].length>0){let s=t[i];try{s=decodeURIComponent(s.replace(/\+/g," "))}catch{}e+="/"+s}return e}function lf(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let i=t.split("=");i.length===2?e[decodeURIComponent(i[0])]=decodeURIComponent(i[1]):K(`Invalid query segment '${t}' in query '${n}'`)}return e}var _r=function(n,e){let t=cf(n),i=t.namespace;t.domain==="firebase.com"&&Re(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!i||i==="undefined")&&t.domain!=="localhost"&&Re("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Wu();let s=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Zn(t.host,t.secure,i,s,e,"",i!==t.subdomain),path:new b(t.pathString)}},cf=function(n){let e="",t="",i="",s="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let u=n.indexOf("/");u===-1&&(u=n.length);let h=n.indexOf("?");h===-1&&(h=n.length),e=n.substring(0,Math.min(u,h)),u<h&&(s=af(n.substring(u,h)));let d=lf(n.substring(Math.min(n.length,h)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;let p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{let _=e.indexOf(".");i=e.substring(0,_).toLowerCase(),t=e.substring(_+1),r=i}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:t,subdomain:i,secure:o,scheme:a,pathString:s,namespace:r}};var Za="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",uf=(function(){let n=0,e=[];return function(t){let i=t===n;n=t;let s,r=new Array(8);for(s=7;s>=0;s--)r[s]=Za.charAt(t%64),t=Math.floor(t/64);f(t===0,"Cannot push at time == 0");let o=r.join("");if(i){for(s=11;s>=0&&e[s]===63;s--)e[s]=0;e[s]++}else for(s=0;s<12;s++)e[s]=Math.floor(Math.random()*64);for(s=0;s<12;s++)o+=Za.charAt(e[s]);return f(o.length===20,"nextPushId: Length should be 20."),o}})();var yi=class{constructor(e,t,i,s){this.eventType=e,this.eventRegistration=t,this.snapshot=i,this.prevName=s}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+O(this.snapshot.exportVal())}},vi=class{constructor(e,t,i){this.eventRegistration=e,this.error=t,this.path=i}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var Cn=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return f(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var wi=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new $;return Jd(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){oe("OnDisconnect.remove",this._path);let e=new $;return Ja(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){oe("OnDisconnect.set",this._path),Ne("OnDisconnect.set",e,this._path,!1);let t=new $;return Ja(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){oe("OnDisconnect.setWithPriority",this._path),Ne("OnDisconnect.setWithPriority",e,this._path,!1),Qr("OnDisconnect.setWithPriority",t,!1);let i=new $;return Zd(this._repo,this._path,e,t,i.wrapCallback(()=>{})),i.promise}update(e){oe("OnDisconnect.update",this._path),Ql("OnDisconnect.update",e,this._path,!1);let t=new $;return ef(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var ee=class n{constructor(e,t,i,s){this._repo=e,this._path=t,this._queryParams=i,this._orderByCalled=s}get key(){return v(this._path)?null:xr(this._path)}get ref(){return new le(this._repo,this._path)}get _queryIdentifier(){let e=Ua(this._queryParams),t=Pr(e);return t==="{}"?"default":t}get _queryObject(){return Ua(this._queryParams)}isEqual(e){if(e=Q(e),!(e instanceof n))return!1;let t=this._repo===e._repo,i=Dr(this._path,e._path),s=this._queryIdentifier===e._queryIdentifier;return t&&i&&s}toJSON(){return this.toString()}toString(){return this._repo.toString()+gh(this._path)}};function Wi(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Ze(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Ae){let i="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",s="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==ze)throw new Error(i);if(typeof e!="string")throw new Error(s)}if(n.hasEnd()){if(n.getIndexEndName()!==Me)throw new Error(i);if(typeof t!="string")throw new Error(s)}}else if(n.getIndex()===k){if(e!=null&&!En(e)||t!=null&&!En(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(f(n.getIndex()instanceof dn||n.getIndex()===Fr,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Ui(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var le=class n extends ee{constructor(e,t){super(e,t,new gn,!1)}get parent(){let e=Cl(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},Mt=class n{constructor(e,t,i){this._node=e,this.ref=t,this._index=i}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new b(e),i=Je(this.ref,e);return new n(this._node.getChild(t),i,k)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(i,s)=>e(new n(s,Je(this.ref,i),k)))}hasChild(e){let t=new b(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function to(n,e){return n=Q(n),n._checkNotDeleted("ref"),e!==void 0?Je(n._root,e):n._root}function no(n,e){n=Q(n),n._checkNotDeleted("refFromURL");let t=_r(e,n._repo.repoInfo_.nodeAdmin);Xl("refFromURL",t);let i=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&i.host!==n._repo.repoInfo_.host&&Re("refFromURL: Host name does not match the current database: (found "+i.host+" but expected "+n._repo.repoInfo_.host+")"),to(n,t.path.toString())}function Je(n,e){return n=Q(n),y(n._path)===null?Hd("child","path",e,!1):Ut("child","path",e,!1),new le(n._repo,R(n._path,e))}function oc(n,e){n=Q(n),oe("push",n._path),Ne("push",e,n._path,!0);let t=tc(n._repo),i=uf(t),s=Je(n,i),r=Je(n,i),o;return e!=null?o=ji(r,e).then(()=>r):o=Promise.resolve(r),s.then=o.then.bind(o),s.catch=o.then.bind(o,void 0),s}function ac(n){return oe("remove",n._path),ji(n,null)}function ji(n,e){n=Q(n),oe("set",n._path),Ne("set",e,n._path,!1);let t=new $;return Jr(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function lc(n,e){n=Q(n),oe("setPriority",n._path),Qr("setPriority",e,!1);let t=new $;return Jr(n._repo,R(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function cc(n,e,t){if(oe("setWithPriority",n._path),Ne("setWithPriority",e,n._path,!1),Qr("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let i=new $;return Jr(n._repo,n._path,e,t,i.wrapCallback(()=>{})),i.promise}function uc(n,e){Ql("update",e,n._path,!1);let t=new $;return Qd(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function hc(n){n=Q(n);let e=new Cn(()=>{}),t=new Tn(e);return Yd(n._repo,n,t).then(i=>new Mt(i,new le(n._repo,n._path),n._queryParams.getIndex()))}var Tn=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let i=t._queryParams.getIndex();return new yi("value",this,new Mt(e.snapshotNode,new le(t._repo,t._path),i))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new vi(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},Ei=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new vi(this,e,t):null}createEvent(e,t){f(e.childName!=null,"Child events should have a childName.");let i=Je(new le(t._repo,t._path),e.childName),s=t._queryParams.getIndex();return new yi(e.type,this,new Mt(e.snapshotNode,i,s),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function xn(n,e,t,i,s){let r;if(typeof i=="object"&&(r=void 0,s=i),typeof i=="function"&&(r=i),s&&s.onlyOnce){let l=t,c=(u,h)=>{pr(n._repo,n,a),l(u,h)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new Cn(t,r||void 0),a=e==="value"?new Tn(o):new Ei(e,o);return tf(n._repo,n,a),()=>pr(n._repo,n,a)}function Bi(n,e,t,i){return xn(n,"value",e,t,i)}function io(n,e,t,i){return xn(n,"child_added",e,t,i)}function so(n,e,t,i){return xn(n,"child_changed",e,t,i)}function ro(n,e,t,i){return xn(n,"child_moved",e,t,i)}function oo(n,e,t,i){return xn(n,"child_removed",e,t,i)}function ao(n,e,t){let i=null,s=t?new Cn(t):null;e==="value"?i=new Tn(s):e&&(i=new Ei(e,s)),pr(n._repo,n,i)}var ce=class{},Ci=class extends ce{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Ne("endAt",this._value,e._path,!0);let t=Gs(e._queryParams,this._value,this._key);if(Ui(t),Ze(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new ee(e._repo,e._path,t,e._orderByCalled)}};function dc(n,e){return Pn("endAt","key",e,!0),new Ci(n,e)}var gr=class extends ce{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Ne("endBefore",this._value,e._path,!1);let t=Mh(e._queryParams,this._value,this._key);if(Ui(t),Ze(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new ee(e._repo,e._path,t,e._orderByCalled)}};function fc(n,e){return Pn("endBefore","key",e,!0),new gr(n,e)}var Ti=class extends ce{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Ne("startAt",this._value,e._path,!0);let t=Hs(e._queryParams,this._value,this._key);if(Ui(t),Ze(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new ee(e._repo,e._path,t,e._orderByCalled)}};function pc(n=null,e){return Pn("startAt","key",e,!0),new Ti(n,e)}var mr=class extends ce{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Ne("startAfter",this._value,e._path,!1);let t=Oh(e._queryParams,this._value,this._key);if(Ui(t),Ze(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new ee(e._repo,e._path,t,e._orderByCalled)}};function _c(n,e){return Pn("startAfter","key",e,!0),new mr(n,e)}var yr=class extends ce{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new ee(e._repo,e._path,xh(e._queryParams,this._limit),e._orderByCalled)}};function gc(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new yr(n)}var vr=class extends ce{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new ee(e._repo,e._path,Dh(e._queryParams,this._limit),e._orderByCalled)}};function mc(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new vr(n)}var wr=class extends ce{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Wi(e,"orderByChild");let t=new b(this._path);if(v(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let i=new dn(t),s=Ii(e._queryParams,i);return Ze(s),new ee(e._repo,e._path,s,!0)}};function yc(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return Ut("orderByChild","path",n,!1),new wr(n)}var Er=class extends ce{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Wi(e,"orderByKey");let t=Ii(e._queryParams,Ae);return Ze(t),new ee(e._repo,e._path,t,!0)}};function vc(){return new Er}var Cr=class extends ce{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Wi(e,"orderByPriority");let t=Ii(e._queryParams,k);return Ze(t),new ee(e._repo,e._path,t,!0)}};function wc(){return new Cr}var Tr=class extends ce{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Wi(e,"orderByValue");let t=Ii(e._queryParams,Fr);return Ze(t),new ee(e._repo,e._path,t,!0)}};function Ec(){return new Tr}var br=class extends ce{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Ne("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new Ci(this._value,this._key)._apply(new Ti(this._value,this._key)._apply(e))}};function Cc(n,e){return Pn("equalTo","key",e,!0),new br(n,e)}function ge(n,...e){let t=Q(n);for(let i of e)t=i._apply(t);return t}gd(le);Ed(le);var hf="FIREBASE_DATABASE_EMULATOR_HOST",Ir={},df=!1;function ff(n,e,t,i){let s=e.lastIndexOf(":"),r=e.substring(0,s),o=Zi(r);n.repoInfo_=new Zn(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),i&&(n.authTokenProvider_=i)}function lo(n,e,t,i,s){let r=i||n.options.databaseURL;r===void 0&&(n.options.projectId||Re("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),H("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=_r(r,s),a=o.repoInfo,l,c;typeof process<"u"&&process.env&&(c=process.env[hf]),c?(l=!0,r=`http://${c}?ns=${a.namespace}`,o=_r(r,s),a=o.repoInfo):l=!o.repoInfo.secure;let u=s&&l?new on(on.OWNER):new Rs(n.name,n.options,e);Xl("Invalid Firebase Database URL",o),v(o.path)||Re("Database URL must point to the root of a Firebase Database (not including a child path).");let h=_f(a,n,u,new As(n,t));return new Sr(h,n)}function pf(n,e){let t=Ir[e];(!t||t[n.key]!==n)&&Re(`Database ${e}(${n.repoInfo_}) has already been deleted.`),nc(n),delete t[n.key]}function _f(n,e,t,i){let s=Ir[e.name];s||(s={},Ir[e.name]=s);let r=s[n.toURLString()];return r&&Re("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new fr(n,df,t,i),s[n.toURLString()]=r,r}var Sr=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Kd(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new le(this._repo,T())),this._rootInternal}_delete(){return this._rootInternal!==null&&(pf(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Re("Cannot call "+e+" on a deleted database.")}};function Tc(){El.IS_TRANSPORT_INITIALIZED&&K("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function bc(){Tc(),un.forceDisallow()}function Ic(){Tc(),It.forceDisallow(),un.forceAllow()}function Sc(n,e,t,i={}){n=Q(n),n._checkNotDeleted("useEmulator");let s=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(s===n._repoInternal.repoInfo_.host&&Qo(i,r.repoInfo_.emulatorOptions))return;Re("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)i.mockUserToken&&Re('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new on(on.OWNER);else if(i.mockUserToken){let a=typeof i.mockUserToken=="string"?i.mockUserToken:$o(i.mockUserToken,n.app.options.projectId);o=new on(a)}Zi(e)&&(Vo(e),Ho("Database",!0)),ff(r,s,i,o)}function kc(n){n=Q(n),n._checkNotDeleted("goOffline"),nc(n._repo)}function Ac(n){n=Q(n),n._checkNotDeleted("goOnline"),nf(n._repo)}function Rc(n,e){il(n,e)}function gf(n){Rr(na),zt(new De("database",(e,{instanceIdentifier:t})=>{let i=e.getProvider("app").getImmediate(),s=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return lo(i,s,r,t)},"PUBLIC").setMultipleInstances(!0)),Ve(Ca,Ta,n),Ve(Ca,Ta,"esm2017")}var mf={".sv":"timestamp"};function Pc(){return mf}function Nc(n){return{".sv":{increment:n}}}var kr=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function xc(n,e,t){var i;if(n=Q(n),oe("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let s=(i=t?.applyLocally)!==null&&i!==void 0?i:!0,r=new $,o=(l,c,u)=>{let h=null;l?r.reject(l):(h=new Mt(u,new le(n._repo,n._path),k),r.resolve(new kr(c,h)))},a=Bi(n,()=>{});return sf(n._repo,n._path,e,o,a,s),r.promise}Or.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Or.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};gf();var yf="@firebase/database-compat",vf="2.0.11";var wf=new wt("@firebase/database-compat"),Dc=function(n){let e="FIREBASE WARNING: "+n;wf.warn(e)};var Ef=function(n,e,t,i){if(!(i&&t===void 0)&&typeof t!="boolean")throw new Error(te(n,e)+"must be a boolean.")},Cf=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(te(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var co=class{constructor(e){this._delegate=e}cancel(e){g("OnDisconnect.cancel",0,1,arguments.length),j("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),i=>e(i)),t}remove(e){g("OnDisconnect.remove",0,1,arguments.length),j("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),i=>e(i)),t}set(e,t){g("OnDisconnect.set",1,2,arguments.length),j("OnDisconnect.set","onComplete",t,!0);let i=this._delegate.set(e);return t&&i.then(()=>t(null),s=>t(s)),i}setWithPriority(e,t,i){g("OnDisconnect.setWithPriority",2,3,arguments.length),j("OnDisconnect.setWithPriority","onComplete",i,!0);let s=this._delegate.setWithPriority(e,t);return i&&s.then(()=>i(null),r=>i(r)),s}update(e,t){if(g("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let s={};for(let r=0;r<e.length;++r)s[""+r]=e[r];e=s,Dc("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}j("OnDisconnect.update","onComplete",t,!0);let i=this._delegate.update(e);return t&&i.then(()=>t(null),s=>t(s)),i}};var uo=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return g("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var ut=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return g("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return g("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return g("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return g("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return g("DataSnapshot.child",0,1,arguments.length),e=String(e),Ut("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return g("DataSnapshot.hasChild",1,1,arguments.length),Ut("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return g("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return g("DataSnapshot.forEach",1,1,arguments.length),j("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return g("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return g("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return g("DataSnapshot.ref",0,0,arguments.length),new Fe(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Vi=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,i,s){var r;g("Query.on",2,4,arguments.length),j("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",i,s),a=(c,u)=>{t.call(o.context,new ut(this.database,c),u)};a.userCallback=t,a.context=o.context;let l=(r=o.cancel)===null||r===void 0?void 0:r.bind(o.context);switch(e){case"value":return Bi(this._delegate,a,l),t;case"child_added":return io(this._delegate,a,l),t;case"child_removed":return oo(this._delegate,a,l),t;case"child_changed":return so(this._delegate,a,l),t;case"child_moved":return ro(this._delegate,a,l),t;default:throw new Error(te("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,i){if(g("Query.off",0,3,arguments.length),Cf("Query.off",e,!0),j("Query.off","callback",t,!0),ts("Query.off","context",i,!0),t){let s=()=>{};s.userCallback=t,s.context=i,ao(this._delegate,e,s)}else ao(this._delegate,e)}get(){return hc(this._delegate).then(e=>new ut(this.database,e))}once(e,t,i,s){g("Query.once",1,4,arguments.length),j("Query.once","callback",t,!0);let r=n.getCancelAndContextArgs_("Query.once",i,s),o=new $,a=(c,u)=>{let h=new ut(this.database,c);t&&t.call(r.context,h,u),o.resolve(h)};a.userCallback=t,a.context=r.context;let l=c=>{r.cancel&&r.cancel.call(r.context,c),o.reject(c)};switch(e){case"value":Bi(this._delegate,a,l,{onlyOnce:!0});break;case"child_added":io(this._delegate,a,l,{onlyOnce:!0});break;case"child_removed":oo(this._delegate,a,l,{onlyOnce:!0});break;case"child_changed":so(this._delegate,a,l,{onlyOnce:!0});break;case"child_moved":ro(this._delegate,a,l,{onlyOnce:!0});break;default:throw new Error(te("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return g("Query.limitToFirst",1,1,arguments.length),new n(this.database,ge(this._delegate,gc(e)))}limitToLast(e){return g("Query.limitToLast",1,1,arguments.length),new n(this.database,ge(this._delegate,mc(e)))}orderByChild(e){return g("Query.orderByChild",1,1,arguments.length),new n(this.database,ge(this._delegate,yc(e)))}orderByKey(){return g("Query.orderByKey",0,0,arguments.length),new n(this.database,ge(this._delegate,vc()))}orderByPriority(){return g("Query.orderByPriority",0,0,arguments.length),new n(this.database,ge(this._delegate,wc()))}orderByValue(){return g("Query.orderByValue",0,0,arguments.length),new n(this.database,ge(this._delegate,Ec()))}startAt(e=null,t){return g("Query.startAt",0,2,arguments.length),new n(this.database,ge(this._delegate,pc(e,t)))}startAfter(e=null,t){return g("Query.startAfter",0,2,arguments.length),new n(this.database,ge(this._delegate,_c(e,t)))}endAt(e=null,t){return g("Query.endAt",0,2,arguments.length),new n(this.database,ge(this._delegate,dc(e,t)))}endBefore(e=null,t){return g("Query.endBefore",0,2,arguments.length),new n(this.database,ge(this._delegate,fc(e,t)))}equalTo(e,t){return g("Query.equalTo",1,2,arguments.length),new n(this.database,ge(this._delegate,Cc(e,t)))}toString(){return g("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return g("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(g("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,i){let s={cancel:void 0,context:void 0};if(t&&i)s.cancel=t,j(e,"cancel",s.cancel,!0),s.context=i,ts(e,"context",s.context,!0);else if(t)if(typeof t=="object"&&t!==null)s.context=t;else if(typeof t=="function")s.cancel=t;else throw new Error(te(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return s}get ref(){return new Fe(this.database,new le(this._delegate._repo,this._delegate._path))}},Fe=class n extends Vi{constructor(e,t){super(e,new ee(t._repo,t._path,new gn,!1)),this.database=e,this._delegate=t}getKey(){return g("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return g("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,Je(this._delegate,e))}getParent(){g("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return g("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){g("Reference.set",1,2,arguments.length),j("Reference.set","onComplete",t,!0);let i=ji(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}update(e,t){if(g("Reference.update",1,2,arguments.length),Array.isArray(e)){let s={};for(let r=0;r<e.length;++r)s[""+r]=e[r];e=s,Dc("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}oe("Reference.update",this._delegate._path),j("Reference.update","onComplete",t,!0);let i=uc(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}setWithPriority(e,t,i){g("Reference.setWithPriority",2,3,arguments.length),j("Reference.setWithPriority","onComplete",i,!0);let s=cc(this._delegate,e,t);return i&&s.then(()=>i(null),r=>i(r)),s}remove(e){g("Reference.remove",0,1,arguments.length),j("Reference.remove","onComplete",e,!0);let t=ac(this._delegate);return e&&t.then(()=>e(null),i=>e(i)),t}transaction(e,t,i){g("Reference.transaction",1,3,arguments.length),j("Reference.transaction","transactionUpdate",e,!1),j("Reference.transaction","onComplete",t,!0),Ef("Reference.transaction","applyLocally",i,!0);let s=xc(this._delegate,e,{applyLocally:i}).then(r=>new uo(r.committed,new ut(this.database,r.snapshot)));return t&&s.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),s}setPriority(e,t){g("Reference.setPriority",1,2,arguments.length),j("Reference.setPriority","onComplete",t,!0);let i=lc(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}push(e,t){g("Reference.push",0,2,arguments.length),j("Reference.push","onComplete",t,!0);let i=oc(this._delegate,e),s=i.then(o=>new n(this.database,o));t&&s.then(()=>t(null),o=>t(o));let r=new n(this.database,i);return r.then=s.then.bind(s),r.catch=s.catch.bind(s,void 0),r}onDisconnect(){return oe("Reference.onDisconnect",this._delegate._path),new co(new wi(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var ht=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:bc,forceLongPolling:Ic}}useEmulator(e,t,i={}){Sc(this._delegate,e,t,i)}ref(e){if(g("database.ref",0,1,arguments.length),e instanceof Fe){let t=no(this._delegate,e.toString());return new Fe(this,t)}else{let t=to(this._delegate,e);return new Fe(this,t)}}refFromURL(e){g("database.refFromURL",1,1,arguments.length);let i=no(this._delegate,e);return new Fe(this,i)}goOffline(){return g("database.goOffline",0,0,arguments.length),kc(this._delegate)}goOnline(){return g("database.goOnline",0,0,arguments.length),Ac(this._delegate)}};ht.ServerValue={TIMESTAMP:Pc(),increment:n=>Nc(n)};function Tf({app:n,url:e,version:t,customAuthImpl:i,customAppCheckImpl:s,namespace:r,nodeAdmin:o=!1}){Rr(t);let a=new ns("database-standalone"),l=new qn("auth-internal",a);l.setComponent(new De("auth-internal",()=>i,"PRIVATE"));let c;return s&&(c=new qn("app-check-internal",a),c.setComponent(new De("app-check-internal",()=>s,"PRIVATE"))),{instance:new ht(lo(n,l,c,e,o),n),namespace:r}}var bf=Object.freeze({__proto__:null,initStandalone:Tf});var If=ht.ServerValue;function Sf(n){n.INTERNAL.registerComponent(new De("database-compat",(e,{instanceIdentifier:t})=>{let i=e.getProvider("app-compat").getImmediate(),s=e.getProvider("database").getImmediate({identifier:t});return new ht(s,i)},"PUBLIC").setServiceProps({Reference:Fe,Query:Vi,Database:ht,DataSnapshot:ut,enableLogging:Rc,INTERNAL:bf,ServerValue:If}).setMultipleInstances(!0)),n.registerVersion(yf,vf)}Sf(N);function Dn(n,e,t="on",i=On){return new Le(s=>{let r=null;return r=n[t](e,(o,a)=>{i.schedule(()=>{s.next({snapshot:o,prevKey:a})}),t==="once"&&i.schedule(()=>s.complete())},o=>{i.schedule(()=>s.error(o))}),t==="on"?{unsubscribe(){r!=null&&n.off(e,r)}}:{unsubscribe(){}}}).pipe(M(s=>{let{snapshot:r,prevKey:o}=s,a=null;return r.exists()&&(a=r.key),{type:e,payload:r,prevKey:o,key:a}}),dt())}function kf(n){return typeof n=="string"}function Af(n){return typeof n.exportVal=="function"}function Wc(n){return n==null}function Uc(n){return typeof n.set=="function"}function Oc(n,e){return Uc(e)?e:n.ref(e)}function jc(n,e){if(kf(n))return e.stringCase();if(Uc(n))return e.firebaseCase();if(Af(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Bc(n){return(Wc(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Vc(n,e,t){e=Bc(e);let i=e.map(s=>Dn(n,s,"on",t));return $t(...i)}function Rf(n,e,t){let i=Vc(n,e).pipe(Ki((s,r)=>[...s,r],[]));return Nf(n,i,t)}function Pf(n,e){return Dn(n,"value","on",e).pipe(M(t=>{let i;return t.payload.forEach(s=>(i=s.key,!1)),{data:t,lastKeyToLoad:i}}))}function Nf(n,e,t){return Pf(n,t).pipe(wo(e),M(([s,r])=>{let o=s.lastKeyToLoad,a=r.map(l=>l.key);return{actions:r,lastKeyToLoad:o,loadedKeys:a}}),vo(s=>s.loadedKeys.indexOf(s.lastKeyToLoad)===-1),M(s=>s.actions))}function Mc(n,e){return function(i,s){return jc(i,{stringCase:()=>n.child(i)[e](s),firebaseCase:()=>i[e](s),snapshotCase:()=>i.ref[e](s)})}}function xf(n){return function(t){return t?jc(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function Df(n,e,t){return Dn(n,"value","once",t).pipe(L(i=>{let s=[z(i)];return e.forEach(r=>s.push(Dn(n,r,"on",t))),$t(...s).pipe(Ki(Mf,[]))}),mo())}function $c(n,e){let t=n.length;for(let i=0;i<t;i++)if(n[i].payload.key===e)return i;return-1}function Of(n,e){if(Wc(e))return 0;{let t=$c(n,e);return t===-1?n.length:t+1}}function Mf(n,e){let{payload:t,prevKey:i,key:s}=e,r=$c(n,s),o=Of(n,i);switch(e.type){case"value":if(e.payload?.exists()){let a=null;e.payload.forEach(l=>{let c={payload:l,type:"value",prevKey:a,key:l.key};return a=l.key,n=[...n,c],!1})}return n;case"child_added":if(r>-1)(n[r-1]?.key||null)!==i&&(n=n.filter(l=>l.payload.key!==t.key),n.splice(o,0,e));else{if(i==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==t.key);case"child_changed":return n.map(a=>a.payload.key===s?e:a);case"child_moved":if(r>-1){let a=n.splice(r,1)[0];return n=n.slice(),n.splice(o,0,a),n}return n;default:return n}}function Fc(n,e,t){return e=Bc(e),Df(n,e,t)}function Ff(n,e,t){let i=e.schedulers.outsideAngular,s=he(re).run(()=>n.ref);return{query:n,update:Mc(s,"update"),set:Mc(s,"set"),push:r=>s.push(r),remove:xf(s),snapshotChanges(r){return Fc(n,r,i).pipe(Oe(t))},stateChanges(r){return Vc(n,r,i).pipe(Oe(t))},auditTrail(r){return Rf(n,r,i).pipe(Oe(t))},valueChanges(r,o){return Fc(n,r,i).pipe(M(l=>l.map(c=>o&&o.idField?qi(Gi({},c.payload.val()),{[o.idField]:c.key}):c.payload.val())),Oe(t))}}}function Lc(n,e){return function(){return Dn(n,"value","on",e)}}function Lf(n,e,t){return{query:n,snapshotChanges(){return Lc(n,e.schedulers.outsideAngular)().pipe(Oe(t))},update(i){return n.ref.update(i)},set(i){return n.ref.set(i)},remove(){return n.ref.remove()},valueChanges(){return Lc(n,e.schedulers.outsideAngular)().pipe(Oe(t),M(s=>s.payload.exists()?s.payload.val():null))}}}var Wf=new se("angularfire2.realtimeDatabaseURL"),Uf=new se("angularfire2.database.use-emulator"),ho=(()=>{class n{schedulers;database;injector=he(Ht);constructor(t,i,s,r,o,a,l,c,u,h,d,p,_,E,I){this.schedulers=a;let ne=l,ie=Qt(t,o,i);c&&gs(ie,o,u,d,p,_,h,E),this.database=Yn(`${ie.name}.database.${s}`,"AngularFireDatabase",ie.name,()=>{let A=o.runOutsideAngular(()=>ie.database(s||void 0));return ne&&A.useEmulator(...ne),A},[ne])}list(t,i){let s=he(re).runOutsideAngular(()=>Oc(this.database,t)),r=s;return i&&(r=i(s)),Ff(r,this,this.injector)}object(t){let i=he(re).runOutsideAngular(()=>Oc(this.database,t));return Lf(i,this,this.injector)}createPushId(){return he(re).runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(i){return new(i||n)(C(Et),C(Ct,8),C(Wf,8),C(_t),C(re),C(Yt),C(Uf,8),C(Zt,8),C(us,8),C(hs,8),C(ds,8),C(fs,8),C(ps,8),C(_s,8),C(Tt,8))};static \u0275prov=V({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),Hc=(()=>{class n{constructor(){N.registerVersion("angularfire",$e.full,"rtdb-compat")}static \u0275fac=function(i){return new(i||n)};static \u0275mod=de({type:n});static \u0275inj=ue({providers:[ho]})}return n})();var et=(()=>{let e=class e extends xo{constructor(i){super(),this.afAuth=i}logout(){let i="logout";return B(this.afAuth.signOut()).pipe(M(()=>new Ie(!0,null,this.getOption(`${i}.redirect.success`),[],this.getOption(`${i}.defaultMessages`))),F(s=>this.processFailure(s,i)))}register(i){throw new Error(`'register' is not supported by '${this.constructor.name}', use 'authenticate'.`)}requestPassword(i){throw new Error(`'requestPassword' is not supported by '${this.constructor.name}', use 'authenticate'.`)}resetPassword(i={}){throw new Error(`'resetPassword' is not supported by '${this.constructor.name}', use 'authenticate'.`)}refreshToken(i={}){throw new Error(`'refreshToken' is not supported by '${this.constructor.name}', use 'authenticate'.`)}processFailure(i,s){let r=[];return i instanceof No?r.push(i.message):r.push(this.getOption("errors.getter")(s,i,this.options)),z(new Ie(!1,i,this.getOption(`${s}.redirect.failure`),r,[]))}processSuccess(i,s){return this.afAuth.idToken.pipe(M(r=>new Ie(!0,i,this.getOption(`${s}.redirect.success`),[],this.getOption("messages.getter")(s,i,this.options),this.createToken(r))))}};e.\u0275fac=function(s){return new(s||e)(C(Zt))},e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var fo=class extends Vn{constructor(){super(...arguments),this.token={class:jn},this.register={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully registered."]},this.login={redirect:{success:"/",failure:null},defaultErrors:["Login/Email combination is not correct, please try again."],defaultMessages:["You have been successfully logged in."]},this.logout={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully logged out."]},this.refreshToken={redirect:{success:null,failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Your token has been successfully refreshed."]},this.requestPassword={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Reset password instructions have been sent to your email."]},this.resetPassword={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Your password has been successfully changed."]},this.errors={key:"message",getter:(e,t,i)=>Ji(t,i.errors.key,i[e].defaultErrors)},this.messages={key:"messages",getter:(e,t,i)=>Ji(t.body,i.messages.key,i[e].defaultMessages)}}},Gc=new fo;var $i=(()=>{let e=class e extends et{constructor(){super(...arguments),this.defaultOptions=Gc}static setup(i){return[e,i]}authenticate({email:i,password:s}){let r="login";return B(this.afAuth.signInWithEmailAndPassword(i,s)).pipe(L(o=>this.processSuccess(o,r)),F(o=>this.processFailure(o,r)))}refreshToken(i){let s="refreshToken";return this.afAuth.authState.pipe(We(1),L(r=>r==null?z(new Ie(!1,null,this.getOption(`${s}.redirect.failure`),["There is no logged in user so refresh of id token isn't possible"])):this.refreshIdToken(r,s)))}register({email:i,password:s}){let r="register";return B(this.afAuth.createUserWithEmailAndPassword(i,s)).pipe(L(o=>this.processSuccess(o,r)),F(o=>this.processFailure(o,r)))}requestPassword({email:i}){let s="requestPassword";return B(this.afAuth.sendPasswordResetEmail(i)).pipe(M(()=>new Ie(!0,null,this.getOption(`${s}.redirect.success`),[],this.getOption(`${s}.defaultMessages`))),F(r=>this.processFailure(r,s)))}resetPassword({code:i,password:s}){let r="resetPassword";return B(this.afAuth.confirmPasswordReset(i,s)).pipe(M(()=>new Ie(!0,null,this.getOption(`${r}.redirect.success`),[],this.getOption(`${r}.defaultMessages`))),F(o=>this.processFailure(o,r)))}updatePassword(i,s,r){return B(i.updatePassword(s)).pipe(M(o=>new Ie(!0,null,this.getOption(`${r}.redirect.success`),[],this.getOption(`${r}.defaultMessages`),this.createToken(o))),F(o=>this.processFailure(o,r)))}refreshIdToken(i,s){return B(i.getIdToken(!0)).pipe(M(r=>new Ie(!0,null,this.getOption(`${s}.redirect.success`),[],this.getOption(`${s}.defaultMessages`),this.createToken(r))),F(r=>this.processFailure(r,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Ue(e)))(r||e)}})(),e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var tt=class extends Vn{constructor(){super(...arguments),this.token={class:jn},this.logout={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully logged out."]},this.authenticate={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully authenticated."]},this.errors={key:"message",getter:(e,t,i)=>i[e].defaultErrors},this.messages={key:"message",getter:(e,t,i)=>i[e].defaultMessages},this.scopes=[],this.customParameters={}}};var Hi=(()=>{let e=class e extends et{constructor(){super(...arguments),this.defaultOptions=new tt}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new N.auth.GoogleAuthProvider;return this.getOption("scopes").forEach(a=>r.addScope(a)),r.setCustomParameters(this.getOption("customParameters")),B(this.afAuth.signInWithPopup(r)).pipe(L(a=>this.processSuccess(a,s)),F(a=>this.processFailure(a,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Ue(e)))(r||e)}})(),e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var qc=(()=>{let e=class e extends et{constructor(){super(...arguments),this.defaultOptions=new tt}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new N.auth.FacebookAuthProvider;return this.getOption("scopes").forEach(a=>r.addScope(a)),r.setCustomParameters(this.getOption("customParameters")),B(this.afAuth.signInWithPopup(r)).pipe(L(a=>this.processSuccess(a,s)),F(a=>this.processFailure(a,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Ue(e)))(r||e)}})(),e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var Kc=(()=>{let e=class e extends et{constructor(){super(...arguments),this.defaultOptions=new tt}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new N.auth.TwitterAuthProvider;return r.setCustomParameters(this.getOption("customParameters")),B(this.afAuth.signInWithPopup(r)).pipe(L(o=>this.processSuccess(o,s)),F(o=>this.processFailure(o,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Ue(e)))(r||e)}})(),e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var zc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=de({type:e}),e.\u0275inj=ue({providers:[$i,Hi,qc,Kc]});let n=e;return n})();var Bt=(()=>{let e=class e{constructor(i){this.db=i}getGreeting(){return this.db.object("/greeting/").valueChanges()}};e.\u0275fac=function(s){return new(s||e)(C(ho))},e.\u0275prov=V({token:e,factory:e.\u0275fac});let n=e;return n})();var Qc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275cmp=gt({type:e,selectors:[["nb-firebase-playground"]],standalone:!1,decls:1,vars:0,template:function(s,r){s&1&&Io(0,"router-outlet")},dependencies:[Ro],encapsulation:2});let n=e;return n})();function Hf(n,e){if(n&1&&(W(0,"div"),U(1," Current User Token: "),W(2,"pre"),U(3),x(4,"async"),x(5,"json"),Y()()),n&2){let t=be();q(3),yt(" ",D(5,3,D(4,1,t.userToken$))," ")}}function Gf(n,e){if(n&1&&(W(0,"div"),U(1," Data from backend "),W(2,"pre"),U(3),x(4,"async"),x(5,"json"),Y()()),n&2){let t=be();q(3),Fn(D(5,3,D(4,1,t.data$)))}}function qf(n,e){if(n&1){let t=mt();W(0,"button",2),xe("click",function(){ft(t);let s=be();return pt(s.logout())}),U(1,` Logout
`),Y()}}function Kf(n,e){if(n&1){let t=mt();W(0,"button",2),xe("click",function(){ft(t);let s=be();return pt(s.login())}),U(1,` Login
`),Y()}}var Xc=(()=>{let e=class e{constructor(i,s,r,o){this.authService=i,this.router=s,this.firebaseApi=r,this.route=o,this.userToken$=this.authService.onTokenChange(),this.isAuthenticated$=this.authService.isAuthenticated()}logout(){this.router.navigate(["../logout"],{relativeTo:this.route})}login(){this.router.navigate(["../login"],{relativeTo:this.route})}resetPassword(){this.router.navigate(["../reset-password"],{relativeTo:this.route})}getData(){this.data$=this.firebaseApi.getGreeting().pipe(We(1),F(i=>z(i)),dt())}};e.\u0275fac=function(s){return new(s||e)(je(Bn),je(Po),je(Bt),je(Ao))},e.\u0275cmp=gt({type:e,selectors:[["nb-password-auth-showcase"]],standalone:!1,decls:15,vars:15,consts:[[4,"ngIf"],[3,"click",4,"ngIf"],[3,"click"]],template:function(s,r){s&1&&(W(0,"div"),U(1),x(2,"async"),Y(),Ce(3,Hf,6,5,"div",0),x(4,"async"),Ce(5,Gf,6,5,"div",0),x(6,"async"),Ce(7,qf,2,0,"button",1),x(8,"async"),Ce(9,Kf,2,0,"button",1),x(10,"async"),W(11,"button",2),xe("click",function(){return r.resetPassword()}),U(12,"Reset password"),Y(),W(13,"button",2),xe("click",function(){return r.getData()}),U(14,"Get data from Firebase"),Y()),s&2&&(q(),yt("Authenticated: ",D(2,5,r.isAuthenticated$)),q(2),Te("ngIf",D(4,7,r.isAuthenticated$)),q(2),Te("ngIf",D(6,9,r.data$)),q(2),Te("ngIf",D(8,11,r.isAuthenticated$)),q(2),Te("ngIf",D(10,13,r.isAuthenticated$)===!1))},dependencies:[Ln,Wn,Un],encapsulation:2});let n=e;return n})();function zf(n,e){if(n&1&&(W(0,"div"),U(1," Current User Token: "),W(2,"pre"),U(3),x(4,"async"),x(5,"json"),Y()()),n&2){let t=be();q(3),yt(" ",D(5,3,D(4,1,t.userToken$))," ")}}function Yf(n,e){if(n&1&&(W(0,"div"),U(1," Data from backend "),W(2,"pre"),U(3),x(4,"async"),x(5,"json"),Y()()),n&2){let t=be();q(3),Fn(D(5,3,D(4,1,t.data$)))}}function Qf(n,e){if(n&1){let t=mt();W(0,"button",2),xe("click",function(){ft(t);let s=be();return pt(s.logout())}),U(1,` Logout
`),Y()}}function Xf(n,e){if(n&1){let t=mt();W(0,"button",2),xe("click",function(){ft(t);let s=be();return pt(s.loginWithGoogle())}),U(1,` Login with google
`),Y()}}var Jc=(()=>{let e=class e{constructor(i,s){this.firebaseApi=i,this.authService=s,this.userToken$=this.authService.onTokenChange(),this.isAuthenticated$=this.authService.onAuthenticationChange()}logout(){this.authService.logout("google").pipe(We(1)).subscribe(i=>{})}loginWithGoogle(){this.authService.authenticate("google").pipe(We(1)).subscribe(i=>{})}getData(){this.data$=this.firebaseApi.getGreeting().pipe(We(1),F(i=>z(i)),dt())}};e.\u0275fac=function(s){return new(s||e)(je(Bt),je(Bn))},e.\u0275cmp=gt({type:e,selectors:[["app-google-auth-showcase"]],standalone:!1,decls:13,vars:15,consts:[[4,"ngIf"],[3,"click",4,"ngIf"],[3,"click"]],template:function(s,r){s&1&&(W(0,"div"),U(1),x(2,"async"),Y(),Ce(3,zf,6,5,"div",0),x(4,"async"),Ce(5,Yf,6,5,"div",0),x(6,"async"),Ce(7,Qf,2,0,"button",1),x(8,"async"),Ce(9,Xf,2,0,"button",1),x(10,"async"),W(11,"button",2),xe("click",function(){return r.getData()}),U(12,"Get data from Firebase"),Y()),s&2&&(q(),yt("Authenticated: ",D(2,5,r.isAuthenticated$)),q(2),Te("ngIf",D(4,7,r.isAuthenticated$)),q(2),Te("ngIf",D(6,9,r.data$)),q(2),Te("ngIf",D(8,11,r.isAuthenticated$)),q(2),Te("ngIf",D(10,13,r.isAuthenticated$)===!1))},dependencies:[Ln,Wn,Un],encapsulation:2});let n=e;return n})();var Jf=[{path:"",component:Qc,children:[{path:"",component:Do,children:[{path:"",redirectTo:"login",pathMatch:"full"},{path:"login",component:Oo},{path:"register",component:Mo},{path:"logout",component:Fo},{path:"request-password",component:Lo},{path:"reset-password",component:Wo}]}]},{path:"password-showcase",component:Xc},{path:"social-auth-showcase",component:Jc}],Zc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=de({type:e}),e.\u0275inj=ue({imports:[Xi.forChild(Jf),Xi]});let n=e;return n})();var Zg=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=de({type:e}),e.\u0275inj=ue({providers:[Bt],imports:[So,la.initializeApp({apiKey:"AIzaSyBEvySH74-sISCTkCC6lXUd3zzYj26GjRk",authDomain:"auth-sample-f48f1.firebaseapp.com",databaseURL:"https://auth-sample-f48f1.firebaseio.com",projectId:"auth-sample-f48f1",storageBucket:"auth-sample-f48f1.appspot.com",messagingSenderId:"246754092661",appId:"1:246754092661:web:c2606b9ecdbed579673a3c"}),wa,Hc,Zc,zc,Uo.forRoot({forms:{login:{strategy:"password",rememberMe:!0,socialLinks:[]},register:{strategy:"password",terms:!0,socialLinks:[]},logout:{strategy:"password"},requestPassword:{strategy:"password",socialLinks:[]},resetPassword:{strategy:"password",socialLinks:[]},validation:{password:{required:!0,minLength:6,maxLength:50},email:{required:!0},fullName:{required:!1,minLength:4,maxLength:50}}},strategies:[$i.setup({name:"password",login:{redirect:{success:"example/firebase/password-showcase"}},register:{redirect:{success:"example/firebase/password-showcase"}},logout:{redirect:{success:"example/firebase/login"}},requestPassword:{redirect:{success:"example/firebase/login"}},resetPassword:{redirect:{success:"example/firebase/login"}}}),Hi.setup({name:"google"})]})]});let n=e;return n})();export{Zg as FirebasePlaygroundModule};
