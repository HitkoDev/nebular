import{A as g,B as ee,C as F,D as Zi,E as Zo,F as Gt,G as K,H as De,I as $n,J as es,K as ea,L as mt,M as qt,N as ta,O as na,P as ia,Q as Be,R as L,a as f,b as gt,c as jn,d as jo,e as Bo,f as U,g as Xi,h as Vo,i as $o,j as Ho,k as Ji,l as Go,m as Ie,n as qo,o as Ko,p as Bn,q as D,r as zo,s as Yo,t as de,u as je,v as Vn,w as Ht,x as Qo,y as Xo,z as Jo}from"./chunk-F77D7DUD.js";import{c as zi,d as No,f as Yi,i as Un,j as xo,k as xe,l as Qi,t as Do,u as Oo,v as Mo,w as Fo,x as Lo,y as Wo,z as Uo}from"./chunk-TYUFTPWB.js";import"./chunk-RVE62PJS.js";import{A as G,Bc as Ao,Ca as $,Cc as Ro,D as We,Dc as Po,F as mo,Fb as N,Ga as Ue,Gb as x,Gc as Ki,H as yo,Ja as ft,Ka as he,L as $i,M as ct,N as Hi,Oa as Ee,Ob as $t,P as vo,Qa as se,R as V,S as Gi,X as wo,Xa as Ce,Y as Eo,Ya as O,Z as Co,Za as q,_a as bo,aa as Z,b as Le,ba as ce,ca as ie,cb as pt,cc as Fn,da as C,e as po,ea as ue,fa as Bt,fb as Ne,ga as ut,gb as Te,h as Dn,ha as ht,hc as Ln,i as _o,ia as To,kc as Wn,l as Ut,lc as So,m as On,ma as qi,n as X,na as Io,nc as ko,o as J,q as W,ra as Vt,rb as M,sb as Mn,tb as _t,wa as dt,x as jt,y as go}from"./chunk-UREXVF7E.js";import{a as Bi,b as Vi,h as we}from"./chunk-2HP4JIPC.js";var Xc="firebase",Jc="11.10.0";Be(Xc,Jc,"app");function Oe(n){n===void 0&&(n=ue(To));let e=n.get(qi);return t=>new Le(i=>{let s=e.add(),r=!1;function o(){r||(s(),r=!0)}let a=t.subscribe({next:l=>{i.next(l),o()},complete:()=>{i.complete(),o()},error:l=>{i.error(l),o()}});return a.add(()=>{i.unsubscribe(),o()}),a})}var Ve=new Eo("ANGULARFIRE2_VERSION");var sa=(n,e)=>{let t=e?[e]:ia(),i=[];return t.forEach(s=>{s.container.getProvider(n).instances.forEach(o=>{i.includes(o)||i.push(o)})}),i},ts=(function(n){return n[n.SILENT=0]="SILENT",n[n.WARN=1]="WARN",n[n.VERBOSE=2]="VERBOSE",n})(ts||{}),mp=$t()&&typeof Zone<"u"?ts.WARN:ts.SILENT;var Hn=class{zone;delegate;constructor(e,t=_o){this.zone=e,this.delegate=t}now(){return this.delegate.now()}schedule(e,t,i){let s=this.zone,r=function(o){s?s.runGuarded(()=>{e.apply(this,[o])}):e.apply(this,[o])};return this.delegate.schedule(r,t,i)}},Kt=(()=>{class n{outsideAngular;insideAngular;constructor(){let t=ue(se);this.outsideAngular=t.runOutsideAngular(()=>new Hn(typeof Zone>"u"?void 0:Zone.current)),this.insideAngular=t.run(()=>new Hn(typeof Zone>"u"?void 0:Zone.current,Dn))}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Z({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var Zc="firebase",eu="11.10.0";L.registerVersion(Zc,eu,"app-compat");var tu=["ngOnDestroy"],aa=(n,e,t,i={})=>new Proxy(n,{get:(s,r)=>t.runOutsideAngular(()=>{if(n[r])return i?.spy?.get&&i.spy.get(r,n[r]),n[r];if(tu.indexOf(r)>-1)return()=>{};let o=e.toPromise().then(a=>{let l=a?.[r];return typeof l=="function"?l.bind(a):l?.then?l.then(c=>t.run(()=>c)):t.run(()=>l)});return new Proxy(()=>{},{get:(a,l)=>o[l],apply:(a,l,c)=>o.then(u=>{let h=u?.(...c);return i?.spy?.apply&&i.spy.apply(r,c,h),h})})})});var Gn=class{constructor(e){return e}},yt=new ie("angularfire2.app.options"),vt=new ie("angularfire2.app.name");function zt(n,e,t){let i=typeof t=="string"&&t||"[DEFAULT]",s=typeof t=="object"&&t||{};s.name=s.name||i;let o=L.apps.filter(a=>a&&a.name===s.name)[0]||e.runOutsideAngular(()=>L.initializeApp(n,s));try{if(JSON.stringify(n)!==JSON.stringify(o.options)){let a=!!module.hot;nu("error",`${o.name} Firebase App already initialized with different options${a?", you may need to reload as Firebase is not HMR aware.":"."}`)}}catch{}return new Gn(o)}var nu=(n,...e)=>{$t()&&typeof console<"u"&&console[n](...e)},iu={provide:Gn,useFactory:zt,deps:[yt,se,[new Io,vt]]},la=(()=>{class n{static initializeApp(t,i){return{ngModule:n,providers:[{provide:yt,useValue:t},{provide:vt,useValue:i}]}}constructor(t){L.registerVersion("angularfire",Ve.full,"core"),L.registerVersion("angularfire",Ve.full,"app-compat"),L.registerVersion("angular",Co.full,t.toString())}static \u0275fac=function(i){return new(i||n)(C(dt))};static \u0275mod=he({type:n});static \u0275inj=ce({providers:[iu]})}return n})();function qn(n,e,t,i,s){let[,r,o]=globalThis.\u0275AngularfireInstanceCache.find(a=>a[0]===n)||[];if(r)return su(s,o)||(oa("error",`${e} was already initialized on the ${t} Firebase App with different settings.${ru?" You may need to reload as Firebase is not HMR aware.":""}`),oa("warn",{is:s,was:o})),r;{let a=i();return globalThis.\u0275AngularfireInstanceCache.push([n,a,s]),a}}function su(n,e){try{return n.toString()===e.toString()}catch{return n===e}}var ru=typeof module<"u"&&!!module.hot,oa=(n,...e)=>{$t()&&typeof console<"u"&&console[n](...e)};globalThis.\u0275AngularfireInstanceCache||=[];var lu=new Map,cu={activated:!1,tokenObservers:[]},uu={initialized:!1,enabled:!1};function me(n){return lu.get(n)||Object.assign({},cu)}function da(){return uu}var hu="https://content-firebaseappcheck.googleapis.com/v1";var du="exchangeDebugToken",ca={OFFSET_DURATION:300*1e3,RETRIAL_MIN_WAIT:30*1e3,RETRIAL_MAX_WAIT:960*1e3},Op=1440*60*1e3;var ss=class{constructor(e,t,i,s,r){if(this.operation=e,this.retryPolicy=t,this.getWaitDuration=i,this.lowerBound=s,this.upperBound=r,this.pending=null,this.nextErrorWaitInterval=s,s>r)throw new Error("Proactive refresh lower bound greater than upper bound!")}start(){this.nextErrorWaitInterval=this.lowerBound,this.process(!0).catch(()=>{})}stop(){this.pending&&(this.pending.reject("cancelled"),this.pending=null)}isRunning(){return!!this.pending}process(e){return we(this,null,function*(){this.stop();try{this.pending=new U,this.pending.promise.catch(t=>{}),yield fu(this.getNextRun(e)),this.pending.resolve(),yield this.pending.promise,this.pending=new U,this.pending.promise.catch(t=>{}),yield this.operation(),this.pending.resolve(),yield this.pending.promise,this.process(!0).catch(()=>{})}catch(t){this.retryPolicy(t)?this.process(!1).catch(()=>{}):this.stop()}})}getNextRun(e){if(e)return this.nextErrorWaitInterval=this.lowerBound,this.getWaitDuration();{let t=this.nextErrorWaitInterval;return this.nextErrorWaitInterval*=2,this.nextErrorWaitInterval>this.upperBound&&(this.nextErrorWaitInterval=this.upperBound),t}}};function fu(n){return new Promise(e=>{setTimeout(e,n)})}var pu={"already-initialized":"You have already called initializeAppCheck() for FirebaseApp {$appName} with different options. To avoid this error, call initializeAppCheck() with the same options as when it was originally called. This will return the already initialized instance.","use-before-activation":"App Check is being used before initializeAppCheck() is called for FirebaseApp {$appName}. Call initializeAppCheck() before instantiating other Firebase services.","fetch-network-error":"Fetch failed to connect to a network. Check Internet connection. Original error: {$originalErrorMessage}.","fetch-parse-error":"Fetch client could not parse response. Original error: {$originalErrorMessage}.","fetch-status-error":"Fetch server returned an HTTP error status. HTTP status: {$httpStatus}.","storage-open":"Error thrown when opening storage. Original error: {$originalErrorMessage}.","storage-get":"Error thrown when reading from storage. Original error: {$originalErrorMessage}.","storage-set":"Error thrown when writing to storage. Original error: {$originalErrorMessage}.","recaptcha-error":"ReCAPTCHA error.","initial-throttle":"{$httpStatus} error. Attempts allowed again after {$time}",throttled:"Requests throttled due to previous {$httpStatus} error. Attempts allowed again after {$time}"},$e=new Ko("appCheck","AppCheck",pu);function fa(n){if(!me(n).activated)throw $e.create("use-before-activation",{appName:n.name})}function pa(i,s){return we(this,arguments,function*({url:n,body:e},t){let r={"Content-Type":"application/json"},o=t.getImmediate({optional:!0});if(o){let p=yield o.getHeartbeatsHeader();p&&(r["X-Firebase-Client"]=p)}let a={method:"POST",body:JSON.stringify(e),headers:r},l;try{l=yield fetch(n,a)}catch(p){throw $e.create("fetch-network-error",{originalErrorMessage:p?.message})}if(l.status!==200)throw $e.create("fetch-status-error",{httpStatus:l.status});let c;try{c=yield l.json()}catch(p){throw $e.create("fetch-parse-error",{originalErrorMessage:p?.message})}let u=c.ttl.match(/^([\d.]+)(s)$/);if(!u||!u[2]||isNaN(Number(u[1])))throw $e.create("fetch-parse-error",{originalErrorMessage:`ttl field (timeToLive) is not in standard Protobuf Duration format: ${c.ttl}`});let h=Number(u[1])*1e3,d=Date.now();return{token:c.token,expireTimeMillis:d+h,issuedAtTimeMillis:d}})}function _a(n,e){let{projectId:t,appId:i,apiKey:s}=n.options;return{url:`${hu}/projects/${t}/apps/${i}:${du}?key=${s}`,body:{debug_token:e}}}var _u="firebase-app-check-database",gu=1,rs="firebase-app-check-store";var Kn=null;function mu(){return Kn||(Kn=new Promise((n,e)=>{try{let t=indexedDB.open(_u,gu);t.onsuccess=i=>{n(i.target.result)},t.onerror=i=>{var s;e($e.create("storage-open",{originalErrorMessage:(s=i.target.error)===null||s===void 0?void 0:s.message}))},t.onupgradeneeded=i=>{let s=i.target.result;switch(i.oldVersion){case 0:s.createObjectStore(rs,{keyPath:"compositeKey"})}}}catch(t){e($e.create("storage-open",{originalErrorMessage:t?.message}))}}),Kn)}function yu(n,e){return vu(wu(n),e)}function vu(n,e){return we(this,null,function*(){let i=(yield mu()).transaction(rs,"readwrite"),r=i.objectStore(rs).put({compositeKey:n,value:e});return new Promise((o,a)=>{r.onsuccess=l=>{o()},i.onerror=l=>{var c;a($e.create("storage-set",{originalErrorMessage:(c=l.target.error)===null||c===void 0?void 0:c.message}))}})})}function wu(n){return`${n.options.appId}-${n.name}`}var Yt=new mt("@firebase/app-check");function ns(n,e){return qo()?yu(n,e).catch(t=>{Yt.warn(`Failed to write token to IndexedDB. Error: ${t}`)}):Promise.resolve()}function ga(){return da().enabled}function ma(){return we(this,null,function*(){let n=da();if(n.enabled&&n.token)return n.token.promise;throw Error(`
            Can't get debug token in production mode.
        `)})}var Eu={error:"UNKNOWN_ERROR"};function Cu(n){return jn.encodeString(JSON.stringify(n),!1)}function os(n,e=!1,t=!1){return we(this,null,function*(){let i=n.app;fa(i);let s=me(i),r=s.token,o;if(r&&!Qt(r)&&(s.token=void 0,r=void 0),!r){let c=yield s.cachedTokenPromise;c&&(Qt(c)?r=c:yield ns(i,void 0))}if(!e&&r&&Qt(r))return{token:r.token};let a=!1;if(ga())try{s.exchangeTokenPromise||(s.exchangeTokenPromise=pa(_a(i,yield ma()),n.heartbeatServiceProvider).finally(()=>{s.exchangeTokenPromise=void 0}),a=!0);let c=yield s.exchangeTokenPromise;return yield ns(i,c),s.token=c,{token:c.token}}catch(c){return c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?Yt.warn(c.message):t&&Yt.error(c),is(c)}try{s.exchangeTokenPromise||(s.exchangeTokenPromise=s.provider.getToken().finally(()=>{s.exchangeTokenPromise=void 0}),a=!0),r=yield me(i).exchangeTokenPromise}catch(c){c.code==="appCheck/throttled"||c.code==="appCheck/initial-throttle"?Yt.warn(c.message):t&&Yt.error(c),o=c}let l;return r?o?Qt(r)?l={token:r.token,internalError:o}:l=is(o):(l={token:r.token},s.token=r,yield ns(i,r)):l=is(o),a&&Su(i,l),l})}function Tu(n){return we(this,null,function*(){let e=n.app;fa(e);let{provider:t}=me(e);if(ga()){let i=yield ma(),{token:s}=yield pa(_a(e,i),n.heartbeatServiceProvider);return{token:s}}else{let{token:i}=yield t.getToken();return{token:i}}})}function Iu(n,e,t,i){let{app:s}=n,r=me(s),o={next:t,error:i,type:e};if(r.tokenObservers=[...r.tokenObservers,o],r.token&&Qt(r.token)){let a=r.token;Promise.resolve().then(()=>{t({token:a.token}),ua(n)}).catch(()=>{})}r.cachedTokenPromise.then(()=>ua(n))}function ya(n,e){let t=me(n),i=t.tokenObservers.filter(s=>s.next!==e);i.length===0&&t.tokenRefresher&&t.tokenRefresher.isRunning()&&t.tokenRefresher.stop(),t.tokenObservers=i}function ua(n){let{app:e}=n,t=me(e),i=t.tokenRefresher;i||(i=bu(n),t.tokenRefresher=i),!i.isRunning()&&t.isTokenAutoRefreshEnabled&&i.start()}function bu(n){let{app:e}=n;return new ss(()=>we(null,null,function*(){let t=me(e),i;if(t.token?i=yield os(n,!0):i=yield os(n),i.error)throw i.error;if(i.internalError)throw i.internalError}),()=>!0,()=>{let t=me(e);if(t.token){let i=t.token.issuedAtTimeMillis+(t.token.expireTimeMillis-t.token.issuedAtTimeMillis)*.5+3e5,s=t.token.expireTimeMillis-300*1e3;return i=Math.min(i,s),Math.max(0,i-Date.now())}else return 0},ca.RETRIAL_MIN_WAIT,ca.RETRIAL_MAX_WAIT)}function Su(n,e){let t=me(n).tokenObservers;for(let i of t)try{i.type==="EXTERNAL"&&e.error!=null?i.error(e.error):i.next(e)}catch{}}function Qt(n){return n.expireTimeMillis-Date.now()>0}function is(n){return{token:Cu(Eu),error:n}}var as=class{constructor(e,t){this.app=e,this.heartbeatServiceProvider=t}_delete(){let{tokenObservers:e}=me(this.app);for(let t of e)ya(this.app,t.next);return Promise.resolve()}};function ku(n,e){return new as(n,e)}function Au(n){return{getToken:e=>os(n,e),getLimitedUseToken:()=>Tu(n),addTokenListener:e=>Iu(n,"INTERNAL",e),removeTokenListener:e=>ya(n.app,e)}}var Ru="@firebase/app-check",Pu="0.10.1";var Nu="app-check",ha="app-check-internal";function xu(){qt(new De(Nu,n=>{let e=n.getProvider("app").getImmediate(),t=n.getProvider("heartbeat");return ku(e,t)},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((n,e,t)=>{n.getProvider(ha).initialize()})),qt(new De(ha,n=>{let e=n.getProvider("app-check").getImmediate();return Au(e)},"PUBLIC").setInstantiationMode("EXPLICIT")),Be(Ru,Pu)}xu();var Du="app-check";var wt=class{constructor(){return sa(Du)}};var Ou=["localhost","0.0.0.0","127.0.0.1"],Yp=typeof window<"u"&&Ou.includes(window.location.hostname);var ls=new ie("angularfire2.auth.use-emulator"),cs=new ie("angularfire2.auth.settings"),us=new ie("angularfire2.auth.tenant-id"),hs=new ie("angularfire2.auth.langugage-code"),ds=new ie("angularfire2.auth.use-device-language"),fs=new ie("angularfire.auth.persistence"),ps=(n,e,t,i,s,r,o,a)=>qn(`${n.name}.auth`,"AngularFireAuth",n.name,()=>{let l=e.runOutsideAngular(()=>n.auth());if(t&&l.useEmulator(...t),i&&(l.tenantId=i),l.languageCode=s,r&&l.useDeviceLanguage(),o)for(let[c,u]of Object.entries(o))l.settings[c]=u;return a&&l.setPersistence(a),l},[t,i,s,r,o,a]),Xt=(()=>{class n{injector=ue(Bt);authState;idToken;user;idTokenResult;credential;constructor(t,i,s,r,o,a,l,c,u,h,d,p){let _=new po,E=J(void 0).pipe(Ut(o.outsideAngular),V(()=>r.runOutsideAngular(()=>import("./chunk-3H7L2WQ3.js"))),W(()=>zt(t,r,i)),W(b=>ps(b,r,a,c,u,h,l,d)),Hi({bufferSize:1,refCount:!1}));if(ko(s))this.authState=this.user=this.idToken=this.idTokenResult=this.credential=J(null);else{E.pipe(yo()).subscribe();let b=E.pipe(V(A=>A.getRedirectResult().then(ge=>ge,()=>null)),Oe(this.injector),Hi({bufferSize:1,refCount:!1})),te=E.pipe(V(A=>new Le(ge=>({unsubscribe:r.runOutsideAngular(()=>A.onAuthStateChanged(Ze=>ge.next(Ze),Ze=>ge.error(Ze),()=>ge.complete()))})))),ne=E.pipe(V(A=>new Le(ge=>({unsubscribe:r.runOutsideAngular(()=>A.onIdTokenChanged(Ze=>ge.next(Ze),Ze=>ge.error(Ze),()=>ge.complete()))}))));this.authState=b.pipe(Gi(te),On(o.outsideAngular),Ut(o.insideAngular)),this.user=b.pipe(Gi(ne),On(o.outsideAngular),Ut(o.insideAngular)),this.idToken=this.user.pipe(V(A=>A?X(A.getIdToken()):J(null))),this.idTokenResult=this.user.pipe(V(A=>A?X(A.getIdTokenResult()):J(null))),this.credential=jt(b,_,this.authState.pipe(go(A=>!A))).pipe(W(A=>A?.user?A:null),On(o.outsideAngular),Ut(o.insideAngular))}return aa(this,E,r,{spy:{apply:(b,te,ne)=>{(b.startsWith("signIn")||b.startsWith("createUser"))&&ne.then(A=>_.next(A))}}})}static \u0275fac=function(i){return new(i||n)(C(yt),C(vt,8),C(dt),C(se),C(Kt),C(ls,8),C(cs,8),C(us,8),C(hs,8),C(ds,8),C(fs,8),C(wt,8))};static \u0275prov=Z({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),wa=(()=>{class n{constructor(){L.registerVersion("angularfire",Ve.full,"auth-compat")}static \u0275fac=function(i){return new(i||n)};static \u0275mod=he({type:n});static \u0275inj=ce({providers:[Xt]})}return n})();var Ca="@firebase/database",Ta="1.0.20";var Sr="";function kr(n){Sr=n}var Cs=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),D(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:Bn(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var Ts=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return de(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var el=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Cs(e)}}catch{}return new Ts},tt=el("localStorage"),Is=el("sessionStorage");var It=new mt("@firebase/database"),tl=(function(){let n=1;return function(){return n++}})(),nl=function(n){let e=Zo(n),t=new Jo;t.update(e);let i=t.digest();return jn.encodeByteArray(i)},Cn=function(...n){let e="";for(let t=0;t<n.length;t++){let i=n[t];Array.isArray(i)||i&&typeof i=="object"&&typeof i.length=="number"?e+=Cn.apply(null,i):typeof i=="object"?e+=D(i):e+=i,e+=" "}return e},nt=null,Ia=!0,il=function(n,e){f(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(It.logLevel=ea.VERBOSE,nt=It.log.bind(It),e&&Is.set("logging_enabled",!0)):typeof n=="function"?nt=n:(nt=null,Is.remove("logging_enabled"))},j=function(...n){if(Ia===!0&&(Ia=!1,nt===null&&Is.get("logging_enabled")===!0&&il(!0)),nt){let e=Cn.apply(null,n);nt(e)}},Tn=function(n){return function(...e){j(n,...e)}},bs=function(...n){let e="FIREBASE INTERNAL ERROR: "+Cn(...n);It.error(e)},Ae=function(...n){let e=`FIREBASE FATAL ERROR: ${Cn(...n)}`;throw It.error(e),new Error(e)},H=function(...n){let e="FIREBASE WARNING: "+Cn(...n);It.warn(e)},Mu=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&H("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Ei=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Fu=function(n){if(Ie()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Ke="[MIN_NAME]",Me="[MAX_NAME]",st=function(n,e){if(n===e)return 0;if(n===Ke||e===Me)return-1;if(e===Ke||n===Me)return 1;{let t=ba(n),i=ba(e);return t!==null?i!==null?t-i===0?n.length-e.length:t-i:-1:i!==null?1:n<e?-1:1}},Lu=function(n,e){return n===e?0:n<e?-1:1},Jt=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+D(e))},Ar=function(n){if(typeof n!="object"||n===null)return D(n);let e=[];for(let i in n)e.push(i);e.sort();let t="{";for(let i=0;i<e.length;i++)i!==0&&(t+=","),t+=D(e[i]),t+=":",t+=Ar(n[e[i]]);return t+="}",t},sl=function(n,e){let t=n.length;if(t<=e)return[n];let i=[];for(let s=0;s<t;s+=e)s+e>t?i.push(n.substring(s,t)):i.push(n.substring(s,s+e));return i};function B(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var rl=function(n){f(!Ei(n),"Invalid JSON number");let e=11,t=52,i=(1<<e-1)-1,s,r,o,a,l;n===0?(r=0,o=0,s=1/n===-1/0?1:0):(s=n<0,n=Math.abs(n),n>=Math.pow(2,1-i)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),i),r=a+i,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(r=0,o=Math.round(n/Math.pow(2,1-i-t))));let c=[];for(l=t;l;l-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(l=e;l;l-=1)c.push(r%2?1:0),r=Math.floor(r/2);c.push(s?1:0),c.reverse();let u=c.join(""),h="";for(l=0;l<64;l+=8){let d=parseInt(u.substr(l,8),2).toString(16);d.length===1&&(d="0"+d),h=h+d}return h.toLowerCase()},Wu=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Uu=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function ju(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let i=new Error(n+" at "+e._path.toString()+": "+t);return i.code=n.toUpperCase(),i}var Bu=new RegExp("^-?(0*)\\d{1,10}$"),Vu=-2147483648,$u=2147483647,ba=function(n){if(Bu.test(n)){let e=Number(n);if(e>=Vu&&e<=$u)return e}return null},Dt=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw H("Exception was thrown by user callback.",t),e},Math.floor(0))}},Hu=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},nn=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var Ss=class{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,ta(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(i=>this.appCheck=i)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw new Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,i)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(i=>i.addTokenListener(e))}notifyForInvalidToken(){H(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}};var ks=class{constructor(e,t,i){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=i,this.auth_=null,this.auth_=i.getImmediate({optional:!0}),this.auth_||i.onInit(s=>this.auth_=s)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(j("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,i)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,i):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',H(e)}},sn=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Yn="5",ol="v",al="s",ll="r",cl="f",ul=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,hl="ls",dl="p",As="ac",fl="websocket",pl="long_polling";var Qn=class{constructor(e,t,i,s,r=!1,o="",a=!1,l=!1,c=null){this.secure=t,this.namespace=i,this.webSocketOnly=s,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=l,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=tt.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&tt.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function Gu(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function _l(n,e,t){f(typeof e=="string","typeof type must == string"),f(typeof t=="object","typeof params must == object");let i;if(e===fl)i=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===pl)i=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);Gu(n)&&(t.ns=n.namespace);let s=[];return B(t,(r,o)=>{s.push(r+"="+o)}),i+s.join("&")}var Rs=class{constructor(){this.counters_={}}incrementCounter(e,t=1){de(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Bo(this.counters_)}};var _s={},gs={};function Rr(n){let e=n.toString();return _s[e]||(_s[e]=new Rs),_s[e]}function qu(n,e){let t=n.toString();return gs[t]||(gs[t]=e()),gs[t]}var Ps=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let i=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let s=0;s<i.length;++s)i[s]&&Dt(()=>{this.onMessage_(i[s])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var Sa="start",Ku="close",zu="pLPCommand",Yu="pRTLPCB",gl="id",ml="pw",yl="ser",Qu="cb",Xu="seg",Ju="ts",Zu="d",eh="dframe",vl=1870,wl=30,th=vl-wl,nh=25e3,ih=3e4,ln=class n{constructor(e,t,i,s,r,o,a){this.connId=e,this.repoInfo=t,this.applicationId=i,this.appCheckToken=s,this.authToken=r,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Tn(e),this.stats_=Rr(t),this.urlFn=l=>(this.appCheckToken&&(l[As]=this.appCheckToken),_l(t,pl,l))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Ps(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(ih)),Fu(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Ns((...r)=>{let[o,a,l,c,u]=r;if(this.incrementIncomingBytes_(r),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===Sa)this.id=a,this.password=l;else if(o===Ku)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...r)=>{let[o,a]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let i={};i[Sa]="t",i[yl]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(i[Qu]=this.scriptTagHolder.uniqueCallbackIdentifier),i[ol]=Yn,this.transportSessionId&&(i[al]=this.transportSessionId),this.lastSessionId&&(i[hl]=this.lastSessionId),this.applicationId&&(i[dl]=this.applicationId),this.appCheckToken&&(i[As]=this.appCheckToken),typeof location<"u"&&location.hostname&&ul.test(location.hostname)&&(i[ll]=cl);let s=this.urlFn(i);this.log_("Connecting via long-poll to "+s),this.scriptTagHolder.addTag(s,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Ie()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!Wu()&&!Uu()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=D(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let i=jo(t),s=sl(i,th);for(let r=0;r<s.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,s.length,s[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Ie())return;this.myDisconnFrame=document.createElement("iframe");let i={};i[eh]="t",i[gl]=e,i[ml]=t,this.myDisconnFrame.src=this.urlFn(i),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=D(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},Ns=class n{constructor(e,t,i,s){if(this.onDisconnect=i,this.urlFn=s,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Ie())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=tl(),window[zu+this.uniqueCallbackIdentifier]=e,window[Yu+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let r="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(r='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){j("frame writing exception"),a.stack&&j(a.stack),j(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||j("No IE domain setting required")}catch{let i=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+i+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[gl]=this.myID,e[ml]=this.myPW,e[yl]=this.currentSerial;let t=this.urlFn(e),i="",s=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+wl+i.length<=vl;){let o=this.pendingSegs.shift();i=i+"&"+Xu+s+"="+o.seg+"&"+Ju+s+"="+o.ts+"&"+Zu+s+"="+o.d,s++}return t=t+i,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,i){this.pendingSegs.push({seg:e,ts:t,d:i}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let i=()=>{this.outstandingRequests.delete(t),this.newRequest_()},s=setTimeout(i,Math.floor(nh)),r=()=>{clearTimeout(s),i()};this.addTag(e,r)}addTag(e,t){Ie()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let i=this.myIFrame.doc.createElement("script");i.type="text/javascript",i.async=!0,i.src=e,i.onload=i.onreadystatechange=function(){let s=i.readyState;(!s||s==="loaded"||s==="complete")&&(i.onload=i.onreadystatechange=null,i.parentNode&&i.parentNode.removeChild(i),t())},i.onerror=()=>{j("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(i)}catch{}},Math.floor(1))}};var sh=16384,rh=45e3,Xn=null;typeof MozWebSocket<"u"?Xn=MozWebSocket:typeof WebSocket<"u"&&(Xn=WebSocket);var Ct=(()=>{class n{constructor(t,i,s,r,o,a,l){this.connId=t,this.applicationId=s,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Tn(this.connId),this.stats_=Rr(i),this.connURL=n.connectionURL_(i,a,l,r,s),this.nodeAdmin=i.nodeAdmin}static connectionURL_(t,i,s,r,o){let a={};return a[ol]=Yn,!Ie()&&typeof location<"u"&&location.hostname&&ul.test(location.hostname)&&(a[ll]=cl),i&&(a[al]=i),s&&(a[hl]=s),r&&(a[As]=r),o&&(a[dl]=o),_l(t,fl,a)}open(t,i){this.onDisconnect=i,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,tt.set("previous_websocket_failure",!0);try{let s;if(Ie()){let r=this.nodeAdmin?"AdminNode":"Node";s={headers:{"User-Agent":`Firebase/${Yn}/${Sr}/${process.platform}/${r}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(s.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(s.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(s.proxy={origin:a})}this.mySock=new Xn(this.connURL,[],s)}catch(s){this.log_("Error instantiating WebSocket.");let r=s.message||s.data;r&&this.log_(r),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=s=>{this.handleIncomingFrame(s)},this.mySock.onerror=s=>{this.log_("WebSocket error.  Closing connection.");let r=s.message||s.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let i=/Android ([0-9]{0,}\.[0-9]{0,})/,s=navigator.userAgent.match(i);s&&s.length>1&&parseFloat(s[1])<4.4&&(t=!0)}return!t&&Xn!==null&&!n.forceDisallow_}static previouslyFailed(){return tt.isInMemoryStorage||tt.get("previous_websocket_failure")===!0}markConnectionHealthy(){tt.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let i=this.frames.join("");this.frames=null;let s=Bn(i);this.onMessage(s)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(f(this.frames===null,"We already have a frame buffer"),t.length<=6){let i=Number(t);if(!isNaN(i))return this.handleNewFrameCount_(i),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let i=t.data;if(this.bytesReceived+=i.length,this.stats_.incrementCounter("bytes_received",i.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(i);else{let s=this.extractFrameCount_(i);s!==null&&this.appendFrame_(s)}}send(t){this.resetKeepAlive();let i=D(t);this.bytesSent+=i.length,this.stats_.incrementCounter("bytes_sent",i.length);let s=sl(i,sh);s.length>1&&this.sendString_(String(s.length));for(let r=0;r<s.length;r++)this.sendString_(s[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(rh))}sendString_(t){try{this.mySock.send(t)}catch(i){this.log_("Exception thrown from WebSocket.send():",i.message||i.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),El=(()=>{class n{static get ALL_TRANSPORTS(){return[ln,Ct]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(t){this.initTransports_(t)}initTransports_(t){let i=Ct&&Ct.isAvailable(),s=i&&!Ct.previouslyFailed();if(t.webSocketOnly&&(i||H("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),s=!0),s)this.transports_=[Ct];else{let r=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),oh=6e4,ah=5e3,lh=10*1024,ch=100*1024,ms="t",ka="d",uh="s",Aa="r",hh="e",Ra="o",Pa="a",Na="n",xa="p",dh="h",xs=class{constructor(e,t,i,s,r,o,a,l,c,u){this.id=e,this.repoInfo_=t,this.applicationId_=i,this.appCheckToken_=s,this.authToken_=r,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=l,this.onKill_=c,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Tn("c:"+this.id+":"),this.transportManager_=new El(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),i=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,i)},Math.floor(0));let s=e.healthyTimeout||0;s>0&&(this.healthyTimeout_=nn(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>ch?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>lh?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(s)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(ms in e){let t=e[ms];t===Pa?this.upgradeIfSecondaryHealthy_():t===Aa?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Ra&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=Jt("t",e),i=Jt("d",e);if(t==="c")this.onSecondaryControl_(i);else if(t==="d")this.pendingDataMessages.push(i);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:xa,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Pa,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Na,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=Jt("t",e),i=Jt("d",e);t==="c"?this.onControl_(i):t==="d"&&this.onDataMessage_(i)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=Jt(ms,e);if(ka in e){let i=e[ka];if(t===dh){let s=Object.assign({},i);this.repoInfo_.isUsingEmulator&&(s.h=this.repoInfo_.host),this.onHandshake_(s)}else if(t===Na){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let s=0;s<this.pendingDataMessages.length;++s)this.onDataMessage_(this.pendingDataMessages[s]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===uh?this.onConnectionShutdown_(i):t===Aa?this.onReset_(i):t===hh?bs("Server Error: "+i):t===Ra?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):bs("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,i=e.v,s=e.h;this.sessionId=e.s,this.repoInfo_.host=s,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Yn!==i&&H("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),i=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,i),nn(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(oh))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):nn(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(ah))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:xa,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(tt.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var Jn=class{put(e,t,i,s){}merge(e,t,i,s){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,i){}onDisconnectMerge(e,t,i){}onDisconnectCancel(e,t){}reportStats(e){}};var Zn=class{constructor(e){this.allowedEvents_=e,this.listeners_={},f(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let i=[...this.listeners_[e]];for(let s=0;s<i.length;s++)i[s].callback.apply(i[s].context,t)}}on(e,t,i){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:i});let s=this.getInitialEvent(e);s&&t.apply(i,s)}off(e,t,i){this.validateEventType_(e);let s=this.listeners_[e]||[];for(let r=0;r<s.length;r++)if(s[r].callback===t&&(!i||i===s[r].context)){s.splice(r,1);return}}validateEventType_(e){f(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var ei=class n extends Zn{static getInstance(){return new n}constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Ji()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(e){return f(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Da=32,Oa=768,I=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let i=0;for(let s=0;s<this.pieces_.length;s++)this.pieces_[s].length>0&&(this.pieces_[i]=this.pieces_[s],i++);this.pieces_.length=i,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function T(){return new I("")}function y(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function ze(n){return n.pieces_.length-n.pieceNum_}function S(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new I(n.pieces_,e)}function Pr(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function fh(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function cn(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Cl(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new I(e,0)}function R(n,e){let t=[];for(let i=n.pieceNum_;i<n.pieces_.length;i++)t.push(n.pieces_[i]);if(e instanceof I)for(let i=e.pieceNum_;i<e.pieces_.length;i++)t.push(e.pieces_[i]);else{let i=e.split("/");for(let s=0;s<i.length;s++)i[s].length>0&&t.push(i[s])}return new I(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function z(n,e){let t=y(n),i=y(e);if(t===null)return e;if(t===i)return z(S(n),S(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function ph(n,e){let t=cn(n,0),i=cn(e,0);for(let s=0;s<t.length&&s<i.length;s++){let r=st(t[s],i[s]);if(r!==0)return r}return t.length===i.length?0:t.length<i.length?-1:1}function Nr(n,e){if(ze(n)!==ze(e))return!1;for(let t=n.pieceNum_,i=e.pieceNum_;t<=n.pieces_.length;t++,i++)if(n.pieces_[t]!==e.pieces_[i])return!1;return!0}function fe(n,e){let t=n.pieceNum_,i=e.pieceNum_;if(ze(n)>ze(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[i])return!1;++t,++i}return!0}var Ds=class{constructor(e,t){this.errorPrefix_=t,this.parts_=cn(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let i=0;i<this.parts_.length;i++)this.byteLength_+=Gt(this.parts_[i]);Tl(this)}};function _h(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Gt(e),Tl(n)}function gh(n){let e=n.parts_.pop();n.byteLength_-=Gt(e),n.parts_.length>0&&(n.byteLength_-=1)}function Tl(n){if(n.byteLength_>Oa)throw new Error(n.errorPrefix_+"has a key path longer than "+Oa+" bytes ("+n.byteLength_+").");if(n.parts_.length>Da)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Da+") or object contains a cycle "+et(n))}function et(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var Os=class n extends Zn{static getInstance(){return new n}constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let i=!document[e];i!==this.visible_&&(this.visible_=i,this.trigger("visible",i))},!1)}getInitialEvent(e){return f(e==="visible","Unknown event type: "+e),[this.visible_]}};var Zt=1e3,mh=300*1e3,Ma=30*1e3,yh=1.3,vh=3e4,wh="server_kill",Fa=3,xr=(()=>{class n extends Jn{constructor(t,i,s,r,o,a,l,c){if(super(),this.repoInfo_=t,this.applicationId_=i,this.onDataUpdate_=s,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=l,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=Tn("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Zt,this.maxReconnectDelay_=mh,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Ie())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Os.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&ei.getInstance().on("online",this.onOnline_,this)}sendRequest(t,i,s){let r=++this.requestNumber_,o={r,a:t,b:i};this.log_(D(o)),f(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),s&&(this.requestCBHash_[r]=s)}get(t){this.initConnection_();let i=new U,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:a=>{let l=a.d;a.s==="ok"?i.resolve(l):i.reject(l)}};this.outstandingGets_.push(r),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),i.promise}listen(t,i,s,r){this.initConnection_();let o=t._queryIdentifier,a=t._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),f(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let l={onComplete:r,hashFn:i,query:t,tag:s};this.listens.get(a).set(o,l),this.connected_&&this.sendListen_(l)}sendGet_(t){let i=this.outstandingGets_[t];this.sendRequest("g",i.request,s=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),i.onComplete&&i.onComplete(s)})}sendListen_(t){let i=t.query,s=i._path.toString(),r=i._queryIdentifier;this.log_("Listen on "+s+" for "+r);let o={p:s},a="q";t.tag&&(o.q=i._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(a,o,l=>{let c=l.d,u=l.s;n.warnOnListenWarnings_(c,i),(this.listens.get(s)&&this.listens.get(s).get(r))===t&&(this.log_("listen response",l),u!=="ok"&&this.removeListen_(s,r),t.onComplete&&t.onComplete(u,c))})}static warnOnListenWarnings_(t,i){if(t&&typeof t=="object"&&de(t,"w")){let s=je(t,"w");if(Array.isArray(s)&&~s.indexOf("no_index")){let r='".indexOn": "'+i._queryParams.getIndex().toString()+'"',o=i._path.toString();H(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||Yo(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Ma)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,i=zo(t)?"auth":"gauth",s={cred:t};this.authOverride_===null?s.noauth=!0:typeof this.authOverride_=="object"&&(s.authvar=this.authOverride_),this.sendRequest(i,s,r=>{let o=r.s,a=r.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let i=t.s,s=t.d||"error";i==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(i,s)})}unlisten(t,i){let s=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+s+" "+r),f(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(s,r)&&this.connected_&&this.sendUnlisten_(s,r,t._queryObject,i)}sendUnlisten_(t,i,s,r){this.log_("Unlisten on "+t+" for "+i);let o={p:t},a="n";r&&(o.q=s,o.t=r),this.sendRequest(a,o)}onDisconnectPut(t,i,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,i,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:i,onComplete:s})}onDisconnectMerge(t,i,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,i,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:i,onComplete:s})}onDisconnectCancel(t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:i})}sendOnDisconnect_(t,i,s,r){let o={p:i,d:s};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,a=>{r&&setTimeout(()=>{r(a.s,a.d)},Math.floor(0))})}put(t,i,s,r){this.putInternal("p",t,i,s,r)}merge(t,i,s,r){this.putInternal("m",t,i,s,r)}putInternal(t,i,s,r,o){this.initConnection_();let a={p:i,d:s};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:t,request:a,onComplete:r}),this.outstandingPutCount_++;let l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+i)}sendPut_(t){let i=this.outstandingPuts_[t].action,s=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(i,s,o=>{this.log_(i+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){let i={c:t};this.log_("reportStats",i),this.sendRequest("s",i,s=>{if(s.s!=="ok"){let o=s.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+D(t));let i=t.r,s=this.requestCBHash_[i];s&&(delete this.requestCBHash_[i],s(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,i){this.log_("handleServerMessage",t,i),t==="d"?this.onDataUpdate_(i.p,i.d,!1,i.t):t==="m"?this.onDataUpdate_(i.p,i.d,!0,i.t):t==="c"?this.onListenRevoked_(i.p,i.q):t==="ac"?this.onAuthRevoked_(i.s,i.d):t==="apc"?this.onAppCheckRevoked_(i.s,i.d):t==="sd"?this.onSecurityDebugPacket_(i):bs("Unrecognized action received from server: "+D(t)+`
Are you using the latest client?`)}onReady_(t,i){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=i,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){f(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Zt,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Zt,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>vh&&(this.reconnectDelay_=Zt),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),i=Math.max(0,this.reconnectDelay_-t);i=Math.random()*i,this.log_("Trying to reconnect in "+i+"ms"),this.scheduleConnect_(i),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*yh)}this.onConnectStatus_(!1)}establishConnection_(){return we(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),i=this.onReady_.bind(this),s=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,a=!1,l=null,c=function(){l?l.close():(a=!0,s())},u=function(d){f(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(d)};this.realtime_={close:c,sendRequest:u};let h=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[d,p]=yield Promise.all([this.authTokenProvider_.getToken(h),this.appCheckTokenProvider_.getToken(h)]);a?j("getToken() completed but was canceled"):(j("getToken() completed. Creating connection."),this.authToken_=d&&d.accessToken,this.appCheckToken_=p&&p.token,l=new xs(r,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,i,s,_=>{H(_+" ("+this.repoInfo_.toString()+")"),this.interrupt(wh)},o))}catch(d){this.log_("Failed to get token: "+d),a||(this.repoInfo_.nodeAdmin&&H(d),c())}}})}interrupt(t){j("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){j("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Vn(this.interruptReasons_)&&(this.reconnectDelay_=Zt,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let i=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:i})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let i=this.outstandingPuts_[t];i&&"h"in i.request&&i.queued&&(i.onComplete&&i.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,i){let s;i?s=i.map(o=>Ar(o)).join("$"):s="default";let r=this.removeListen_(t,s);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,i){let s=new I(t).toString(),r;if(this.listens.has(s)){let o=this.listens.get(s);r=o.get(i),o.delete(i),o.size===0&&this.listens.delete(s)}else r=void 0;return r}onAuthRevoked_(t,i){j("Auth token revoked: "+t+"/"+i),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Fa&&(this.reconnectDelay_=Ma,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,i){j("App check token revoked: "+t+"/"+i),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Fa&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let i of t.values())this.sendListen_(i);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},i="js";Ie()&&(this.repoInfo_.nodeAdmin?i="admin_node":i="node"),t["sdk."+i+"."+Sr.replace(/\./g,"-")]=1,Ji()?t["framework.cordova"]=1:Go()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=ei.getInstance().currentlyOnline();return Vn(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),w=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var bt=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let i=new w(Ke,e),s=new w(Ke,t);return this.compare(i,s)!==0}minPost(){return w.MIN}};var zn,ti=class extends bt{static get __EMPTY_NODE(){return zn}static set __EMPTY_NODE(e){zn=e}compare(e,t){return st(e.name,t.name)}isDefinedOn(e){throw gt("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return w.MIN}maxPost(){return new w(Me,zn)}makePost(e,t){return f(typeof e=="string","KeyIndex indexValue must always be a string."),new w(e,zn)}toString(){return".key"}},ke=new ti;var Tt=class{constructor(e,t,i,s,r=null){this.isReverse_=s,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?i(e.key,t):1,s&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},ye=(()=>{class n{constructor(t,i,s,r,o){this.key=t,this.value=i,this.color=s??n.RED,this.left=r??pe.EMPTY_NODE,this.right=o??pe.EMPTY_NODE}copy(t,i,s,r,o){return new n(t??this.key,i??this.value,s??this.color,r??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,i,s){let r=this,o=s(t,r.key);return o<0?r=r.copy(null,null,null,r.left.insert(t,i,s),null):o===0?r=r.copy(null,i,null,null,null):r=r.copy(null,null,null,null,r.right.insert(t,i,s)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return pe.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,i){let s,r;if(s=this,i(t,s.key)<0)!s.left.isEmpty()&&!s.left.isRed_()&&!s.left.left.isRed_()&&(s=s.moveRedLeft_()),s=s.copy(null,null,null,s.left.remove(t,i),null);else{if(s.left.isRed_()&&(s=s.rotateRight_()),!s.right.isEmpty()&&!s.right.isRed_()&&!s.right.left.isRed_()&&(s=s.moveRedRight_()),i(t,s.key)===0){if(s.right.isEmpty())return pe.EMPTY_NODE;r=s.right.min_(),s=s.copy(r.key,r.value,null,null,s.right.removeMin_())}s=s.copy(null,null,null,null,s.right.remove(t,i))}return s.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),i=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,i)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),Ms=class{copy(e,t,i,s,r){return this}insert(e,t,i){return new ye(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},pe=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,ye.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,ye.BLACK,null,null))}get(e){let t,i=this.root_;for(;!i.isEmpty();){if(t=this.comparator_(e,i.key),t===0)return i.value;t<0?i=i.left:t>0&&(i=i.right)}return null}getPredecessorKey(e){let t,i=this.root_,s=null;for(;!i.isEmpty();)if(t=this.comparator_(e,i.key),t===0){if(i.left.isEmpty())return s?s.key:null;for(i=i.left;!i.right.isEmpty();)i=i.right;return i.key}else t<0?i=i.left:t>0&&(s=i,i=i.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Tt(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Tt(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Tt(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Tt(this.root_,null,this.comparator_,!0,e)}};pe.EMPTY_NODE=new Ms;function Eh(n,e){return st(n.name,e.name)}function Dr(n,e){return st(n,e)}var Fs;function Ch(n){Fs=n}var Il=function(n){return typeof n=="number"?"number:"+rl(n):"string:"+n},bl=function(n){if(n.isLeafNode()){let e=n.val();f(typeof e=="string"||typeof e=="number"||typeof e=="object"&&de(e,".sv"),"Priority must be a string or number.")}else f(n===Fs||n.isEmpty(),"priority of unexpected type.");f(n===Fs||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var La,St=(()=>{class n{static set __childrenNodeConstructor(t){La=t}static get __childrenNodeConstructor(){return La}constructor(t,i=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=i,this.lazyHash_=null,f(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),bl(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return v(t)?this:y(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,i){return null}updateImmediateChild(t,i){return t===".priority"?this.updatePriority(i):i.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,i).updatePriority(this.priorityNode_)}updateChild(t,i){let s=y(t);return s===null?i:i.isEmpty()&&s!==".priority"?this:(f(s!==".priority"||ze(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(s,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(S(t),i)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,i){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+Il(this.priorityNode_.val())+":");let i=typeof this.value_;t+=i+":",i==="number"?t+=rl(this.value_):t+=this.value_,this.lazyHash_=nl(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(f(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let i=typeof t.value_,s=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(i),o=n.VALUE_TYPE_ORDER.indexOf(s);return f(r>=0,"Unknown leaf type: "+i),f(o>=0,"Unknown leaf type: "+s),r===o?s==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let i=t;return this.value_===i.value_&&this.priorityNode_.equals(i.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),Sl,kl;function Th(n){Sl=n}function Ih(n){kl=n}var Ls=class extends bt{compare(e,t){let i=e.node.getPriority(),s=t.node.getPriority(),r=i.compareTo(s);return r===0?st(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return w.MIN}maxPost(){return new w(Me,new St("[PRIORITY-POST]",kl))}makePost(e,t){let i=Sl(e);return new w(t,new St("[PRIORITY-POST]",i))}toString(){return".priority"}},k=new Ls;var bh=Math.log(2),Ws=class{constructor(e){let t=r=>parseInt(Math.log(r)/bh,10),i=r=>parseInt(Array(r+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let s=i(this.count);this.bits_=e+1&s}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},ni=function(n,e,t,i){n.sort(e);let s=function(l,c){let u=c-l,h,d;if(u===0)return null;if(u===1)return h=n[l],d=t?t(h):h,new ye(d,h.node,ye.BLACK,null,null);{let p=parseInt(u/2,10)+l,_=s(l,p),E=s(p+1,c);return h=n[p],d=t?t(h):h,new ye(d,h.node,ye.BLACK,_,E)}},r=function(l){let c=null,u=null,h=n.length,d=function(_,E){let b=h-_,te=h;h-=_;let ne=s(b+1,te),A=n[b],ge=t?t(A):A;p(new ye(ge,A.node,E,null,ne))},p=function(_){c?(c.left=_,c=_):(u=_,c=_)};for(let _=0;_<l.count;++_){let E=l.nextBitIsOne(),b=Math.pow(2,l.count-(_+1));E?d(b,ye.BLACK):(d(b,ye.BLACK),d(b,ye.RED))}return u},o=new Ws(n.length),a=r(o);return new pe(i||e,a)};var ys,Et={},kt=class n{static get Default(){return f(Et&&k,"ChildrenNode.ts has not been loaded"),ys=ys||new n({".priority":Et},{".priority":k}),ys}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){let t=je(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof pe?t:null}hasIndex(e){return de(this.indexSet_,e.toString())}addIndex(e,t){f(e!==ke,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let i=[],s=!1,r=t.getIterator(w.Wrap),o=r.getNext();for(;o;)s=s||e.isDefinedOn(o.node),i.push(o),o=r.getNext();let a;s?a=ni(i,e.getCompare()):a=Et;let l=e.toString(),c=Object.assign({},this.indexSet_);c[l]=e;let u=Object.assign({},this.indexes_);return u[l]=a,new n(u,c)}addToIndexes(e,t){let i=Ht(this.indexes_,(s,r)=>{let o=je(this.indexSet_,r);if(f(o,"Missing index implementation for "+r),s===Et)if(o.isDefinedOn(e.node)){let a=[],l=t.getIterator(w.Wrap),c=l.getNext();for(;c;)c.name!==e.name&&a.push(c),c=l.getNext();return a.push(e),ni(a,o.getCompare())}else return Et;else{let a=t.get(e.name),l=s;return a&&(l=l.remove(new w(e.name,a))),l.insert(e,e.node)}});return new n(i,this.indexSet_)}removeFromIndexes(e,t){let i=Ht(this.indexes_,s=>{if(s===Et)return s;{let r=t.get(e.name);return r?s.remove(new w(e.name,r)):s}});return new n(i,this.indexSet_)}};var en,m=(()=>{class n{static get EMPTY_NODE(){return en||(en=new n(new pe(Dr),null,kt.Default))}constructor(t,i,s){this.children_=t,this.priorityNode_=i,this.indexMap_=s,this.lazyHash_=null,this.priorityNode_&&bl(this.priorityNode_),this.children_.isEmpty()&&f(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||en}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let i=this.children_.get(t);return i===null?en:i}}getChild(t){let i=y(t);return i===null?this:this.getImmediateChild(i).getChild(S(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,i){if(f(i,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(i);{let s=new w(t,i),r,o;i.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(s,this.children_)):(r=this.children_.insert(t,i),o=this.indexMap_.addToIndexes(s,this.children_));let a=r.isEmpty()?en:this.priorityNode_;return new n(r,a,o)}}updateChild(t,i){let s=y(t);if(s===null)return i;{f(y(t)!==".priority"||ze(t)===1,".priority must be the last token in a path");let r=this.getImmediateChild(s).updateChild(S(t),i);return this.updateImmediateChild(s,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let i={},s=0,r=0,o=!0;if(this.forEachChild(k,(a,l)=>{i[a]=l.val(t),s++,o&&n.INTEGER_REGEXP_.test(a)?r=Math.max(r,Number(a)):o=!1}),!t&&o&&r<2*s){let a=[];for(let l in i)a[l]=i[l];return a}else return t&&!this.getPriority().isEmpty()&&(i[".priority"]=this.getPriority().val()),i}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+Il(this.getPriority().val())+":"),this.forEachChild(k,(i,s)=>{let r=s.hash();r!==""&&(t+=":"+i+":"+r)}),this.lazyHash_=t===""?"":nl(t)}return this.lazyHash_}getPredecessorChildName(t,i,s){let r=this.resolveIndex_(s);if(r){let o=r.getPredecessorKey(new w(t,i));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let i=this.resolveIndex_(t);if(i){let s=i.minKey();return s&&s.name}else return this.children_.minKey()}getFirstChild(t){let i=this.getFirstChildName(t);return i?new w(i,this.children_.get(i)):null}getLastChildName(t){let i=this.resolveIndex_(t);if(i){let s=i.maxKey();return s&&s.name}else return this.children_.maxKey()}getLastChild(t){let i=this.getLastChildName(t);return i?new w(i,this.children_.get(i)):null}forEachChild(t,i){let s=this.resolveIndex_(t);return s?s.inorderTraversal(r=>i(r.name,r.node)):this.children_.inorderTraversal(i)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,i){let s=this.resolveIndex_(i);if(s)return s.getIteratorFrom(t,r=>r);{let r=this.children_.getIteratorFrom(t.name,w.Wrap),o=r.peek();for(;o!=null&&i.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,i){let s=this.resolveIndex_(i);if(s)return s.getReverseIteratorFrom(t,r=>r);{let r=this.children_.getReverseIteratorFrom(t.name,w.Wrap),o=r.peek();for(;o!=null&&i.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===In?-1:0}withIndex(t){if(t===ke||this.indexMap_.hasIndex(t))return this;{let i=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,i)}}isIndexed(t){return t===ke||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let i=t;if(this.getPriority().equals(i.getPriority()))if(this.children_.count()===i.children_.count()){let s=this.getIterator(k),r=i.getIterator(k),o=s.getNext(),a=r.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=s.getNext(),a=r.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(t){return t===ke?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Us=class extends m{constructor(){super(new pe(Dr),m.EMPTY_NODE,kt.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return m.EMPTY_NODE}isEmpty(){return!1}},In=new Us;Object.defineProperties(w,{MIN:{value:new w(Ke,m.EMPTY_NODE)},MAX:{value:new w(Me,In)}});ti.__EMPTY_NODE=m.EMPTY_NODE;St.__childrenNodeConstructor=m;Ch(In);Ih(In);var Sh=!0;function P(n,e=null){if(n===null)return m.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),f(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new St(t,P(e))}if(!(n instanceof Array)&&Sh){let t=[],i=!1;if(B(n,(o,a)=>{if(o.substring(0,1)!=="."){let l=P(a);l.isEmpty()||(i=i||!l.getPriority().isEmpty(),t.push(new w(o,l)))}}),t.length===0)return m.EMPTY_NODE;let r=ni(t,Eh,o=>o.name,Dr);if(i){let o=ni(t,k.getCompare());return new m(r,P(e),new kt({".priority":o},{".priority":k}))}else return new m(r,P(e),kt.Default)}else{let t=m.EMPTY_NODE;return B(n,(i,s)=>{if(de(n,i)&&i.substring(0,1)!=="."){let r=P(s);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(i,r))}}),t.updatePriority(P(e))}}Th(P);var un=class extends bt{constructor(e){super(),this.indexPath_=e,f(!v(e)&&y(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let i=this.extractChild(e.node),s=this.extractChild(t.node),r=i.compareTo(s);return r===0?st(e.name,t.name):r}makePost(e,t){let i=P(e),s=m.EMPTY_NODE.updateChild(this.indexPath_,i);return new w(t,s)}maxPost(){let e=m.EMPTY_NODE.updateChild(this.indexPath_,In);return new w(Me,e)}toString(){return cn(this.indexPath_,0).join("/")}};var js=class extends bt{compare(e,t){let i=e.node.compareTo(t.node);return i===0?st(e.name,t.name):i}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return w.MIN}maxPost(){return w.MAX}makePost(e,t){let i=P(e);return new w(t,i)}toString(){return".value"}},Or=new js;function Al(n){return{type:"value",snapshotNode:n}}function At(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function hn(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function dn(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function kh(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var fn=class{constructor(e){this.index_=e}updateChild(e,t,i,s,r,o){f(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(t);return a.getChild(s).equals(i.getChild(s))&&a.isEmpty()===i.isEmpty()||(o!=null&&(i.isEmpty()?e.hasChild(t)?o.trackChildChange(hn(t,a)):f(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(At(t,i)):o.trackChildChange(dn(t,i,a))),e.isLeafNode()&&i.isEmpty())?e:e.updateImmediateChild(t,i).withIndex(this.index_)}updateFullNode(e,t,i){return i!=null&&(e.isLeafNode()||e.forEachChild(k,(s,r)=>{t.hasChild(s)||i.trackChildChange(hn(s,r))}),t.isLeafNode()||t.forEachChild(k,(s,r)=>{if(e.hasChild(s)){let o=e.getImmediateChild(s);o.equals(r)||i.trackChildChange(dn(s,r,o))}else i.trackChildChange(At(s,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?m.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var ii=class n{constructor(e){this.indexedFilter_=new fn(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,i=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&i}updateChild(e,t,i,s,r,o){return this.matches(new w(t,i))||(i=m.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,i,s,r,o)}updateFullNode(e,t,i){t.isLeafNode()&&(t=m.EMPTY_NODE);let s=t.withIndex(this.index_);s=s.updatePriority(m.EMPTY_NODE);let r=this;return t.forEachChild(k,(o,a)=>{r.matches(new w(o,a))||(s=s.updateImmediateChild(o,m.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var Bs=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let i=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?i<=0:i<0},this.withinEndPost=t=>{let i=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?i<=0:i<0},this.rangedFilter_=new ii(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,i,s,r,o){return this.rangedFilter_.matches(new w(t,i))||(i=m.EMPTY_NODE),e.getImmediateChild(t).equals(i)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,i,s,r,o):this.fullLimitUpdateChild_(e,t,i,r,o)}updateFullNode(e,t,i){let s;if(t.isLeafNode()||t.isEmpty())s=m.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){s=m.EMPTY_NODE.withIndex(this.index_);let r;this.reverse_?r=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):r=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){let a=r.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))s=s.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{s=t.withIndex(this.index_),s=s.updatePriority(m.EMPTY_NODE);let r;this.reverse_?r=s.getReverseIterator(this.index_):r=s.getIterator(this.index_);let o=0;for(;r.hasNext();){let a=r.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:s=s.updateImmediateChild(a.name,m.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,s,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,i,s,r){let o;if(this.reverse_){let h=this.index_.getCompare();o=(d,p)=>h(p,d)}else o=this.index_.getCompare();let a=e;f(a.numChildren()===this.limit_,"");let l=new w(t,i),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(l);if(a.hasChild(t)){let h=a.getImmediateChild(t),d=s.getChildAfterChild(this.index_,c,this.reverse_);for(;d!=null&&(d.name===t||a.hasChild(d.name));)d=s.getChildAfterChild(this.index_,d,this.reverse_);let p=d==null?1:o(d,l);if(u&&!i.isEmpty()&&p>=0)return r?.trackChildChange(dn(t,i,h)),a.updateImmediateChild(t,i);{r?.trackChildChange(hn(t,h));let E=a.updateImmediateChild(t,m.EMPTY_NODE);return d!=null&&this.rangedFilter_.matches(d)?(r?.trackChildChange(At(d.name,d.node)),E.updateImmediateChild(d.name,d.node)):E}}else return i.isEmpty()?e:u&&o(c,l)>=0?(r!=null&&(r.trackChildChange(hn(c.name,c.node)),r.trackChildChange(At(t,i))),a.updateImmediateChild(t,i).updateImmediateChild(c.name,m.EMPTY_NODE)):e}};var pn=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=k}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return f(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return f(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Ke}hasEnd(){return this.endSet_}getIndexEndValue(){return f(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return f(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Me}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return f(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===k}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function Ah(n){return n.loadsAllData()?new fn(n.getIndex()):n.hasLimit()?new Bs(n):new ii(n)}function Rh(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function Ph(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function Vs(n,e,t){let i=n.copy();return i.startSet_=!0,e===void 0&&(e=null),i.indexStartValue_=e,t!=null?(i.startNameSet_=!0,i.indexStartName_=t):(i.startNameSet_=!1,i.indexStartName_=""),i}function Nh(n,e,t){let i;return n.index_===ke||t?i=Vs(n,e,t):i=Vs(n,e,Me),i.startAfterSet_=!0,i}function $s(n,e,t){let i=n.copy();return i.endSet_=!0,e===void 0&&(e=null),i.indexEndValue_=e,t!==void 0?(i.endNameSet_=!0,i.indexEndName_=t):(i.endNameSet_=!1,i.indexEndName_=""),i}function xh(n,e,t){let i;return n.index_===ke||t?i=$s(n,e,t):i=$s(n,e,Ke),i.endBeforeSet_=!0,i}function Ci(n,e){let t=n.copy();return t.index_=e,t}function Wa(n){let e={};if(n.isDefault())return e;let t;if(n.index_===k?t="$priority":n.index_===Or?t="$value":n.index_===ke?t="$key":(f(n.index_ instanceof un,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=D(t),n.startSet_){let i=n.startAfterSet_?"startAfter":"startAt";e[i]=D(n.indexStartValue_),n.startNameSet_&&(e[i]+=","+D(n.indexStartName_))}if(n.endSet_){let i=n.endBeforeSet_?"endBefore":"endAt";e[i]=D(n.indexEndValue_),n.endNameSet_&&(e[i]+=","+D(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function Ua(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==k&&(e.i=n.index_.toString()),e}var Hs=class n extends Jn{reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(f(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}constructor(e,t,i,s){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=i,this.appCheckTokenProvider_=s,this.log_=Tn("p:rest:"),this.listens_={}}listen(e,t,i,s){let r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);let o=n.getListenId_(e,i),a={};this.listens_[o]=a;let l=Wa(e._queryParams);this.restRequest_(r+".json",l,(c,u)=>{let h=u;if(c===404&&(h=null,c=null),c===null&&this.onDataUpdate_(r,h,!1,i),je(this.listens_,o)===a){let d;c?c===401?d="permission_denied":d="rest_error:"+c:d="ok",s(d,null)}})}unlisten(e,t){let i=n.getListenId_(e,t);delete this.listens_[i]}get(e){let t=Wa(e._queryParams),i=e._path.toString(),s=new U;return this.restRequest_(i+".json",t,(r,o)=>{let a=o;r===404&&(a=null,r=null),r===null?(this.onDataUpdate_(i,a,!1,null),s.resolve(a)):s.reject(new Error(a))}),s.promise}refreshAuthToken(e){}restRequest_(e,t={},i){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([s,r])=>{s&&s.accessToken&&(t.auth=s.accessToken),r&&r.token&&(t.ac=r.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Xo(t);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(i&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let l=null;if(a.status>=200&&a.status<300){try{l=Bn(a.responseText)}catch{H("Failed to parse JSON response for "+o+": "+a.responseText)}i(null,l)}else a.status!==401&&a.status!==404&&H("Got unsuccessful REST response for "+o+" Status: "+a.status),i(a.status);i=null}},a.open("GET",o,!0),a.send()})}};var Gs=class{constructor(){this.rootNode_=m.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function si(){return{value:null,children:new Map}}function Ot(n,e,t){if(v(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let i=y(e);n.children.has(i)||n.children.set(i,si());let s=n.children.get(i);e=S(e),Ot(s,e,t)}}function qs(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(k,(i,s)=>{Ot(n,new I(i),s)}),qs(n,e)}}else if(n.children.size>0){let t=y(e);return e=S(e),n.children.has(t)&&qs(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Ks(n,e,t){n.value!==null?t(e,n.value):Dh(n,(i,s)=>{let r=new I(e.toString()+"/"+i);Ks(s,r,t)})}function Dh(n,e){n.children.forEach((t,i)=>{e(i,t)})}var zs=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&B(this.last_,(i,s)=>{t[i]=t[i]-s}),this.last_=e,t}};var ja=10*1e3,Oh=30*1e3,Mh=300*1e3,Ys=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new zs(e);let i=ja+(Oh-ja)*Math.random();nn(this.reportStats_.bind(this),Math.floor(i))}reportStats_(){let e=this.statsListener_.get(),t={},i=!1;B(e,(s,r)=>{r>0&&de(this.statsToReport_,s)&&(t[s]=r,i=!0)}),i&&this.server_.reportStats(t),nn(this.reportStats_.bind(this),Math.floor(Math.random()*2*Mh))}};var Se=(function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n})(Se||{});function Mr(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Fr(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Lr(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var Qs=class n{constructor(e,t,i){this.path=e,this.affectedTree=t,this.revert=i,this.type=Se.ACK_USER_WRITE,this.source=Mr()}operationForChild(e){if(v(this.path)){if(this.affectedTree.value!=null)return f(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new I(e));return new n(T(),t,this.revert)}}else return f(y(this.path)===e,"operationForChild called for unrelated child."),new n(S(this.path),this.affectedTree,this.revert)}};var ri=class n{constructor(e,t){this.source=e,this.path=t,this.type=Se.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new n(this.source,T()):new n(this.source,S(this.path))}};var Rt=class n{constructor(e,t,i){this.source=e,this.path=t,this.snap=i,this.type=Se.OVERWRITE}operationForChild(e){return v(this.path)?new n(this.source,T(),this.snap.getImmediateChild(e)):new n(this.source,S(this.path),this.snap)}};var _n=class n{constructor(e,t,i){this.source=e,this.path=t,this.children=i,this.type=Se.MERGE}operationForChild(e){if(v(this.path)){let t=this.children.subtree(new I(e));return t.isEmpty()?null:t.value?new Rt(this.source,T(),t.value):new n(this.source,T(),t)}else return f(y(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,S(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var Re=class{constructor(e,t,i){this.node_=e,this.fullyInitialized_=t,this.filtered_=i}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;let t=y(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var Xs=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Fh(n,e,t,i){let s=[],r=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(kh(o.childName,o.snapshotNode))}),tn(n,s,"child_removed",e,i,t),tn(n,s,"child_added",e,i,t),tn(n,s,"child_moved",r,i,t),tn(n,s,"child_changed",e,i,t),tn(n,s,"value",e,i,t),s}function tn(n,e,t,i,s,r){let o=i.filter(a=>a.type===t);o.sort((a,l)=>Wh(n,a,l)),o.forEach(a=>{let l=Lh(n,a,r);s.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(l,n.query_))})})}function Lh(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function Wh(n,e,t){if(e.childName==null||t.childName==null)throw gt("Should only compare child_ events.");let i=new w(e.childName,e.snapshotNode),s=new w(t.childName,t.snapshotNode);return n.index_.compare(i,s)}function Ti(n,e){return{eventCache:n,serverCache:e}}function rn(n,e,t,i){return Ti(new Re(e,t,i),n.serverCache)}function Rl(n,e,t,i){return Ti(n.eventCache,new Re(e,t,i))}function oi(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function it(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var vs,Uh=()=>(vs||(vs=new pe(Lu)),vs),Y=class n{static fromObject(e){let t=new n(null);return B(e,(i,s)=>{t=t.set(new I(i),s)}),t}constructor(e,t=Uh()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:T(),value:this.value};if(v(e))return null;{let i=y(e),s=this.children.get(i);if(s!==null){let r=s.findRootMostMatchingPathAndValue(S(e),t);return r!=null?{path:R(new I(i),r.path),value:r.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{let t=y(e),i=this.children.get(t);return i!==null?i.subtree(S(e)):new n(null)}}set(e,t){if(v(e))return new n(t,this.children);{let i=y(e),r=(this.children.get(i)||new n(null)).set(S(e),t),o=this.children.insert(i,r);return new n(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=y(e),i=this.children.get(t);if(i){let s=i.remove(S(e)),r;return s.isEmpty()?r=this.children.remove(t):r=this.children.insert(t,s),this.value===null&&r.isEmpty()?new n(null):new n(this.value,r)}else return this}}get(e){if(v(e))return this.value;{let t=y(e),i=this.children.get(t);return i?i.get(S(e)):null}}setTree(e,t){if(v(e))return t;{let i=y(e),r=(this.children.get(i)||new n(null)).setTree(S(e),t),o;return r.isEmpty()?o=this.children.remove(i):o=this.children.insert(i,r),new n(this.value,o)}}fold(e){return this.fold_(T(),e)}fold_(e,t){let i={};return this.children.inorderTraversal((s,r)=>{i[s]=r.fold_(R(e,s),t)}),t(e,this.value,i)}findOnPath(e,t){return this.findOnPath_(e,T(),t)}findOnPath_(e,t,i){let s=this.value?i(t,this.value):!1;if(s)return s;if(v(e))return null;{let r=y(e),o=this.children.get(r);return o?o.findOnPath_(S(e),R(t,r),i):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,T(),t)}foreachOnPath_(e,t,i){if(v(e))return this;{this.value&&i(t,this.value);let s=y(e),r=this.children.get(s);return r?r.foreachOnPath_(S(e),R(t,s),i):new n(null)}}foreach(e){this.foreach_(T(),e)}foreach_(e,t){this.children.inorderTraversal((i,s)=>{s.foreach_(R(e,i),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,i)=>{i.value&&e(t,i.value)})}};var ve=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new Y(null))}};function on(n,e,t){if(v(e))return new ve(new Y(t));{let i=n.writeTree_.findRootMostValueAndPath(e);if(i!=null){let s=i.path,r=i.value,o=z(s,e);return r=r.updateChild(o,t),new ve(n.writeTree_.set(s,r))}else{let s=new Y(t),r=n.writeTree_.setTree(e,s);return new ve(r)}}}function Js(n,e,t){let i=n;return B(t,(s,r)=>{i=on(i,R(e,s),r)}),i}function Ba(n,e){if(v(e))return ve.empty();{let t=n.writeTree_.setTree(e,new Y(null));return new ve(t)}}function Zs(n,e){return rt(n,e)!=null}function rt(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(z(t.path,e)):null}function Va(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(k,(i,s)=>{e.push(new w(i,s))}):n.writeTree_.children.inorderTraversal((i,s)=>{s.value!=null&&e.push(new w(i,s.value))}),e}function Ge(n,e){if(v(e))return n;{let t=rt(n,e);return t!=null?new ve(new Y(t)):new ve(n.writeTree_.subtree(e))}}function er(n){return n.writeTree_.isEmpty()}function Pt(n,e){return Pl(T(),n.writeTree_,e)}function Pl(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let i=null;return e.children.inorderTraversal((s,r)=>{s===".priority"?(f(r.value!==null,"Priority writes must always be leaf nodes"),i=r.value):t=Pl(R(n,s),r,t)}),!t.getChild(n).isEmpty()&&i!==null&&(t=t.updateChild(R(n,".priority"),i)),t}}function Ii(n,e){return Ol(e,n)}function jh(n,e,t,i,s){f(i>n.lastWriteId,"Stacking an older write on top of newer ones"),s===void 0&&(s=!0),n.allWrites.push({path:e,snap:t,writeId:i,visible:s}),s&&(n.visibleWrites=on(n.visibleWrites,e,t)),n.lastWriteId=i}function Bh(n,e,t,i){f(i>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:i,visible:!0}),n.visibleWrites=Js(n.visibleWrites,e,t),n.lastWriteId=i}function Vh(n,e){for(let t=0;t<n.allWrites.length;t++){let i=n.allWrites[t];if(i.writeId===e)return i}return null}function $h(n,e){let t=n.allWrites.findIndex(a=>a.writeId===e);f(t>=0,"removeWrite called with nonexistent writeId.");let i=n.allWrites[t];n.allWrites.splice(t,1);let s=i.visible,r=!1,o=n.allWrites.length-1;for(;s&&o>=0;){let a=n.allWrites[o];a.visible&&(o>=t&&Hh(a,i.path)?s=!1:fe(i.path,a.path)&&(r=!0)),o--}if(s){if(r)return Gh(n),!0;if(i.snap)n.visibleWrites=Ba(n.visibleWrites,i.path);else{let a=i.children;B(a,l=>{n.visibleWrites=Ba(n.visibleWrites,R(i.path,l))})}return!0}else return!1}function Hh(n,e){if(n.snap)return fe(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&fe(R(n.path,t),e))return!0;return!1}function Gh(n){n.visibleWrites=Nl(n.allWrites,qh,T()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function qh(n){return n.visible}function Nl(n,e,t){let i=ve.empty();for(let s=0;s<n.length;++s){let r=n[s];if(e(r)){let o=r.path,a;if(r.snap)fe(t,o)?(a=z(t,o),i=on(i,a,r.snap)):fe(o,t)&&(a=z(o,t),i=on(i,T(),r.snap.getChild(a)));else if(r.children){if(fe(t,o))a=z(t,o),i=Js(i,a,r.children);else if(fe(o,t))if(a=z(o,t),v(a))i=Js(i,T(),r.children);else{let l=je(r.children,y(a));if(l){let c=l.getChild(S(a));i=on(i,T(),c)}}}else throw gt("WriteRecord should have .snap or .children")}}return i}function xl(n,e,t,i,s){if(!i&&!s){let r=rt(n.visibleWrites,e);if(r!=null)return r;{let o=Ge(n.visibleWrites,e);if(er(o))return t;if(t==null&&!Zs(o,T()))return null;{let a=t||m.EMPTY_NODE;return Pt(o,a)}}}else{let r=Ge(n.visibleWrites,e);if(!s&&er(r))return t;if(!s&&t==null&&!Zs(r,T()))return null;{let o=function(c){return(c.visible||s)&&(!i||!~i.indexOf(c.writeId))&&(fe(c.path,e)||fe(e,c.path))},a=Nl(n.allWrites,o,e),l=t||m.EMPTY_NODE;return Pt(a,l)}}}function Kh(n,e,t){let i=m.EMPTY_NODE,s=rt(n.visibleWrites,e);if(s)return s.isLeafNode()||s.forEachChild(k,(r,o)=>{i=i.updateImmediateChild(r,o)}),i;if(t){let r=Ge(n.visibleWrites,e);return t.forEachChild(k,(o,a)=>{let l=Pt(Ge(r,new I(o)),a);i=i.updateImmediateChild(o,l)}),Va(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}else{let r=Ge(n.visibleWrites,e);return Va(r).forEach(o=>{i=i.updateImmediateChild(o.name,o.node)}),i}}function zh(n,e,t,i,s){f(i||s,"Either existingEventSnap or existingServerSnap must exist");let r=R(e,t);if(Zs(n.visibleWrites,r))return null;{let o=Ge(n.visibleWrites,r);return er(o)?s.getChild(t):Pt(o,s.getChild(t))}}function Yh(n,e,t,i){let s=R(e,t),r=rt(n.visibleWrites,s);if(r!=null)return r;if(i.isCompleteForChild(t)){let o=Ge(n.visibleWrites,s);return Pt(o,i.getNode().getImmediateChild(t))}else return null}function Qh(n,e){return rt(n.visibleWrites,e)}function Xh(n,e,t,i,s,r,o){let a,l=Ge(n.visibleWrites,e),c=rt(l,T());if(c!=null)a=c;else if(t!=null)a=Pt(l,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let u=[],h=o.getCompare(),d=r?a.getReverseIteratorFrom(i,o):a.getIteratorFrom(i,o),p=d.getNext();for(;p&&u.length<s;)h(p,i)!==0&&u.push(p),p=d.getNext();return u}else return[]}function Jh(){return{visibleWrites:ve.empty(),allWrites:[],lastWriteId:-1}}function ai(n,e,t,i){return xl(n.writeTree,n.treePath,e,t,i)}function Wr(n,e){return Kh(n.writeTree,n.treePath,e)}function $a(n,e,t,i){return zh(n.writeTree,n.treePath,e,t,i)}function li(n,e){return Qh(n.writeTree,R(n.treePath,e))}function Zh(n,e,t,i,s,r){return Xh(n.writeTree,n.treePath,e,t,i,s,r)}function Ur(n,e,t){return Yh(n.writeTree,n.treePath,e,t)}function Dl(n,e){return Ol(R(n.treePath,e),n.writeTree)}function Ol(n,e){return{treePath:n,writeTree:e}}var tr=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,i=e.childName;f(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),f(i!==".priority","Only non-priority child changes can be tracked.");let s=this.changeMap.get(i);if(s){let r=s.type;if(t==="child_added"&&r==="child_removed")this.changeMap.set(i,dn(i,e.snapshotNode,s.snapshotNode));else if(t==="child_removed"&&r==="child_added")this.changeMap.delete(i);else if(t==="child_removed"&&r==="child_changed")this.changeMap.set(i,hn(i,s.oldSnap));else if(t==="child_changed"&&r==="child_added")this.changeMap.set(i,At(i,e.snapshotNode));else if(t==="child_changed"&&r==="child_changed")this.changeMap.set(i,dn(i,e.snapshotNode,s.oldSnap));else throw gt("Illegal combination of changes: "+e+" occurred after "+s)}else this.changeMap.set(i,e)}getChanges(){return Array.from(this.changeMap.values())}};var nr=class{getCompleteChild(e){return null}getChildAfterChild(e,t,i){return null}},Ml=new nr,gn=class{constructor(e,t,i=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=i}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let i=this.optCompleteServerCache_!=null?new Re(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Ur(this.writes_,e,i)}}getChildAfterChild(e,t,i){let s=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:it(this.viewCache_),r=Zh(this.writes_,s,t,1,i,e);return r.length===0?null:r[0]}};function ed(n){return{filter:n}}function td(n,e){f(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),f(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function nd(n,e,t,i,s){let r=new tr,o,a;if(t.type===Se.OVERWRITE){let c=t;c.source.fromUser?o=ir(n,e,c.path,c.snap,i,s,r):(f(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!v(c.path),o=ci(n,e,c.path,c.snap,i,s,a,r))}else if(t.type===Se.MERGE){let c=t;c.source.fromUser?o=sd(n,e,c.path,c.children,i,s,r):(f(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=sr(n,e,c.path,c.children,i,s,a,r))}else if(t.type===Se.ACK_USER_WRITE){let c=t;c.revert?o=ad(n,e,c.path,i,s,r):o=rd(n,e,c.path,c.affectedTree,i,s,r)}else if(t.type===Se.LISTEN_COMPLETE)o=od(n,e,t.path,i,r);else throw gt("Unknown operation type: "+t.type);let l=r.getChanges();return id(e,o,l),{viewCache:o,changes:l}}function id(n,e,t){let i=e.eventCache;if(i.isFullyInitialized()){let s=i.getNode().isLeafNode()||i.getNode().isEmpty(),r=oi(n);(t.length>0||!n.eventCache.isFullyInitialized()||s&&!i.getNode().equals(r)||!i.getNode().getPriority().equals(r.getPriority()))&&t.push(Al(oi(e)))}}function Fl(n,e,t,i,s,r){let o=e.eventCache;if(li(i,t)!=null)return e;{let a,l;if(v(t))if(f(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=it(e),u=c instanceof m?c:m.EMPTY_NODE,h=Wr(i,u);a=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{let c=ai(i,it(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,r)}else{let c=y(t);if(c===".priority"){f(ze(t)===1,"Can't have a priority with additional path components");let u=o.getNode();l=e.serverCache.getNode();let h=$a(i,t,u,l);h!=null?a=n.filter.updatePriority(u,h):a=o.getNode()}else{let u=S(t),h;if(o.isCompleteForChild(c)){l=e.serverCache.getNode();let d=$a(i,t,o.getNode(),l);d!=null?h=o.getNode().getImmediateChild(c).updateChild(u,d):h=o.getNode().getImmediateChild(c)}else h=Ur(i,c,e.serverCache);h!=null?a=n.filter.updateChild(o.getNode(),c,h,u,s,r):a=o.getNode()}}return rn(e,a,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function ci(n,e,t,i,s,r,o,a){let l=e.serverCache,c,u=o?n.filter:n.filter.getIndexedFilter();if(v(t))c=u.updateFullNode(l.getNode(),i,null);else if(u.filtersNodes()&&!l.isFiltered()){let p=l.getNode().updateChild(t,i);c=u.updateFullNode(l.getNode(),p,null)}else{let p=y(t);if(!l.isCompleteForPath(t)&&ze(t)>1)return e;let _=S(t),b=l.getNode().getImmediateChild(p).updateChild(_,i);p===".priority"?c=u.updatePriority(l.getNode(),b):c=u.updateChild(l.getNode(),p,b,_,Ml,null)}let h=Rl(e,c,l.isFullyInitialized()||v(t),u.filtersNodes()),d=new gn(s,h,r);return Fl(n,h,t,s,d,a)}function ir(n,e,t,i,s,r,o){let a=e.eventCache,l,c,u=new gn(s,e,r);if(v(t))c=n.filter.updateFullNode(e.eventCache.getNode(),i,o),l=rn(e,c,!0,n.filter.filtersNodes());else{let h=y(t);if(h===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),i),l=rn(e,c,a.isFullyInitialized(),a.isFiltered());else{let d=S(t),p=a.getNode().getImmediateChild(h),_;if(v(d))_=i;else{let E=u.getCompleteChild(h);E!=null?Pr(d)===".priority"&&E.getChild(Cl(d)).isEmpty()?_=E:_=E.updateChild(d,i):_=m.EMPTY_NODE}if(p.equals(_))l=e;else{let E=n.filter.updateChild(a.getNode(),h,_,d,u,o);l=rn(e,E,a.isFullyInitialized(),n.filter.filtersNodes())}}}return l}function Ha(n,e){return n.eventCache.isCompleteForChild(e)}function sd(n,e,t,i,s,r,o){let a=e;return i.foreach((l,c)=>{let u=R(t,l);Ha(e,y(u))&&(a=ir(n,a,u,c,s,r,o))}),i.foreach((l,c)=>{let u=R(t,l);Ha(e,y(u))||(a=ir(n,a,u,c,s,r,o))}),a}function Ga(n,e,t){return t.foreach((i,s)=>{e=e.updateChild(i,s)}),e}function sr(n,e,t,i,s,r,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let l=e,c;v(t)?c=i:c=new Y(null).setTree(t,i);let u=e.serverCache.getNode();return c.children.inorderTraversal((h,d)=>{if(u.hasChild(h)){let p=e.serverCache.getNode().getImmediateChild(h),_=Ga(n,p,d);l=ci(n,l,new I(h),_,s,r,o,a)}}),c.children.inorderTraversal((h,d)=>{let p=!e.serverCache.isCompleteForChild(h)&&d.value===null;if(!u.hasChild(h)&&!p){let _=e.serverCache.getNode().getImmediateChild(h),E=Ga(n,_,d);l=ci(n,l,new I(h),E,s,r,o,a)}}),l}function rd(n,e,t,i,s,r,o){if(li(s,t)!=null)return e;let a=e.serverCache.isFiltered(),l=e.serverCache;if(i.value!=null){if(v(t)&&l.isFullyInitialized()||l.isCompleteForPath(t))return ci(n,e,t,l.getNode().getChild(t),s,r,a,o);if(v(t)){let c=new Y(null);return l.getNode().forEachChild(ke,(u,h)=>{c=c.set(new I(u),h)}),sr(n,e,t,c,s,r,a,o)}else return e}else{let c=new Y(null);return i.foreach((u,h)=>{let d=R(t,u);l.isCompleteForPath(d)&&(c=c.set(u,l.getNode().getChild(d)))}),sr(n,e,t,c,s,r,a,o)}}function od(n,e,t,i,s){let r=e.serverCache,o=Rl(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered());return Fl(n,o,t,i,Ml,s)}function ad(n,e,t,i,s,r){let o;if(li(i,t)!=null)return e;{let a=new gn(i,e,s),l=e.eventCache.getNode(),c;if(v(t)||y(t)===".priority"){let u;if(e.serverCache.isFullyInitialized())u=ai(i,it(e));else{let h=e.serverCache.getNode();f(h instanceof m,"serverChildren would be complete if leaf node"),u=Wr(i,h)}u=u,c=n.filter.updateFullNode(l,u,r)}else{let u=y(t),h=Ur(i,u,e.serverCache);h==null&&e.serverCache.isCompleteForChild(u)&&(h=l.getImmediateChild(u)),h!=null?c=n.filter.updateChild(l,u,h,S(t),a,r):e.eventCache.getNode().hasChild(u)?c=n.filter.updateChild(l,u,m.EMPTY_NODE,S(t),a,r):c=l,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=ai(i,it(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,r)))}return o=e.serverCache.isFullyInitialized()||li(i,T())!=null,rn(e,c,o,n.filter.filtersNodes())}}var rr=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let i=this.query_._queryParams,s=new fn(i.getIndex()),r=Ah(i);this.processor_=ed(r);let o=t.serverCache,a=t.eventCache,l=s.updateFullNode(m.EMPTY_NODE,o.getNode(),null),c=r.updateFullNode(m.EMPTY_NODE,a.getNode(),null),u=new Re(l,o.isFullyInitialized(),s.filtersNodes()),h=new Re(c,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=Ti(h,u),this.eventGenerator_=new Xs(this.query_)}get query(){return this.query_}};function ld(n){return n.viewCache_.serverCache.getNode()}function cd(n){return oi(n.viewCache_)}function ud(n,e){let t=it(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(y(e)).isEmpty())?t.getChild(e):null}function qa(n){return n.eventRegistrations_.length===0}function hd(n,e){n.eventRegistrations_.push(e)}function Ka(n,e,t){let i=[];if(t){f(e==null,"A cancel should cancel all event registrations.");let s=n.query._path;n.eventRegistrations_.forEach(r=>{let o=r.createCancelEvent(t,s);o&&i.push(o)})}if(e){let s=[];for(let r=0;r<n.eventRegistrations_.length;++r){let o=n.eventRegistrations_[r];if(!o.matches(e))s.push(o);else if(e.hasAnyCallback()){s=s.concat(n.eventRegistrations_.slice(r+1));break}}n.eventRegistrations_=s}else n.eventRegistrations_=[];return i}function za(n,e,t,i){e.type===Se.MERGE&&e.source.queryId!==null&&(f(it(n.viewCache_),"We should always have a full cache before handling merges"),f(oi(n.viewCache_),"Missing event cache, even though we have a server cache"));let s=n.viewCache_,r=nd(n.processor_,s,e,t,i);return td(n.processor_,r.viewCache),f(r.viewCache.serverCache.isFullyInitialized()||!s.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Ll(n,r.changes,r.viewCache.eventCache.getNode(),null)}function dd(n,e){let t=n.viewCache_.eventCache,i=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(k,(r,o)=>{i.push(At(r,o))}),t.isFullyInitialized()&&i.push(Al(t.getNode())),Ll(n,i,t.getNode(),e)}function Ll(n,e,t,i){let s=i?[i]:n.eventRegistrations_;return Fh(n.eventGenerator_,e,t,s)}var ui,hi=class{constructor(){this.views=new Map}};function fd(n){f(!ui,"__referenceConstructor has already been defined"),ui=n}function pd(){return f(ui,"Reference.ts has not been loaded"),ui}function _d(n){return n.views.size===0}function jr(n,e,t,i){let s=e.source.queryId;if(s!==null){let r=n.views.get(s);return f(r!=null,"SyncTree gave us an op for an invalid query."),za(r,e,t,i)}else{let r=[];for(let o of n.views.values())r=r.concat(za(o,e,t,i));return r}}function Wl(n,e,t,i,s){let r=e._queryIdentifier,o=n.views.get(r);if(!o){let a=ai(t,s?i:null),l=!1;a?l=!0:i instanceof m?(a=Wr(t,i),l=!1):(a=m.EMPTY_NODE,l=!1);let c=Ti(new Re(a,l,!1),new Re(i,s,!1));return new rr(e,c)}return o}function gd(n,e,t,i,s,r){let o=Wl(n,e,i,s,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),hd(o,t),dd(o,t)}function md(n,e,t,i){let s=e._queryIdentifier,r=[],o=[],a=Ye(n);if(s==="default")for(let[l,c]of n.views.entries())o=o.concat(Ka(c,t,i)),qa(c)&&(n.views.delete(l),c.query._queryParams.loadsAllData()||r.push(c.query));else{let l=n.views.get(s);l&&(o=o.concat(Ka(l,t,i)),qa(l)&&(n.views.delete(s),l.query._queryParams.loadsAllData()||r.push(l.query)))}return a&&!Ye(n)&&r.push(new(pd())(e._repo,e._path)),{removed:r,events:o}}function Ul(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function qe(n,e){let t=null;for(let i of n.views.values())t=t||ud(i,e);return t}function jl(n,e){if(e._queryParams.loadsAllData())return bi(n);{let i=e._queryIdentifier;return n.views.get(i)}}function Bl(n,e){return jl(n,e)!=null}function Ye(n){return bi(n)!=null}function bi(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var di;function yd(n){f(!di,"__referenceConstructor has already been defined"),di=n}function vd(){return f(di,"Reference.ts has not been loaded"),di}var wd=1,fi=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new Y(null),this.pendingWriteTree_=Jh(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function Br(n,e,t,i,s){return jh(n.pendingWriteTree_,e,t,i,s),s?Mt(n,new Rt(Mr(),e,t)):[]}function Ed(n,e,t,i){Bh(n.pendingWriteTree_,e,t,i);let s=Y.fromObject(t);return Mt(n,new _n(Mr(),e,s))}function He(n,e,t=!1){let i=Vh(n.pendingWriteTree_,e);if($h(n.pendingWriteTree_,e)){let r=new Y(null);return i.snap!=null?r=r.set(T(),!0):B(i.children,o=>{r=r.set(new I(o),!0)}),Mt(n,new Qs(i.path,r,t))}else return[]}function bn(n,e,t){return Mt(n,new Rt(Fr(),e,t))}function Cd(n,e,t){let i=Y.fromObject(t);return Mt(n,new _n(Fr(),e,i))}function Td(n,e){return Mt(n,new ri(Fr(),e))}function Id(n,e,t){let i=Vr(n,t);if(i){let s=$r(i),r=s.path,o=s.queryId,a=z(r,e),l=new ri(Lr(o),a);return Hr(n,r,l)}else return[]}function pi(n,e,t,i,s=!1){let r=e._path,o=n.syncPointTree_.get(r),a=[];if(o&&(e._queryIdentifier==="default"||Bl(o,e))){let l=md(o,e,t,i);_d(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));let c=l.removed;if(a=l.events,!s){let u=c.findIndex(d=>d._queryParams.loadsAllData())!==-1,h=n.syncPointTree_.findOnPath(r,(d,p)=>Ye(p));if(u&&!h){let d=n.syncPointTree_.subtree(r);if(!d.isEmpty()){let p=kd(d);for(let _=0;_<p.length;++_){let E=p[_],b=E.query,te=Gl(n,E);n.listenProvider_.startListening(an(b),mn(n,b),te.hashFn,te.onComplete)}}}!h&&c.length>0&&!i&&(u?n.listenProvider_.stopListening(an(e),null):c.forEach(d=>{let p=n.queryToTagMap.get(ki(d));n.listenProvider_.stopListening(an(d),p)}))}Ad(n,c)}return a}function Vl(n,e,t,i){let s=Vr(n,i);if(s!=null){let r=$r(s),o=r.path,a=r.queryId,l=z(o,e),c=new Rt(Lr(a),l,t);return Hr(n,o,c)}else return[]}function bd(n,e,t,i){let s=Vr(n,i);if(s){let r=$r(s),o=r.path,a=r.queryId,l=z(o,e),c=Y.fromObject(t),u=new _n(Lr(a),l,c);return Hr(n,o,u)}else return[]}function or(n,e,t,i=!1){let s=e._path,r=null,o=!1;n.syncPointTree_.foreachOnPath(s,(d,p)=>{let _=z(d,s);r=r||qe(p,_),o=o||Ye(p)});let a=n.syncPointTree_.get(s);a?(o=o||Ye(a),r=r||qe(a,T())):(a=new hi,n.syncPointTree_=n.syncPointTree_.set(s,a));let l;r!=null?l=!0:(l=!1,r=m.EMPTY_NODE,n.syncPointTree_.subtree(s).foreachChild((p,_)=>{let E=qe(_,T());E&&(r=r.updateImmediateChild(p,E))}));let c=Bl(a,e);if(!c&&!e._queryParams.loadsAllData()){let d=ki(e);f(!n.queryToTagMap.has(d),"View does not exist, but we have a tag");let p=Rd();n.queryToTagMap.set(d,p),n.tagToQueryMap.set(p,d)}let u=Ii(n.pendingWriteTree_,s),h=gd(a,e,t,u,r,l);if(!c&&!o&&!i){let d=jl(a,e);h=h.concat(Pd(n,e,d))}return h}function Si(n,e,t){let s=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,a)=>{let l=z(o,e),c=qe(a,l);if(c)return c});return xl(s,e,r,t,!0)}function Sd(n,e){let t=e._path,i=null;n.syncPointTree_.foreachOnPath(t,(c,u)=>{let h=z(c,t);i=i||qe(u,h)});let s=n.syncPointTree_.get(t);s?i=i||qe(s,T()):(s=new hi,n.syncPointTree_=n.syncPointTree_.set(t,s));let r=i!=null,o=r?new Re(i,!0,!1):null,a=Ii(n.pendingWriteTree_,e._path),l=Wl(s,e,a,r?o.getNode():m.EMPTY_NODE,r);return cd(l)}function Mt(n,e){return $l(e,n.syncPointTree_,null,Ii(n.pendingWriteTree_,T()))}function $l(n,e,t,i){if(v(n.path))return Hl(n,e,t,i);{let s=e.get(T());t==null&&s!=null&&(t=qe(s,T()));let r=[],o=y(n.path),a=n.operationForChild(o),l=e.children.get(o);if(l&&a){let c=t?t.getImmediateChild(o):null,u=Dl(i,o);r=r.concat($l(a,l,c,u))}return s&&(r=r.concat(jr(s,n,i,t))),r}}function Hl(n,e,t,i){let s=e.get(T());t==null&&s!=null&&(t=qe(s,T()));let r=[];return e.children.inorderTraversal((o,a)=>{let l=t?t.getImmediateChild(o):null,c=Dl(i,o),u=n.operationForChild(o);u&&(r=r.concat(Hl(u,a,l,c)))}),s&&(r=r.concat(jr(s,n,i,t))),r}function Gl(n,e){let t=e.query,i=mn(n,t);return{hashFn:()=>(ld(e)||m.EMPTY_NODE).hash(),onComplete:s=>{if(s==="ok")return i?Id(n,t._path,i):Td(n,t._path);{let r=ju(s,t);return pi(n,t,null,r)}}}}function mn(n,e){let t=ki(e);return n.queryToTagMap.get(t)}function ki(n){return n._path.toString()+"$"+n._queryIdentifier}function Vr(n,e){return n.tagToQueryMap.get(e)}function $r(n){let e=n.indexOf("$");return f(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new I(n.substr(0,e))}}function Hr(n,e,t){let i=n.syncPointTree_.get(e);f(i,"Missing sync point for query tag that we're tracking");let s=Ii(n.pendingWriteTree_,e);return jr(i,t,s,null)}function kd(n){return n.fold((e,t,i)=>{if(t&&Ye(t))return[bi(t)];{let s=[];return t&&(s=Ul(t)),B(i,(r,o)=>{s=s.concat(o)}),s}})}function an(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(vd())(n._repo,n._path):n}function Ad(n,e){for(let t=0;t<e.length;++t){let i=e[t];if(!i._queryParams.loadsAllData()){let s=ki(i),r=n.queryToTagMap.get(s);n.queryToTagMap.delete(s),n.tagToQueryMap.delete(r)}}}function Rd(){return wd++}function Pd(n,e,t){let i=e._path,s=mn(n,e),r=Gl(n,t),o=n.listenProvider_.startListening(an(e),s,r.hashFn,r.onComplete),a=n.syncPointTree_.subtree(i);if(s)f(!Ye(a.value),"If we're adding a query, it shouldn't be shadowed");else{let l=a.fold((c,u,h)=>{if(!v(c)&&u&&Ye(u))return[bi(u).query];{let d=[];return u&&(d=d.concat(Ul(u).map(p=>p.query))),B(h,(p,_)=>{d=d.concat(_)}),d}});for(let c=0;c<l.length;++c){let u=l[c];n.listenProvider_.stopListening(an(u),mn(n,u))}}return o}var ar=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},lr=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=R(this.path_,e);return new n(this.syncTree_,t)}node(){return Si(this.syncTree_,this.path_)}},Nd=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Ya=function(n,e,t){if(!n||typeof n!="object")return n;if(f(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return xd(n[".sv"],e,t);if(typeof n[".sv"]=="object")return Dd(n[".sv"],e);f(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},xd=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:f(!1,"Unexpected server value: "+n)}},Dd=function(n,e,t){n.hasOwnProperty("increment")||f(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let i=n.increment;typeof i!="number"&&f(!1,"Unexpected increment value: "+i);let s=e.node();if(f(s!==null&&typeof s<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!s.isLeafNode())return i;let o=s.getValue();return typeof o!="number"?i:o+i},ql=function(n,e,t,i){return qr(e,new lr(t,n),i)},Gr=function(n,e,t){return qr(n,new ar(e),t)};function qr(n,e,t){let i=n.getPriority().val(),s=Ya(i,e.getImmediateChild(".priority"),t),r;if(n.isLeafNode()){let o=n,a=Ya(o.getValue(),e,t);return a!==o.getValue()||s!==o.getPriority().val()?new St(a,P(s)):n}else{let o=n;return r=o,s!==o.getPriority().val()&&(r=r.updatePriority(new St(s))),o.forEachChild(k,(a,l)=>{let c=qr(l,e.getImmediateChild(a),t);c!==l&&(r=r.updateImmediateChild(a,c))}),r}}var yn=class{constructor(e="",t=null,i={children:{},childCount:0}){this.name=e,this.parent=t,this.node=i}};function Ai(n,e){let t=e instanceof I?e:new I(e),i=n,s=y(t);for(;s!==null;){let r=je(i.node.children,s)||{children:{},childCount:0};i=new yn(s,i,r),t=S(t),s=y(t)}return i}function ot(n){return n.node.value}function Kr(n,e){n.node.value=e,cr(n)}function Kl(n){return n.node.childCount>0}function Od(n){return ot(n)===void 0&&!Kl(n)}function Ri(n,e){B(n.node.children,(t,i)=>{e(new yn(t,n,i))})}function zl(n,e,t,i){t&&!i&&e(n),Ri(n,s=>{zl(s,e,!0,i)}),t&&i&&e(n)}function Md(n,e,t){let i=t?n:n.parent;for(;i!==null;){if(e(i))return!0;i=i.parent}return!1}function Sn(n){return new I(n.parent===null?n.name:Sn(n.parent)+"/"+n.name)}function cr(n){n.parent!==null&&Fd(n.parent,n.name,n)}function Fd(n,e,t){let i=Od(t),s=de(n.node.children,e);i&&s?(delete n.node.children[e],n.node.childCount--,cr(n)):!i&&!s&&(n.node.children[e]=t.node,n.node.childCount++,cr(n))}var Ld=/[\[\].#$\/\u0000-\u001F\u007F]/,Wd=/[\[\].#$\u0000-\u001F\u007F]/,ws=10*1024*1024,Pi=function(n){return typeof n=="string"&&n.length!==0&&!Ld.test(n)},Yl=function(n){return typeof n=="string"&&n.length!==0&&!Wd.test(n)},Ud=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Yl(n)},vn=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!Ei(n)||n&&typeof n=="object"&&de(n,".sv")},Pe=function(n,e,t,i){i&&e===void 0||kn(ee(n,"value"),e,t)},kn=function(n,e,t){let i=t instanceof I?new Ds(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+et(i));if(typeof e=="function")throw new Error(n+"contains a function "+et(i)+" with contents = "+e.toString());if(Ei(e))throw new Error(n+"contains "+e.toString()+" "+et(i));if(typeof e=="string"&&e.length>ws/3&&Gt(e)>ws)throw new Error(n+"contains a string greater than "+ws+" utf8 bytes "+et(i)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let s=!1,r=!1;if(B(e,(o,a)=>{if(o===".value")s=!0;else if(o!==".priority"&&o!==".sv"&&(r=!0,!Pi(o)))throw new Error(n+" contains an invalid key ("+o+") "+et(i)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);_h(i,o),kn(n,a,i),gh(i)}),s&&r)throw new Error(n+' contains ".value" child '+et(i)+" in addition to actual children.")}},jd=function(n,e){let t,i;for(t=0;t<e.length;t++){i=e[t];let r=cn(i);for(let o=0;o<r.length;o++)if(!(r[o]===".priority"&&o===r.length-1)){if(!Pi(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+i.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(ph);let s=null;for(t=0;t<e.length;t++){if(i=e[t],s!==null&&fe(s,i))throw new Error(n+"contains a path "+s.toString()+" that is ancestor of another path "+i.toString());s=i}},Ql=function(n,e,t,i){if(i&&e===void 0)return;let s=ee(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(s+" must be an object containing the children to replace.");let r=[];B(e,(o,a)=>{let l=new I(o);if(kn(s,a,R(t,l)),Pr(l)===".priority"&&!vn(a))throw new Error(s+"contains an invalid value for '"+l.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(l)}),jd(s,r)},zr=function(n,e,t){if(!(t&&e===void 0)){if(Ei(e))throw new Error(ee(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!vn(e))throw new Error(ee(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},An=function(n,e,t,i){if(!(i&&t===void 0)&&!Pi(t))throw new Error(ee(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},Ft=function(n,e,t,i){if(!(i&&t===void 0)&&!Yl(t))throw new Error(ee(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Bd=function(n,e,t,i){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),Ft(n,e,t,i)},re=function(n,e){if(y(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Xl=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Pi(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!Ud(t))throw new Error(ee(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var ur=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function Ni(n,e){let t=null;for(let i=0;i<e.length;i++){let s=e[i],r=s.getPath();t!==null&&!Nr(r,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:r}),t.events.push(s)}t&&n.eventLists_.push(t)}function Jl(n,e,t){Ni(n,t),Zl(n,i=>Nr(i,e))}function oe(n,e,t){Ni(n,t),Zl(n,i=>fe(i,e)||fe(e,i))}function Zl(n,e){n.recursionDepth_++;let t=!0;for(let i=0;i<n.eventLists_.length;i++){let s=n.eventLists_[i];if(s){let r=s.path;e(r)?(Vd(n.eventLists_[i]),n.eventLists_[i]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function Vd(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let i=t.getEventRunner();nt&&j("event: "+t.toString()),Dt(i)}}}var ec="repo_interrupt",$d=25,hr=class{constructor(e,t,i,s){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=i,this.appCheckProvider_=s,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new ur,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=si(),this.transactionQueueTree_=new yn,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function Hd(n,e,t){if(n.stats_=Rr(n.repoInfo_),n.forceRestClient_||Hu())n.server_=new Hs(n.repoInfo_,(i,s,r,o)=>{Qa(n,i,s,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Xa(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{D(t)}catch(i){throw new Error("Invalid authOverride provided: "+i)}}n.persistentConnection_=new xr(n.repoInfo_,e,(i,s,r,o)=>{Qa(n,i,s,r,o)},i=>{Xa(n,i)},i=>{Gd(n,i)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(i=>{n.server_.refreshAuthToken(i)}),n.appCheckProvider_.addTokenChangeListener(i=>{n.server_.refreshAppCheckToken(i.token)}),n.statsReporter_=qu(n.repoInfo_,()=>new Ys(n.stats_,n.server_)),n.infoData_=new Gs,n.infoSyncTree_=new fi({startListening:(i,s,r,o)=>{let a=[],l=n.infoData_.getNode(i._path);return l.isEmpty()||(a=bn(n.infoSyncTree_,i._path,l),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),Yr(n,"connected",!1),n.serverSyncTree_=new fi({startListening:(i,s,r,o)=>(n.server_.listen(i,r,s,(a,l)=>{let c=o(a,l);oe(n.eventQueue_,i._path,c)}),[]),stopListening:(i,s)=>{n.server_.unlisten(i,s)}})}function tc(n){let t=n.infoData_.getNode(new I(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Rn(n){return Nd({timestamp:tc(n)})}function Qa(n,e,t,i,s){n.dataUpdateCount++;let r=new I(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(s)if(i){let l=Ht(t,c=>P(c));o=bd(n.serverSyncTree_,r,l,s)}else{let l=P(t);o=Vl(n.serverSyncTree_,r,l,s)}else if(i){let l=Ht(t,c=>P(c));o=Cd(n.serverSyncTree_,r,l)}else{let l=P(t);o=bn(n.serverSyncTree_,r,l)}let a=r;o.length>0&&(a=Nt(n,r)),oe(n.eventQueue_,a,o)}function Xa(n,e){Yr(n,"connected",e),e===!1&&zd(n)}function Gd(n,e){B(e,(t,i)=>{Yr(n,t,i)})}function Yr(n,e,t){let i=new I("/.info/"+e),s=P(t);n.infoData_.updateSnapshot(i,s);let r=bn(n.infoSyncTree_,i,s);oe(n.eventQueue_,i,r)}function xi(n){return n.nextWriteId_++}function qd(n,e,t){let i=Sd(n.serverSyncTree_,e);return i!=null?Promise.resolve(i):n.server_.get(e).then(s=>{let r=P(s).withIndex(e._queryParams.getIndex());or(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=bn(n.serverSyncTree_,e._path,r);else{let a=mn(n.serverSyncTree_,e);o=Vl(n.serverSyncTree_,e._path,r,a)}return oe(n.eventQueue_,e._path,o),pi(n.serverSyncTree_,e,t,null,!0),r},s=>(Lt(n,"get for query "+D(e)+" failed: "+s),Promise.reject(new Error(s))))}function Qr(n,e,t,i,s){Lt(n,"set",{path:e.toString(),value:t,priority:i});let r=Rn(n),o=P(t,i),a=Si(n.serverSyncTree_,e),l=Gr(o,a,r),c=xi(n),u=Br(n.serverSyncTree_,e,l,c,!0);Ni(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(d,p)=>{let _=d==="ok";_||H("set at "+e+" failed: "+d);let E=He(n.serverSyncTree_,c,!_);oe(n.eventQueue_,e,E),Qe(n,s,d,p)});let h=Jr(n,e);Nt(n,h),oe(n.eventQueue_,h,[])}function Kd(n,e,t,i){Lt(n,"update",{path:e.toString(),value:t});let s=!0,r=Rn(n),o={};if(B(t,(a,l)=>{s=!1,o[a]=ql(R(e,a),P(l),n.serverSyncTree_,r)}),s)j("update() called with empty data.  Don't do anything."),Qe(n,i,"ok",void 0);else{let a=xi(n),l=Ed(n.serverSyncTree_,e,o,a);Ni(n.eventQueue_,l),n.server_.merge(e.toString(),t,(c,u)=>{let h=c==="ok";h||H("update at "+e+" failed: "+c);let d=He(n.serverSyncTree_,a,!h),p=d.length>0?Nt(n,e):e;oe(n.eventQueue_,p,d),Qe(n,i,c,u)}),B(t,c=>{let u=Jr(n,R(e,c));Nt(n,u)}),oe(n.eventQueue_,e,[])}}function zd(n){Lt(n,"onDisconnectEvents");let e=Rn(n),t=si();Ks(n.onDisconnect_,T(),(s,r)=>{let o=ql(s,r,n.serverSyncTree_,e);Ot(t,s,o)});let i=[];Ks(t,T(),(s,r)=>{i=i.concat(bn(n.serverSyncTree_,s,r));let o=Jr(n,s);Nt(n,o)}),n.onDisconnect_=si(),oe(n.eventQueue_,T(),i)}function Yd(n,e,t){n.server_.onDisconnectCancel(e.toString(),(i,s)=>{i==="ok"&&qs(n.onDisconnect_,e),Qe(n,t,i,s)})}function Ja(n,e,t,i){let s=P(t);n.server_.onDisconnectPut(e.toString(),s.val(!0),(r,o)=>{r==="ok"&&Ot(n.onDisconnect_,e,s),Qe(n,i,r,o)})}function Qd(n,e,t,i,s){let r=P(t,i);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,a)=>{o==="ok"&&Ot(n.onDisconnect_,e,r),Qe(n,s,o,a)})}function Xd(n,e,t,i){if(Vn(t)){j("onDisconnect().update() called with empty data.  Don't do anything."),Qe(n,i,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(s,r)=>{s==="ok"&&B(t,(o,a)=>{let l=P(a);Ot(n.onDisconnect_,R(e,o),l)}),Qe(n,i,s,r)})}function Jd(n,e,t){let i;y(e._path)===".info"?i=or(n.infoSyncTree_,e,t):i=or(n.serverSyncTree_,e,t),Jl(n.eventQueue_,e._path,i)}function dr(n,e,t){let i;y(e._path)===".info"?i=pi(n.infoSyncTree_,e,t):i=pi(n.serverSyncTree_,e,t),Jl(n.eventQueue_,e._path,i)}function nc(n){n.persistentConnection_&&n.persistentConnection_.interrupt(ec)}function Zd(n){n.persistentConnection_&&n.persistentConnection_.resume(ec)}function Lt(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),j(t,...e)}function Qe(n,e,t,i){e&&Dt(()=>{if(t==="ok")e(null);else{let s=(t||"error").toUpperCase(),r=s;i&&(r+=": "+i);let o=new Error(r);o.code=s,e(o)}})}function ef(n,e,t,i,s,r){Lt(n,"transaction on "+e);let o={path:e,update:t,onComplete:i,status:null,order:tl(),applyLocally:r,retryCount:0,unwatcher:s,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=Xr(n,e,void 0);o.currentInputSnapshot=a;let l=o.update(a.val());if(l===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{kn("transaction failed: Data returned ",l,o.path),o.status=0;let c=Ai(n.transactionQueueTree_,e),u=ot(c)||[];u.push(o),Kr(c,u);let h;typeof l=="object"&&l!==null&&de(l,".priority")?(h=je(l,".priority"),f(vn(h),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):h=(Si(n.serverSyncTree_,e)||m.EMPTY_NODE).getPriority().val();let d=Rn(n),p=P(l,h),_=Gr(p,a,d);o.currentOutputSnapshotRaw=p,o.currentOutputSnapshotResolved=_,o.currentWriteId=xi(n);let E=Br(n.serverSyncTree_,e,_,o.currentWriteId,o.applyLocally);oe(n.eventQueue_,e,E),Di(n,n.transactionQueueTree_)}}function Xr(n,e,t){return Si(n.serverSyncTree_,e,t)||m.EMPTY_NODE}function Di(n,e=n.transactionQueueTree_){if(e||Oi(n,e),ot(e)){let t=sc(n,e);f(t.length>0,"Sending zero length transaction queue"),t.every(s=>s.status===0)&&tf(n,Sn(e),t)}else Kl(e)&&Ri(e,t=>{Di(n,t)})}function tf(n,e,t){let i=t.map(c=>c.currentWriteId),s=Xr(n,e,i),r=s,o=s.hash();for(let c=0;c<t.length;c++){let u=t[c];f(u.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;let h=z(e,u.path);r=r.updateChild(h,u.currentOutputSnapshotRaw)}let a=r.val(!0),l=e;n.server_.put(l.toString(),a,c=>{Lt(n,"transaction put response",{path:l.toString(),status:c});let u=[];if(c==="ok"){let h=[];for(let d=0;d<t.length;d++)t[d].status=2,u=u.concat(He(n.serverSyncTree_,t[d].currentWriteId)),t[d].onComplete&&h.push(()=>t[d].onComplete(null,!0,t[d].currentOutputSnapshotResolved)),t[d].unwatcher();Oi(n,Ai(n.transactionQueueTree_,e)),Di(n,n.transactionQueueTree_),oe(n.eventQueue_,e,u);for(let d=0;d<h.length;d++)Dt(h[d])}else{if(c==="datastale")for(let h=0;h<t.length;h++)t[h].status===3?t[h].status=4:t[h].status=0;else{H("transaction at "+l.toString()+" failed: "+c);for(let h=0;h<t.length;h++)t[h].status=4,t[h].abortReason=c}Nt(n,e)}},o)}function Nt(n,e){let t=ic(n,e),i=Sn(t),s=sc(n,t);return nf(n,s,i),i}function nf(n,e,t){if(e.length===0)return;let i=[],s=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let l=e[a],c=z(t,l.path),u=!1,h;if(f(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),l.status===4)u=!0,h=l.abortReason,s=s.concat(He(n.serverSyncTree_,l.currentWriteId,!0));else if(l.status===0)if(l.retryCount>=$d)u=!0,h="maxretry",s=s.concat(He(n.serverSyncTree_,l.currentWriteId,!0));else{let d=Xr(n,l.path,o);l.currentInputSnapshot=d;let p=e[a].update(d.val());if(p!==void 0){kn("transaction failed: Data returned ",p,l.path);let _=P(p);typeof p=="object"&&p!=null&&de(p,".priority")||(_=_.updatePriority(d.getPriority()));let b=l.currentWriteId,te=Rn(n),ne=Gr(_,d,te);l.currentOutputSnapshotRaw=_,l.currentOutputSnapshotResolved=ne,l.currentWriteId=xi(n),o.splice(o.indexOf(b),1),s=s.concat(Br(n.serverSyncTree_,l.path,ne,l.currentWriteId,l.applyLocally)),s=s.concat(He(n.serverSyncTree_,b,!0))}else u=!0,h="nodata",s=s.concat(He(n.serverSyncTree_,l.currentWriteId,!0))}oe(n.eventQueue_,t,s),s=[],u&&(e[a].status=2,(function(d){setTimeout(d,Math.floor(0))})(e[a].unwatcher),e[a].onComplete&&(h==="nodata"?i.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):i.push(()=>e[a].onComplete(new Error(h),!1,null))))}Oi(n,n.transactionQueueTree_);for(let a=0;a<i.length;a++)Dt(i[a]);Di(n,n.transactionQueueTree_)}function ic(n,e){let t,i=n.transactionQueueTree_;for(t=y(e);t!==null&&ot(i)===void 0;)i=Ai(i,t),e=S(e),t=y(e);return i}function sc(n,e){let t=[];return rc(n,e,t),t.sort((i,s)=>i.order-s.order),t}function rc(n,e,t){let i=ot(e);if(i)for(let s=0;s<i.length;s++)t.push(i[s]);Ri(e,s=>{rc(n,s,t)})}function Oi(n,e){let t=ot(e);if(t){let i=0;for(let s=0;s<t.length;s++)t[s].status!==2&&(t[i]=t[s],i++);t.length=i,Kr(e,t.length>0?t:void 0)}Ri(e,i=>{Oi(n,i)})}function Jr(n,e){let t=Sn(ic(n,e)),i=Ai(n.transactionQueueTree_,e);return Md(i,s=>{Es(n,s)}),Es(n,i),zl(i,s=>{Es(n,s)}),t}function Es(n,e){let t=ot(e);if(t){let i=[],s=[],r=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(f(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):(f(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),s=s.concat(He(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&i.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));r===-1?Kr(e,void 0):t.length=r+1,oe(n.eventQueue_,Sn(e),s);for(let o=0;o<i.length;o++)Dt(i[o])}}function sf(n){let e="",t=n.split("/");for(let i=0;i<t.length;i++)if(t[i].length>0){let s=t[i];try{s=decodeURIComponent(s.replace(/\+/g," "))}catch{}e+="/"+s}return e}function rf(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let i=t.split("=");i.length===2?e[decodeURIComponent(i[0])]=decodeURIComponent(i[1]):H(`Invalid query segment '${t}' in query '${n}'`)}return e}var fr=function(n,e){let t=of(n),i=t.namespace;t.domain==="firebase.com"&&Ae(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!i||i==="undefined")&&t.domain!=="localhost"&&Ae("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||Mu();let s=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Qn(t.host,t.secure,i,s,e,"",i!==t.subdomain),path:new I(t.pathString)}},of=function(n){let e="",t="",i="",s="",r="",o=!0,a="https",l=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let u=n.indexOf("/");u===-1&&(u=n.length);let h=n.indexOf("?");h===-1&&(h=n.length),e=n.substring(0,Math.min(u,h)),u<h&&(s=sf(n.substring(u,h)));let d=rf(n.substring(Math.min(n.length,h)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",l=parseInt(e.substring(c+1),10)):c=e.length;let p=e.slice(0,c);if(p.toLowerCase()==="localhost")t="localhost";else if(p.split(".").length<=2)t=p;else{let _=e.indexOf(".");i=e.substring(0,_).toLowerCase(),t=e.substring(_+1),r=i}"ns"in d&&(r=d.ns)}return{host:e,port:l,domain:t,subdomain:i,secure:o,scheme:a,pathString:s,namespace:r}};var Za="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",af=(function(){let n=0,e=[];return function(t){let i=t===n;n=t;let s,r=new Array(8);for(s=7;s>=0;s--)r[s]=Za.charAt(t%64),t=Math.floor(t/64);f(t===0,"Cannot push at time == 0");let o=r.join("");if(i){for(s=11;s>=0&&e[s]===63;s--)e[s]=0;e[s]++}else for(s=0;s<12;s++)e[s]=Math.floor(Math.random()*64);for(s=0;s<12;s++)o+=Za.charAt(e[s]);return f(o.length===20,"nextPushId: Length should be 20."),o}})();var _i=class{constructor(e,t,i,s){this.eventType=e,this.eventRegistration=t,this.snapshot=i,this.prevName=s}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+D(this.snapshot.exportVal())}},gi=class{constructor(e,t,i){this.eventRegistration=e,this.error=t,this.path=i}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var wn=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return f(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var mi=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new U;return Yd(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){re("OnDisconnect.remove",this._path);let e=new U;return Ja(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){re("OnDisconnect.set",this._path),Pe("OnDisconnect.set",e,this._path,!1);let t=new U;return Ja(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){re("OnDisconnect.setWithPriority",this._path),Pe("OnDisconnect.setWithPriority",e,this._path,!1),zr("OnDisconnect.setWithPriority",t,!1);let i=new U;return Qd(this._repo,this._path,e,t,i.wrapCallback(()=>{})),i.promise}update(e){re("OnDisconnect.update",this._path),Ql("OnDisconnect.update",e,this._path,!1);let t=new U;return Xd(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var Q=class n{constructor(e,t,i,s){this._repo=e,this._path=t,this._queryParams=i,this._orderByCalled=s}get key(){return v(this._path)?null:Pr(this._path)}get ref(){return new ae(this._repo,this._path)}get _queryIdentifier(){let e=Ua(this._queryParams),t=Ar(e);return t==="{}"?"default":t}get _queryObject(){return Ua(this._queryParams)}isEqual(e){if(e=K(e),!(e instanceof n))return!1;let t=this._repo===e._repo,i=Nr(this._path,e._path),s=this._queryIdentifier===e._queryIdentifier;return t&&i&&s}toJSON(){return this.toString()}toString(){return this._repo.toString()+fh(this._path)}};function Mi(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Je(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===ke){let i="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",s="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==Ke)throw new Error(i);if(typeof e!="string")throw new Error(s)}if(n.hasEnd()){if(n.getIndexEndName()!==Me)throw new Error(i);if(typeof t!="string")throw new Error(s)}}else if(n.getIndex()===k){if(e!=null&&!vn(e)||t!=null&&!vn(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(f(n.getIndex()instanceof un||n.getIndex()===Or,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Fi(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ae=class n extends Q{constructor(e,t){super(e,t,new pn,!1)}get parent(){let e=Cl(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},xt=class n{constructor(e,t,i){this._node=e,this.ref=t,this._index=i}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new I(e),i=Xe(this.ref,e);return new n(this._node.getChild(t),i,k)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(i,s)=>e(new n(s,Xe(this.ref,i),k)))}hasChild(e){let t=new I(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Zr(n,e){return n=K(n),n._checkNotDeleted("ref"),e!==void 0?Xe(n._root,e):n._root}function eo(n,e){n=K(n),n._checkNotDeleted("refFromURL");let t=fr(e,n._repo.repoInfo_.nodeAdmin);Xl("refFromURL",t);let i=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&i.host!==n._repo.repoInfo_.host&&Ae("refFromURL: Host name does not match the current database: (found "+i.host+" but expected "+n._repo.repoInfo_.host+")"),Zr(n,t.path.toString())}function Xe(n,e){return n=K(n),y(n._path)===null?Bd("child","path",e,!1):Ft("child","path",e,!1),new ae(n._repo,R(n._path,e))}function oc(n,e){n=K(n),re("push",n._path),Pe("push",e,n._path,!0);let t=tc(n._repo),i=af(t),s=Xe(n,i),r=Xe(n,i),o;return e!=null?o=Li(r,e).then(()=>r):o=Promise.resolve(r),s.then=o.then.bind(o),s.catch=o.then.bind(o,void 0),s}function ac(n){return re("remove",n._path),Li(n,null)}function Li(n,e){n=K(n),re("set",n._path),Pe("set",e,n._path,!1);let t=new U;return Qr(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function lc(n,e){n=K(n),re("setPriority",n._path),zr("setPriority",e,!1);let t=new U;return Qr(n._repo,R(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function cc(n,e,t){if(re("setWithPriority",n._path),Pe("setWithPriority",e,n._path,!1),zr("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let i=new U;return Qr(n._repo,n._path,e,t,i.wrapCallback(()=>{})),i.promise}function uc(n,e){Ql("update",e,n._path,!1);let t=new U;return Kd(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function hc(n){n=K(n);let e=new wn(()=>{}),t=new En(e);return qd(n._repo,n,t).then(i=>new xt(i,new ae(n._repo,n._path),n._queryParams.getIndex()))}var En=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let i=t._queryParams.getIndex();return new _i("value",this,new xt(e.snapshotNode,new ae(t._repo,t._path),i))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new gi(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},yi=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new gi(this,e,t):null}createEvent(e,t){f(e.childName!=null,"Child events should have a childName.");let i=Xe(new ae(t._repo,t._path),e.childName),s=t._queryParams.getIndex();return new _i(e.type,this,new xt(e.snapshotNode,i,s),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function Pn(n,e,t,i,s){let r;if(typeof i=="object"&&(r=void 0,s=i),typeof i=="function"&&(r=i),s&&s.onlyOnce){let l=t,c=(u,h)=>{dr(n._repo,n,a),l(u,h)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new wn(t,r||void 0),a=e==="value"?new En(o):new yi(e,o);return Jd(n._repo,n,a),()=>dr(n._repo,n,a)}function Wi(n,e,t,i){return Pn(n,"value",e,t,i)}function to(n,e,t,i){return Pn(n,"child_added",e,t,i)}function no(n,e,t,i){return Pn(n,"child_changed",e,t,i)}function io(n,e,t,i){return Pn(n,"child_moved",e,t,i)}function so(n,e,t,i){return Pn(n,"child_removed",e,t,i)}function ro(n,e,t){let i=null,s=t?new wn(t):null;e==="value"?i=new En(s):e&&(i=new yi(e,s)),dr(n._repo,n,i)}var le=class{},vi=class extends le{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Pe("endAt",this._value,e._path,!0);let t=$s(e._queryParams,this._value,this._key);if(Fi(t),Je(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function dc(n,e){return An("endAt","key",e,!0),new vi(n,e)}var pr=class extends le{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Pe("endBefore",this._value,e._path,!1);let t=xh(e._queryParams,this._value,this._key);if(Fi(t),Je(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function fc(n,e){return An("endBefore","key",e,!0),new pr(n,e)}var wi=class extends le{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Pe("startAt",this._value,e._path,!0);let t=Vs(e._queryParams,this._value,this._key);if(Fi(t),Je(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function pc(n=null,e){return An("startAt","key",e,!0),new wi(n,e)}var _r=class extends le{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Pe("startAfter",this._value,e._path,!1);let t=Nh(e._queryParams,this._value,this._key);if(Fi(t),Je(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new Q(e._repo,e._path,t,e._orderByCalled)}};function _c(n,e){return An("startAfter","key",e,!0),new _r(n,e)}var gr=class extends le{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new Q(e._repo,e._path,Rh(e._queryParams,this._limit),e._orderByCalled)}};function gc(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new gr(n)}var mr=class extends le{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new Q(e._repo,e._path,Ph(e._queryParams,this._limit),e._orderByCalled)}};function mc(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new mr(n)}var yr=class extends le{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Mi(e,"orderByChild");let t=new I(this._path);if(v(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let i=new un(t),s=Ci(e._queryParams,i);return Je(s),new Q(e._repo,e._path,s,!0)}};function yc(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return Ft("orderByChild","path",n,!1),new yr(n)}var vr=class extends le{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Mi(e,"orderByKey");let t=Ci(e._queryParams,ke);return Je(t),new Q(e._repo,e._path,t,!0)}};function vc(){return new vr}var wr=class extends le{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Mi(e,"orderByPriority");let t=Ci(e._queryParams,k);return Je(t),new Q(e._repo,e._path,t,!0)}};function wc(){return new wr}var Er=class extends le{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Mi(e,"orderByValue");let t=Ci(e._queryParams,Or);return Je(t),new Q(e._repo,e._path,t,!0)}};function Ec(){return new Er}var Cr=class extends le{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Pe("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new vi(this._value,this._key)._apply(new wi(this._value,this._key)._apply(e))}};function Cc(n,e){return An("equalTo","key",e,!0),new Cr(n,e)}function _e(n,...e){let t=K(n);for(let i of e)t=i._apply(t);return t}fd(ae);yd(ae);var lf="FIREBASE_DATABASE_EMULATOR_HOST",Tr={},cf=!1;function uf(n,e,t,i){let s=e.lastIndexOf(":"),r=e.substring(0,s),o=Xi(r);n.repoInfo_=new Qn(e,o,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0,t),i&&(n.authTokenProvider_=i)}function oo(n,e,t,i,s){let r=i||n.options.databaseURL;r===void 0&&(n.options.projectId||Ae("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),j("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=fr(r,s),a=o.repoInfo,l,c;typeof process<"u"&&process.env&&(c=process.env[lf]),c?(l=!0,r=`http://${c}?ns=${a.namespace}`,o=fr(r,s),a=o.repoInfo):l=!o.repoInfo.secure;let u=s&&l?new sn(sn.OWNER):new ks(n.name,n.options,e);Xl("Invalid Firebase Database URL",o),v(o.path)||Ae("Database URL must point to the root of a Firebase Database (not including a child path).");let h=df(a,n,u,new Ss(n,t));return new Ir(h,n)}function hf(n,e){let t=Tr[e];(!t||t[n.key]!==n)&&Ae(`Database ${e}(${n.repoInfo_}) has already been deleted.`),nc(n),delete t[n.key]}function df(n,e,t,i){let s=Tr[e.name];s||(s={},Tr[e.name]=s);let r=s[n.toURLString()];return r&&Ae("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new hr(n,cf,t,i),s[n.toURLString()]=r,r}var Ir=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Hd(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ae(this._repo,T())),this._rootInternal}_delete(){return this._rootInternal!==null&&(hf(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Ae("Cannot call "+e+" on a deleted database.")}};function Tc(){El.IS_TRANSPORT_INITIALIZED&&H("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function Ic(){Tc(),ln.forceDisallow()}function bc(){Tc(),Ct.forceDisallow(),ln.forceAllow()}function Sc(n,e,t,i={}){n=K(n),n._checkNotDeleted("useEmulator");let s=`${e}:${t}`,r=n._repoInternal;if(n._instanceStarted){if(s===n._repoInternal.repoInfo_.host&&Qo(i,r.repoInfo_.emulatorOptions))return;Ae("connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.")}let o;if(r.repoInfo_.nodeAdmin)i.mockUserToken&&Ae('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new sn(sn.OWNER);else if(i.mockUserToken){let a=typeof i.mockUserToken=="string"?i.mockUserToken:$o(i.mockUserToken,n.app.options.projectId);o=new sn(a)}Xi(e)&&(Vo(e),Ho("Database",!0)),uf(r,s,i,o)}function kc(n){n=K(n),n._checkNotDeleted("goOffline"),nc(n._repo)}function Ac(n){n=K(n),n._checkNotDeleted("goOnline"),Zd(n._repo)}function Rc(n,e){il(n,e)}function ff(n){kr(na),qt(new De("database",(e,{instanceIdentifier:t})=>{let i=e.getProvider("app").getImmediate(),s=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return oo(i,s,r,t)},"PUBLIC").setMultipleInstances(!0)),Be(Ca,Ta,n),Be(Ca,Ta,"esm2017")}var pf={".sv":"timestamp"};function Pc(){return pf}function Nc(n){return{".sv":{increment:n}}}var br=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function xc(n,e,t){var i;if(n=K(n),re("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let s=(i=t?.applyLocally)!==null&&i!==void 0?i:!0,r=new U,o=(l,c,u)=>{let h=null;l?r.reject(l):(h=new xt(u,new ae(n._repo,n._path),k),r.resolve(new br(c,h)))},a=Wi(n,()=>{});return ef(n._repo,n._path,e,o,a,s),r.promise}xr.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};xr.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};ff();var _f="@firebase/database-compat",gf="2.0.11";var mf=new mt("@firebase/database-compat"),Dc=function(n){let e="FIREBASE WARNING: "+n;mf.warn(e)};var yf=function(n,e,t,i){if(!(i&&t===void 0)&&typeof t!="boolean")throw new Error(ee(n,e)+"must be a boolean.")},vf=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(ee(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var ao=class{constructor(e){this._delegate=e}cancel(e){g("OnDisconnect.cancel",0,1,arguments.length),F("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),i=>e(i)),t}remove(e){g("OnDisconnect.remove",0,1,arguments.length),F("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),i=>e(i)),t}set(e,t){g("OnDisconnect.set",1,2,arguments.length),F("OnDisconnect.set","onComplete",t,!0);let i=this._delegate.set(e);return t&&i.then(()=>t(null),s=>t(s)),i}setWithPriority(e,t,i){g("OnDisconnect.setWithPriority",2,3,arguments.length),F("OnDisconnect.setWithPriority","onComplete",i,!0);let s=this._delegate.setWithPriority(e,t);return i&&s.then(()=>i(null),r=>i(r)),s}update(e,t){if(g("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let s={};for(let r=0;r<e.length;++r)s[""+r]=e[r];e=s,Dc("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}F("OnDisconnect.update","onComplete",t,!0);let i=this._delegate.update(e);return t&&i.then(()=>t(null),s=>t(s)),i}};var lo=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return g("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var at=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return g("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return g("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return g("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return g("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return g("DataSnapshot.child",0,1,arguments.length),e=String(e),Ft("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return g("DataSnapshot.hasChild",1,1,arguments.length),Ft("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return g("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return g("DataSnapshot.forEach",1,1,arguments.length),F("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return g("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return g("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return g("DataSnapshot.ref",0,0,arguments.length),new Fe(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Ui=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,i,s){var r;g("Query.on",2,4,arguments.length),F("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",i,s),a=(c,u)=>{t.call(o.context,new at(this.database,c),u)};a.userCallback=t,a.context=o.context;let l=(r=o.cancel)===null||r===void 0?void 0:r.bind(o.context);switch(e){case"value":return Wi(this._delegate,a,l),t;case"child_added":return to(this._delegate,a,l),t;case"child_removed":return so(this._delegate,a,l),t;case"child_changed":return no(this._delegate,a,l),t;case"child_moved":return io(this._delegate,a,l),t;default:throw new Error(ee("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,i){if(g("Query.off",0,3,arguments.length),vf("Query.off",e,!0),F("Query.off","callback",t,!0),Zi("Query.off","context",i,!0),t){let s=()=>{};s.userCallback=t,s.context=i,ro(this._delegate,e,s)}else ro(this._delegate,e)}get(){return hc(this._delegate).then(e=>new at(this.database,e))}once(e,t,i,s){g("Query.once",1,4,arguments.length),F("Query.once","callback",t,!0);let r=n.getCancelAndContextArgs_("Query.once",i,s),o=new U,a=(c,u)=>{let h=new at(this.database,c);t&&t.call(r.context,h,u),o.resolve(h)};a.userCallback=t,a.context=r.context;let l=c=>{r.cancel&&r.cancel.call(r.context,c),o.reject(c)};switch(e){case"value":Wi(this._delegate,a,l,{onlyOnce:!0});break;case"child_added":to(this._delegate,a,l,{onlyOnce:!0});break;case"child_removed":so(this._delegate,a,l,{onlyOnce:!0});break;case"child_changed":no(this._delegate,a,l,{onlyOnce:!0});break;case"child_moved":io(this._delegate,a,l,{onlyOnce:!0});break;default:throw new Error(ee("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return g("Query.limitToFirst",1,1,arguments.length),new n(this.database,_e(this._delegate,gc(e)))}limitToLast(e){return g("Query.limitToLast",1,1,arguments.length),new n(this.database,_e(this._delegate,mc(e)))}orderByChild(e){return g("Query.orderByChild",1,1,arguments.length),new n(this.database,_e(this._delegate,yc(e)))}orderByKey(){return g("Query.orderByKey",0,0,arguments.length),new n(this.database,_e(this._delegate,vc()))}orderByPriority(){return g("Query.orderByPriority",0,0,arguments.length),new n(this.database,_e(this._delegate,wc()))}orderByValue(){return g("Query.orderByValue",0,0,arguments.length),new n(this.database,_e(this._delegate,Ec()))}startAt(e=null,t){return g("Query.startAt",0,2,arguments.length),new n(this.database,_e(this._delegate,pc(e,t)))}startAfter(e=null,t){return g("Query.startAfter",0,2,arguments.length),new n(this.database,_e(this._delegate,_c(e,t)))}endAt(e=null,t){return g("Query.endAt",0,2,arguments.length),new n(this.database,_e(this._delegate,dc(e,t)))}endBefore(e=null,t){return g("Query.endBefore",0,2,arguments.length),new n(this.database,_e(this._delegate,fc(e,t)))}equalTo(e,t){return g("Query.equalTo",1,2,arguments.length),new n(this.database,_e(this._delegate,Cc(e,t)))}toString(){return g("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return g("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(g("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,i){let s={cancel:void 0,context:void 0};if(t&&i)s.cancel=t,F(e,"cancel",s.cancel,!0),s.context=i,Zi(e,"context",s.context,!0);else if(t)if(typeof t=="object"&&t!==null)s.context=t;else if(typeof t=="function")s.cancel=t;else throw new Error(ee(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return s}get ref(){return new Fe(this.database,new ae(this._delegate._repo,this._delegate._path))}},Fe=class n extends Ui{constructor(e,t){super(e,new Q(t._repo,t._path,new pn,!1)),this.database=e,this._delegate=t}getKey(){return g("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return g("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,Xe(this._delegate,e))}getParent(){g("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return g("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){g("Reference.set",1,2,arguments.length),F("Reference.set","onComplete",t,!0);let i=Li(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}update(e,t){if(g("Reference.update",1,2,arguments.length),Array.isArray(e)){let s={};for(let r=0;r<e.length;++r)s[""+r]=e[r];e=s,Dc("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}re("Reference.update",this._delegate._path),F("Reference.update","onComplete",t,!0);let i=uc(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}setWithPriority(e,t,i){g("Reference.setWithPriority",2,3,arguments.length),F("Reference.setWithPriority","onComplete",i,!0);let s=cc(this._delegate,e,t);return i&&s.then(()=>i(null),r=>i(r)),s}remove(e){g("Reference.remove",0,1,arguments.length),F("Reference.remove","onComplete",e,!0);let t=ac(this._delegate);return e&&t.then(()=>e(null),i=>e(i)),t}transaction(e,t,i){g("Reference.transaction",1,3,arguments.length),F("Reference.transaction","transactionUpdate",e,!1),F("Reference.transaction","onComplete",t,!0),yf("Reference.transaction","applyLocally",i,!0);let s=xc(this._delegate,e,{applyLocally:i}).then(r=>new lo(r.committed,new at(this.database,r.snapshot)));return t&&s.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),s}setPriority(e,t){g("Reference.setPriority",1,2,arguments.length),F("Reference.setPriority","onComplete",t,!0);let i=lc(this._delegate,e);return t&&i.then(()=>t(null),s=>t(s)),i}push(e,t){g("Reference.push",0,2,arguments.length),F("Reference.push","onComplete",t,!0);let i=oc(this._delegate,e),s=i.then(o=>new n(this.database,o));t&&s.then(()=>t(null),o=>t(o));let r=new n(this.database,i);return r.then=s.then.bind(s),r.catch=s.catch.bind(s,void 0),r}onDisconnect(){return re("Reference.onDisconnect",this._delegate._path),new ao(new mi(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var lt=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:Ic,forceLongPolling:bc}}useEmulator(e,t,i={}){Sc(this._delegate,e,t,i)}ref(e){if(g("database.ref",0,1,arguments.length),e instanceof Fe){let t=eo(this._delegate,e.toString());return new Fe(this,t)}else{let t=Zr(this._delegate,e);return new Fe(this,t)}}refFromURL(e){g("database.refFromURL",1,1,arguments.length);let i=eo(this._delegate,e);return new Fe(this,i)}goOffline(){return g("database.goOffline",0,0,arguments.length),kc(this._delegate)}goOnline(){return g("database.goOnline",0,0,arguments.length),Ac(this._delegate)}};lt.ServerValue={TIMESTAMP:Pc(),increment:n=>Nc(n)};function wf({app:n,url:e,version:t,customAuthImpl:i,customAppCheckImpl:s,namespace:r,nodeAdmin:o=!1}){kr(t);let a=new es("database-standalone"),l=new $n("auth-internal",a);l.setComponent(new De("auth-internal",()=>i,"PRIVATE"));let c;return s&&(c=new $n("app-check-internal",a),c.setComponent(new De("app-check-internal",()=>s,"PRIVATE"))),{instance:new lt(oo(n,l,c,e,o),n),namespace:r}}var Ef=Object.freeze({__proto__:null,initStandalone:wf});var Cf=lt.ServerValue;function Tf(n){n.INTERNAL.registerComponent(new De("database-compat",(e,{instanceIdentifier:t})=>{let i=e.getProvider("app-compat").getImmediate(),s=e.getProvider("database").getImmediate({identifier:t});return new lt(s,i)},"PUBLIC").setServiceProps({Reference:Fe,Query:Ui,Database:lt,DataSnapshot:at,enableLogging:Rc,INTERNAL:Ef,ServerValue:Cf}).setMultipleInstances(!0)),n.registerVersion(_f,gf)}Tf(L);function Nn(n,e,t="on",i=Dn){return new Le(s=>{let r=null;return r=n[t](e,(o,a)=>{i.schedule(()=>{s.next({snapshot:o,prevKey:a})}),t==="once"&&i.schedule(()=>s.complete())},o=>{i.schedule(()=>s.error(o))}),t==="on"?{unsubscribe(){r!=null&&n.off(e,r)}}:{unsubscribe(){}}}).pipe(W(s=>{let{snapshot:r,prevKey:o}=s,a=null;return r.exists()&&(a=r.key),{type:e,payload:r,prevKey:o,key:a}}),ct())}function If(n){return typeof n=="string"}function bf(n){return typeof n.exportVal=="function"}function Wc(n){return n==null}function Uc(n){return typeof n.set=="function"}function Oc(n,e){return Uc(e)?e:n.ref(e)}function jc(n,e){if(If(n))return e.stringCase();if(Uc(n))return e.firebaseCase();if(bf(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Bc(n){return(Wc(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Vc(n,e,t){e=Bc(e);let i=e.map(s=>Nn(n,s,"on",t));return jt(...i)}function Sf(n,e,t){let i=Vc(n,e).pipe($i((s,r)=>[...s,r],[]));return Af(n,i,t)}function kf(n,e){return Nn(n,"value","on",e).pipe(W(t=>{let i;return t.payload.forEach(s=>(i=s.key,!1)),{data:t,lastKeyToLoad:i}}))}function Af(n,e,t){return kf(n,t).pipe(wo(e),W(([s,r])=>{let o=s.lastKeyToLoad,a=r.map(l=>l.key);return{actions:r,lastKeyToLoad:o,loadedKeys:a}}),vo(s=>s.loadedKeys.indexOf(s.lastKeyToLoad)===-1),W(s=>s.actions))}function Mc(n,e){return function(i,s){return jc(i,{stringCase:()=>n.child(i)[e](s),firebaseCase:()=>i[e](s),snapshotCase:()=>i.ref[e](s)})}}function Rf(n){return function(t){return t?jc(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function Pf(n,e,t){return Nn(n,"value","once",t).pipe(V(i=>{let s=[J(i)];return e.forEach(r=>s.push(Nn(n,r,"on",t))),jt(...s).pipe($i(xf,[]))}),mo())}function $c(n,e){let t=n.length;for(let i=0;i<t;i++)if(n[i].payload.key===e)return i;return-1}function Nf(n,e){if(Wc(e))return 0;{let t=$c(n,e);return t===-1?n.length:t+1}}function xf(n,e){let{payload:t,prevKey:i,key:s}=e,r=$c(n,s),o=Nf(n,i);switch(e.type){case"value":if(e.payload?.exists()){let a=null;e.payload.forEach(l=>{let c={payload:l,type:"value",prevKey:a,key:l.key};return a=l.key,n=[...n,c],!1})}return n;case"child_added":if(r>-1)(n[r-1]?.key||null)!==i&&(n=n.filter(l=>l.payload.key!==t.key),n.splice(o,0,e));else{if(i==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==t.key);case"child_changed":return n.map(a=>a.payload.key===s?e:a);case"child_moved":if(r>-1){let a=n.splice(r,1)[0];return n=n.slice(),n.splice(o,0,a),n}return n;default:return n}}function Fc(n,e,t){return e=Bc(e),Pf(n,e,t)}function Df(n,e,t){let i=e.schedulers.outsideAngular,s=ue(se).run(()=>n.ref);return{query:n,update:Mc(s,"update"),set:Mc(s,"set"),push:r=>s.push(r),remove:Rf(s),snapshotChanges(r){return Fc(n,r,i).pipe(Oe(t))},stateChanges(r){return Vc(n,r,i).pipe(Oe(t))},auditTrail(r){return Sf(n,r,i).pipe(Oe(t))},valueChanges(r,o){return Fc(n,r,i).pipe(W(l=>l.map(c=>o&&o.idField?Vi(Bi({},c.payload.val()),{[o.idField]:c.key}):c.payload.val())),Oe(t))}}}function Lc(n,e){return function(){return Nn(n,"value","on",e)}}function Of(n,e,t){return{query:n,snapshotChanges(){return Lc(n,e.schedulers.outsideAngular)().pipe(Oe(t))},update(i){return n.ref.update(i)},set(i){return n.ref.set(i)},remove(){return n.ref.remove()},valueChanges(){return Lc(n,e.schedulers.outsideAngular)().pipe(Oe(t),W(s=>s.payload.exists()?s.payload.val():null))}}}var Mf=new ie("angularfire2.realtimeDatabaseURL"),Ff=new ie("angularfire2.database.use-emulator"),co=(()=>{class n{schedulers;database;injector=ue(Bt);constructor(t,i,s,r,o,a,l,c,u,h,d,p,_,E,b){this.schedulers=a;let te=l,ne=zt(t,o,i);c&&ps(ne,o,u,d,p,_,h,E),this.database=qn(`${ne.name}.database.${s}`,"AngularFireDatabase",ne.name,()=>{let A=o.runOutsideAngular(()=>ne.database(s||void 0));return te&&A.useEmulator(...te),A},[te])}list(t,i){let s=ue(se).runOutsideAngular(()=>Oc(this.database,t)),r=s;return i&&(r=i(s)),Df(r,this,this.injector)}object(t){let i=ue(se).runOutsideAngular(()=>Oc(this.database,t));return Of(i,this,this.injector)}createPushId(){return ue(se).runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(i){return new(i||n)(C(yt),C(vt,8),C(Mf,8),C(dt),C(se),C(Kt),C(Ff,8),C(Xt,8),C(ls,8),C(cs,8),C(us,8),C(hs,8),C(ds,8),C(fs,8),C(wt,8))};static \u0275prov=Z({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),Hc=(()=>{class n{constructor(){L.registerVersion("angularfire",Ve.full,"rtdb-compat")}static \u0275fac=function(i){return new(i||n)};static \u0275mod=he({type:n});static \u0275inj=ce({providers:[co]})}return n})();var ji=(()=>{let e=class e extends xo{constructor(i){super(),this.afAuth=i}logout(){let i="logout";return X(this.afAuth.signOut()).pipe(W(()=>new xe(!0,null,this.getOption(`${i}.redirect.success`),[],this.getOption(`${i}.defaultMessages`))),G(s=>this.processFailure(s,i)))}register(i){throw new Error(`'register' is not supported by '${this.constructor.name}', use 'authenticate'.`)}requestPassword(i){throw new Error(`'requestPassword' is not supported by '${this.constructor.name}', use 'authenticate'.`)}resetPassword(i={}){throw new Error(`'resetPassword' is not supported by '${this.constructor.name}', use 'authenticate'.`)}refreshToken(i={}){throw new Error(`'refreshToken' is not supported by '${this.constructor.name}', use 'authenticate'.`)}processFailure(i,s){let r=[];return i instanceof No?r.push(i.message):r.push(this.getOption("errors.getter")(s,i,this.options)),J(new xe(!1,i,this.getOption(`${s}.redirect.failure`),r,[]))}processSuccess(i,s){return this.afAuth.idToken.pipe(W(r=>new xe(!0,i,this.getOption(`${s}.redirect.success`),[],this.getOption("messages.getter")(s,i,this.options),this.createToken(r))))}};e.\u0275fac=function(s){return new(s||e)(C(Xt))},e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var uo=class extends Qi{constructor(){super(...arguments),this.token={class:Yi},this.register={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully registered."]},this.login={redirect:{success:"/",failure:null},defaultErrors:["Login/Email combination is not correct, please try again."],defaultMessages:["You have been successfully logged in."]},this.logout={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully logged out."]},this.refreshToken={redirect:{success:null,failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Your token has been successfully refreshed."]},this.requestPassword={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Reset password instructions have been sent to your email."]},this.resetPassword={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["Your password has been successfully changed."]},this.errors={key:"message",getter:(e,t,i)=>zi(t,i.errors.key,i[e].defaultErrors)},this.messages={key:"messages",getter:(e,t,i)=>zi(t.body,i.messages.key,i[e].defaultMessages)}}},Wf=new uo;var ho=(()=>{let e=class e extends ji{constructor(){super(...arguments),this.defaultOptions=Wf}static setup(i){return[e,i]}authenticate({email:i,password:s}){let r="login";return X(this.afAuth.signInWithEmailAndPassword(i,s)).pipe(V(o=>this.processSuccess(o,r)),G(o=>this.processFailure(o,r)))}refreshToken(i){let s="refreshToken";return this.afAuth.authState.pipe(We(1),V(r=>r==null?J(new xe(!1,null,this.getOption(`${s}.redirect.failure`),["There is no logged in user so refresh of id token isn't possible"])):this.refreshIdToken(r,s)))}register({email:i,password:s}){let r="register";return X(this.afAuth.createUserWithEmailAndPassword(i,s)).pipe(V(o=>this.processSuccess(o,r)),G(o=>this.processFailure(o,r)))}requestPassword({email:i}){let s="requestPassword";return X(this.afAuth.sendPasswordResetEmail(i)).pipe(W(()=>new xe(!0,null,this.getOption(`${s}.redirect.success`),[],this.getOption(`${s}.defaultMessages`))),G(r=>this.processFailure(r,s)))}resetPassword({code:i,password:s}){let r="resetPassword";return X(this.afAuth.confirmPasswordReset(i,s)).pipe(W(()=>new xe(!0,null,this.getOption(`${r}.redirect.success`),[],this.getOption(`${r}.defaultMessages`))),G(o=>this.processFailure(o,r)))}updatePassword(i,s,r){return X(i.updatePassword(s)).pipe(W(o=>new xe(!0,null,this.getOption(`${r}.redirect.success`),[],this.getOption(`${r}.defaultMessages`),this.createToken(o))),G(o=>this.processFailure(o,r)))}refreshIdToken(i,s){return X(i.getIdToken(!0)).pipe(W(r=>new xe(!0,null,this.getOption(`${s}.redirect.success`),[],this.getOption(`${s}.defaultMessages`),this.createToken(r))),G(r=>this.processFailure(r,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Vt(e)))(r||e)}})(),e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var xn=class extends Qi{constructor(){super(...arguments),this.token={class:Yi},this.logout={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully logged out."]},this.authenticate={redirect:{success:"/",failure:null},defaultErrors:["Something went wrong, please try again."],defaultMessages:["You have been successfully authenticated."]},this.errors={key:"message",getter:(e,t,i)=>i[e].defaultErrors},this.messages={key:"message",getter:(e,t,i)=>i[e].defaultMessages},this.scopes=[],this.customParameters={}}};var fo=(()=>{let e=class e extends ji{constructor(){super(...arguments),this.defaultOptions=new xn}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new L.auth.GoogleAuthProvider;return this.getOption("scopes").forEach(a=>r.addScope(a)),r.setCustomParameters(this.getOption("customParameters")),X(this.afAuth.signInWithPopup(r)).pipe(V(a=>this.processSuccess(a,s)),G(a=>this.processFailure(a,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Vt(e)))(r||e)}})(),e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var Uf=(()=>{let e=class e extends ji{constructor(){super(...arguments),this.defaultOptions=new xn}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new L.auth.FacebookAuthProvider;return this.getOption("scopes").forEach(a=>r.addScope(a)),r.setCustomParameters(this.getOption("customParameters")),X(this.afAuth.signInWithPopup(r)).pipe(V(a=>this.processSuccess(a,s)),G(a=>this.processFailure(a,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Vt(e)))(r||e)}})(),e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var jf=(()=>{let e=class e extends ji{constructor(){super(...arguments),this.defaultOptions=new xn}static setup(i){return[e,i]}authenticate(i){let s="authenticate",r=new L.auth.TwitterAuthProvider;return r.setCustomParameters(this.getOption("customParameters")),X(this.afAuth.signInWithPopup(r)).pipe(V(o=>this.processSuccess(o,s)),G(o=>this.processFailure(o,s)))}};e.\u0275fac=(()=>{let i;return function(r){return(i||(i=Vt(e)))(r||e)}})(),e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var Gc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=he({type:e}),e.\u0275inj=ce({providers:[ho,fo,Uf,jf]});let n=e;return n})();var Wt=(()=>{let e=class e{constructor(i){this.db=i}getGreeting(){return this.db.object("/greeting/").valueChanges()}};e.\u0275fac=function(s){return new(s||e)(C(co))},e.\u0275prov=Z({token:e,factory:e.\u0275fac});let n=e;return n})();var Kc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275cmp=ft({type:e,selectors:[["nb-firebase-playground"]],standalone:!1,decls:1,vars:0,template:function(s,r){s&1&&bo(0,"router-outlet")},dependencies:[Ro],encapsulation:2});let n=e;return n})();function Hf(n,e){if(n&1&&(O(0,"div"),M(1," Current User Token: "),O(2,"pre"),M(3),N(4,"async"),N(5,"json"),q()()),n&2){let t=Te();$(3),_t(" ",x(5,3,x(4,1,t.userToken$))," ")}}function Gf(n,e){if(n&1&&(O(0,"div"),M(1," Data from backend "),O(2,"pre"),M(3),N(4,"async"),N(5,"json"),q()()),n&2){let t=Te();$(3),Mn(x(5,3,x(4,1,t.data$)))}}function qf(n,e){if(n&1){let t=pt();O(0,"button",2),Ne("click",function(){ut(t);let s=Te();return ht(s.logout())}),M(1,` Logout
`),q()}}function Kf(n,e){if(n&1){let t=pt();O(0,"button",2),Ne("click",function(){ut(t);let s=Te();return ht(s.login())}),M(1,` Login
`),q()}}var zc=(()=>{let e=class e{constructor(i,s,r,o){this.authService=i,this.router=s,this.firebaseApi=r,this.route=o,this.userToken$=this.authService.onTokenChange(),this.isAuthenticated$=this.authService.isAuthenticated()}logout(){this.router.navigate(["../logout"],{relativeTo:this.route})}login(){this.router.navigate(["../login"],{relativeTo:this.route})}resetPassword(){this.router.navigate(["../reset-password"],{relativeTo:this.route})}getData(){this.data$=this.firebaseApi.getGreeting().pipe(We(1),G(i=>J(i)),ct())}};e.\u0275fac=function(s){return new(s||e)(Ue(Un),Ue(Po),Ue(Wt),Ue(Ao))},e.\u0275cmp=ft({type:e,selectors:[["nb-password-auth-showcase"]],standalone:!1,decls:15,vars:15,consts:[[4,"ngIf"],[3,"click",4,"ngIf"],[3,"click"]],template:function(s,r){s&1&&(O(0,"div"),M(1),N(2,"async"),q(),Ee(3,Hf,6,5,"div",0),N(4,"async"),Ee(5,Gf,6,5,"div",0),N(6,"async"),Ee(7,qf,2,0,"button",1),N(8,"async"),Ee(9,Kf,2,0,"button",1),N(10,"async"),O(11,"button",2),Ne("click",function(){return r.resetPassword()}),M(12,"Reset password"),q(),O(13,"button",2),Ne("click",function(){return r.getData()}),M(14,"Get data from Firebase"),q()),s&2&&($(),_t("Authenticated: ",x(2,5,r.isAuthenticated$)),$(2),Ce("ngIf",x(4,7,r.isAuthenticated$)),$(2),Ce("ngIf",x(6,9,r.data$)),$(2),Ce("ngIf",x(8,11,r.isAuthenticated$)),$(2),Ce("ngIf",x(10,13,r.isAuthenticated$)===!1))},dependencies:[Fn,Ln,Wn],encapsulation:2});let n=e;return n})();function zf(n,e){if(n&1&&(O(0,"div"),M(1," Current User Token: "),O(2,"pre"),M(3),N(4,"async"),N(5,"json"),q()()),n&2){let t=Te();$(3),_t(" ",x(5,3,x(4,1,t.userToken$))," ")}}function Yf(n,e){if(n&1&&(O(0,"div"),M(1," Data from backend "),O(2,"pre"),M(3),N(4,"async"),N(5,"json"),q()()),n&2){let t=Te();$(3),Mn(x(5,3,x(4,1,t.data$)))}}function Qf(n,e){if(n&1){let t=pt();O(0,"button",2),Ne("click",function(){ut(t);let s=Te();return ht(s.logout())}),M(1,` Logout
`),q()}}function Xf(n,e){if(n&1){let t=pt();O(0,"button",2),Ne("click",function(){ut(t);let s=Te();return ht(s.loginWithGoogle())}),M(1,` Login with google
`),q()}}var Yc=(()=>{let e=class e{constructor(i,s){this.firebaseApi=i,this.authService=s,this.userToken$=this.authService.onTokenChange(),this.isAuthenticated$=this.authService.onAuthenticationChange()}logout(){this.authService.logout("google").pipe(We(1)).subscribe(i=>{})}loginWithGoogle(){this.authService.authenticate("google").pipe(We(1)).subscribe(i=>{})}getData(){this.data$=this.firebaseApi.getGreeting().pipe(We(1),G(i=>J(i)),ct())}};e.\u0275fac=function(s){return new(s||e)(Ue(Wt),Ue(Un))},e.\u0275cmp=ft({type:e,selectors:[["app-google-auth-showcase"]],standalone:!1,decls:13,vars:15,consts:[[4,"ngIf"],[3,"click",4,"ngIf"],[3,"click"]],template:function(s,r){s&1&&(O(0,"div"),M(1),N(2,"async"),q(),Ee(3,zf,6,5,"div",0),N(4,"async"),Ee(5,Yf,6,5,"div",0),N(6,"async"),Ee(7,Qf,2,0,"button",1),N(8,"async"),Ee(9,Xf,2,0,"button",1),N(10,"async"),O(11,"button",2),Ne("click",function(){return r.getData()}),M(12,"Get data from Firebase"),q()),s&2&&($(),_t("Authenticated: ",x(2,5,r.isAuthenticated$)),$(2),Ce("ngIf",x(4,7,r.isAuthenticated$)),$(2),Ce("ngIf",x(6,9,r.data$)),$(2),Ce("ngIf",x(8,11,r.isAuthenticated$)),$(2),Ce("ngIf",x(10,13,r.isAuthenticated$)===!1))},dependencies:[Fn,Ln,Wn],encapsulation:2});let n=e;return n})();var Jf=[{path:"",component:Kc,children:[{path:"",component:Do,children:[{path:"",redirectTo:"login",pathMatch:"full"},{path:"login",component:Oo},{path:"register",component:Mo},{path:"logout",component:Fo},{path:"request-password",component:Lo},{path:"reset-password",component:Wo}]}]},{path:"password-showcase",component:zc},{path:"social-auth-showcase",component:Yc}],Qc=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=he({type:e}),e.\u0275inj=ce({imports:[Ki.forChild(Jf),Ki]});let n=e;return n})();var vg=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=he({type:e}),e.\u0275inj=ce({providers:[Wt],imports:[So,la.initializeApp({apiKey:"AIzaSyBEvySH74-sISCTkCC6lXUd3zzYj26GjRk",authDomain:"auth-sample-f48f1.firebaseapp.com",databaseURL:"https://auth-sample-f48f1.firebaseio.com",projectId:"auth-sample-f48f1",storageBucket:"auth-sample-f48f1.appspot.com",messagingSenderId:"246754092661",appId:"1:246754092661:web:c2606b9ecdbed579673a3c"}),wa,Hc,Qc,Gc,Uo.forRoot({forms:{login:{strategy:"password",rememberMe:!0,socialLinks:[]},register:{strategy:"password",terms:!0,socialLinks:[]},logout:{strategy:"password"},requestPassword:{strategy:"password",socialLinks:[]},resetPassword:{strategy:"password",socialLinks:[]},validation:{password:{required:!0,minLength:6,maxLength:50},email:{required:!0},fullName:{required:!1,minLength:4,maxLength:50}}},strategies:[ho.setup({name:"password",login:{redirect:{success:"example/firebase/password-showcase"}},register:{redirect:{success:"example/firebase/password-showcase"}},logout:{redirect:{success:"example/firebase/login"}},requestPassword:{redirect:{success:"example/firebase/login"}},resetPassword:{redirect:{success:"example/firebase/login"}}}),fo.setup({name:"google"})]})]});let n=e;return n})();export{vg as FirebasePlaygroundModule};
